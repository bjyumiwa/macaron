<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>macaron_select.html - マカロン選択</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",sans-serif;color:#fff;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px
  }
  h1{margin:8px 0 6px;text-shadow:0 2px 10px rgba(0,0,0,.4)}
  p{opacity:.95;margin:0 0 16px}
  .grid{display:grid;grid-template-columns:repeat(4,110px);gap:16px}
  .macaron{
    width:110px;height:110px;border-radius:16px;backdrop-filter:blur(2px);
    background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;
    cursor:pointer;transition:transform .15s ease, background .15s ease; user-select:none;
    font-weight:700
  }
  .macaron:hover{transform:translateY(-4px);background:rgba(255,255,255,.22)}
  .tag{font-size:12px;opacity:.9;margin-top:6px}
  .cap{opacity:.8;font-size:12px;margin-top:12px}
</style>
</head>
<body>
  <h1>マカロンを選んでね</h1>
  <p>1回目は色決め、2回目で進化します。</p>
  <div class="grid">
    <div class="macaron" data-color="pink">PINK<div class="tag">情熱</div></div>
    <div class="macaron" data-color="blue">BLUE<div class="tag">静寂</div></div>
    <div class="macaron" data-color="green">GREEN<div class="tag">元気</div></div>
    <div class="macaron" data-color="purple">PURPLE<div class="tag">創造</div></div>
  </div>
  <div class="cap">※ 赤は使いません</div>

<script>
  function lsGet(k, d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
  function lsSet(k, v){localStorage.setItem(k, typeof v==="string"?v:JSON.stringify(v))}

  document.querySelectorAll('.macaron').forEach(m=>{
    m.addEventListener('click', ()=>{
      const color = m.dataset.color;
      if(!color) return;
      lsSet('whoai_selectedMacaron', color);

      // マカロン選択回数を記録
      const count = (lsGet('whoai_macaron_count',0)|0) + 1;
      lsSet('whoai_macaron_count', count);

      if(count === 1){
        // 1回目：taneで会話5回へ
        lsSet('whoai_stage','stage1');     // tane期
        lsSet('whoai_appearance','tane');
        if(lsGet('whoai_turn_s1')==null) lsSet('whoai_turn_s1',0);
        location.href = 'whoai_talk.html'; // 既存会話ページ（APIはそのまま）
      } else {
        // 2回目：進化イベントへ
        lsSet('whoai_stage','stage2');     // 進化期
        lsSet('whoai_appearance','evolved');
        lsSet('whoai_turn_s2', 0);
        location.href = 'evolution.html';
      }
    });
  });
</script>
</body>
</html>
