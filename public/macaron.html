<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マカロンを選ぶ</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("/macaron/public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    color:#fff; display:flex; flex-direction:column; align-items:center; gap:18px; padding:24px
  }
  h1{margin:8px 0 4px}
  .grid{display:grid;grid-template-columns:repeat(4,120px);gap:18px}
  .card{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px;text-align:center;cursor:pointer}
  .card.active{outline:3px solid #fff}
  .img{width:80px;height:80px;margin:6px auto 8px;display:block}
  .row{display:flex;gap:12px;align-items:center;margin-top:8px}
  button{border:none;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
  .primary{background:#ffd1ec;color:#111}
  .ghost{background:rgba(255,255,255,.15);color:#fff}
  .hint{opacity:.9}
</style>
</head>
<body>
  <h1>マカロンを選ぶ</h1>
  <div class="hint">色を変えても<b>会話の記録は維持</b>されます（「記憶を保つ」選択時）。</div>

  <div class="grid" id="grid">
    <div class="card" data-color="pink"><img class="img" src="/macaron/public/assets/stage1/macaron_pink.png"  alt="pink"><div>ピンク（情熱）</div></div>
    <div class="card" data-color="blue"><img class="img" src="/macaron/public/assets/stage1/macaron_blue.png"  alt="blue"><div>ブルー（静寂）</div></div>
    <div class="card" data-color="green"><img class="img" src="/macaron/public/assets/stage1/macaron_green.png" alt="green"><div>グリーン（元気）</div></div>
    <div class="card" data-color="purple"><img class="img" src="/macaron/public/assets/stage1/macaron_purple.png" alt="purple"><div>パープル（創造）</div></div>
  </div>

  <div class="row">
    <button class="ghost" id="backBtn">キャンセル</button>
    <button class="primary" id="evolveBtn" disabled>進化する</button>
  </div>

<script>
  const TALK_PAGE   = '/macaron/whoai_talk.html';
  const params      = new URLSearchParams(location.search);

  const cards = document.querySelectorAll('.card');
  let chosen = null;

  // 初期選択（前回）
  try{
    const prev = JSON.parse(localStorage.getItem('macaron_choice')||'null');
    if(prev?.macaron){
      chosen = prev.macaron;
      document.querySelector(`.card[data-color="${chosen}"]`)?.classList.add('active');
      document.getElementById('evolveBtn').disabled = false;
    }
  }catch{}

  // クリック
  cards.forEach(c=>{
    c.addEventListener('click', ()=>{
      cards.forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
      chosen = c.dataset.color;
      localStorage.setItem('macaron_choice', JSON.stringify({macaron: chosen, at: Date.now()}));
      document.getElementById('evolveBtn').disabled = false;
    });
  });

  document.getElementById('backBtn').onclick = ()=>{ location.href = TALK_PAGE; };

  // 進化を適用（色だけ変更。ログ/XPは触らない）
  document.getElementById('evolveBtn').onclick = ()=>{
    if(!chosen) return;
    let s = {};
    try{ s = JSON.parse(localStorage.getItem('whoai_state')||'{}'); }catch{}
    s.color = chosen;                      // 見た目のみ更新
    localStorage.setItem('whoai_state', JSON.stringify(s));

    // 会話へ戻る（戻った先で1往復してから儀式へ誘導）
    location.href = TALK_PAGE + '?changed=' + Date.now();
  };
</script>
</body>
</html>
