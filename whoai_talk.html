<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk - 会話（記録保持→見た目変更→以降も10回会話）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#fff;background:#000;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:1000;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);padding:8px 12px;border-radius:12px;font-weight:700;border:1px solid rgba(255,255,255,.15)}
    .container{width:min(900px,92vw);margin-top:22px}
    h1{margin:0 0 6px;font-size:26px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    .notice{opacity:.9;margin:4px 0 14px;font-size:14px}
    .top{display:flex;gap:14px;align-items:center}
    .avatar{width:88px;height:88px;border-radius:20px;background:rgba(255,255,255,.08);display:grid;place-items:center;border:1px solid rgba(255,255,255,.12);animation:floatY 3s ease-in-out infinite}
    .avatar img{width:64px;height:64px;object-fit:contain;animation:floatY 3s ease-in-out infinite}
    @keyframes floatY {0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); }}
    .stats{line-height:1.3}
    .stats b{font-size:14px}
    .stats .small{font-size:13px;opacity:.9}
    #chat{margin-top:12px;height:56vh;min-height:340px;overflow-y:auto;padding:12px;border-radius:14px;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);border:1px solid rgba(255,255,255,.12)}
    .bubble{max-width:78%;margin:10px 0;padding:12px 14px;border-radius:16px;line-height:1.6;word-break:break-word;border:1px solid rgba(255,255,255,.12)}
    .ai{background:rgba(255,255,255,.08)}
    .me{background:rgba(72,140,255,.22);margin-left:auto}
    .sys{background:rgba(255,255,255,.06);font-size:13px;text-align:center;max-width:92%}
    form{display:flex;gap:8px;margin:10px 0 22px;width:100%}
    input[type=text]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.07);color:#fff}
    button{padding:12px 18px;border-radius:12px;border:0;background:#a3e635;color:#0a0a0a;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="whoai-name-badge">FILE: whoai_talk.html ／ パス: /macaron/</div>
  <div class="container">
    <h1>WhoAI と会話する</h1>
    <div class="notice">マカロンを選択後、このページに直接遷移して会話を開始します。</div>
    <div class="top">
      <div class="avatar"><img id="avatarImg" alt="avatar"/></div>
      <div class="stats">
        <div><b>見た目:</b> <span id="appearanceLabel">-</span></div>
        <div class="small"><b>会話回数(この周回):</b> <span id="cycleCount">0</span>/10</div>
      </div>
    </div>
    <div id="chat"></div>
    <form id="talkForm">
      <input id="msg" type="text" placeholder="メッセージを入力…" autocomplete="off" />
      <button id="sendBtn" type="submit">送信</button>
    </form>
  </div>
  <script>
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const MAX_TURNS_PER_CYCLE = 10;
  const KEY_CHAT_LOG   = 'whoai_chatLog';
  const KEY_APPEARANCE = 'whoai_appearance';
  const KEY_CYCLE_CT   = 'whoai_cycleCount';
  const KEY_NEW_CYCLE  = 'whoai_newCycleFlag';
  const PATH_CANDIDATES = ['./public/assets/stage1/','./assets/stage1/','public/assets/stage1/','assets/stage1/','./public/','./'];
  const baseNames = {
    bg: 'space_background.png',
    tane:   './public/assets/stage1/tane.png',
    green:  './public/assets/stage1/tane_green.png',
    blue:   './public/assets/stage1/tane_blue.png',
    pink:   './public/assets/stage1/tane_pink.png',
    purple: './public/assets/stage1/tane_purple.png'
  };
  function chooseMacaron(color) {
    localStorage.setItem(KEY_APPEARANCE, color);
    localStorage.setItem(KEY_NEW_CYCLE, '1');
    location.href = 'whoai_talk.html';
  }
  function tryLoadImageSequential(names, cb){
    let i = 0; const img = new Image();
    img.onload = ()=> cb(names[i]);
    img.onerror = ()=> { i++; if(i<names.length){ img.src = names[i]; } else { cb(null); } };
    img.src = names[i];
  }
  function resolveFirstExisting(file){
    const candidates = PATH_CANDIDATES.map(p=> p + file);
    return new Promise(res=> tryLoadImageSequential(candidates, src=> res(src)));
  }
  async function applyBackground(){
    const bgSrc = await resolveFirstExisting(baseNames.bg);
    if(bgSrc){ document.body.style.backgroundImage = `url("${bgSrc}")`; }
  }
  const avatarMap = async (name)=> await resolveFirstExisting(baseNames[name] || baseNames.tane);
  const $ = (q)=>document.querySelector(q);
  const chatEl = $('#chat');
  const cycleEl = $('#cycleCount');
  const appearEl= $('#appearanceLabel');
  const avatarEl= $('#avatarImg');
  const form    = $('#talkForm');
  const input   = $('#msg');
  const sendBtn = $('#sendBtn');
  function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } }
  function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
  let chatLog   = loadJSON(KEY_CHAT_LOG, []);
  let appearance= localStorage.getItem(KEY_APPEARANCE) || 'tane';
  let cycleCnt  = parseInt(localStorage.getItem(KEY_CYCLE_CT) || '0',10);
  function renderIdentity(){
    appearEl.textContent = appearance;
    (async ()=>{ const src = await avatarMap(appearance); if(src){ avatarEl.src = src; }else{ avatarEl.alt = 'avatar (not found)'; } })();
    cycleEl.textContent = String(cycleCnt);
  }
  function renderChat(){
    chatEl.innerHTML = '';
    chatLog.forEach(m => {
      const div = document.createElement('div');
      div.className = 'bubble ' + (m.role==='user' ? 'me' : (m.role==='assistant' ? 'ai' : 'sys'));
      div.textContent = m.text;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  applyBackground();
  renderIdentity();
  renderChat();
  async function talkToAPI(userText){
    const history = chatLog.slice(-8);
    try{
      const r = await fetch(TALK_ENDPOINT, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          messages: [
            {role:'system', content:'You are WhoAI. Keep responses short (max 80 Japanese characters).'},
            ...history.map(m=> ({role:m.role==='assistant'?'assistant':(m.role==='user'?'user':'system'), content:m.text})),
            {role:'user', content:userText}
          ]
        })
      });
      if(!r.ok) throw new Error('status '+r.status);
      const data = await r.json();
      const reply = (data.reply || data.message || data.content || '').toString().trim();
      if(reply) return reply;
      throw new Error('empty');
    }catch(e){ return 'なるほど。もう少し詳しく教えて！'; }
  }
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    chatLog.push({role:'user', text}); saveJSON(KEY_CHAT_LOG, chatLog); renderChat(); input.value='';
    sendBtn.disabled = true; const reply = await talkToAPI(text); sendBtn.disabled = false;
    chatLog.push({role:'assistant', text: reply}); saveJSON(KEY_CHAT_LOG, chatLog); renderChat();
    cycleCnt += 1; localStorage.setItem(KEY_CYCLE_CT, String(cycleCnt)); cycleEl.textContent = String(cycleCnt);
  });
  </script>
</body>
</html>

<!-- ============================================================= -->
<!-- =============== rebirth.html（復活の儀式） =================== -->
<!-- 2つのパターン：
     1) 記録を保つ（容姿を変える）：ログ保持 / カウンタは次周0 / 見た目更新
     2) 容姿を保つ（記録をリセット）：見た目維持 / ログ消去 / カウンタ0
   選択後は S ステージ（s.html）へ進む。
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>rebirth - 復活の儀式</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff;background:#000;display:flex;align-items:center;justify-content:center}
    .panel{width:min(940px,92vw);background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);border-radius:18px;padding:24px}
    h1{margin:0 0 8px}
    .cols{display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:12px}
    .card{padding:16px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .row{display:flex;gap:10px;margin-top:16px}
    button{padding:12px 16px;border-radius:12px;border:0;background:#a3e635;color:#0a0a0a;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="panel">
    <h1>復活の儀式</h1>
    <p>どちらかを選んでください（選択後は <b>S ステージ</b> へ進みます）。</p>
    <div class="cols">
      <div class="card">
        <h3>容姿を保つ（記録をリセット）</h3>
        <p>いまの見た目を維持し、会話ログを消去して 0 から再開。</p>
        <div class="row">
          <button onclick="keepAppearanceResetRecords()">容姿を保つ（リセット）</button>
        </div>
      </div>
      <div class="card">
        <h3>記録を保つ（容姿を変える）</h3>
        <p>会話ログを保持し、見た目だけ次の色へ進化。</p>
        <div class="row">
          <button onclick="keepRecordsChangeAppearance('pink')">進化：pink</button>
          <button onclick="keepRecordsChangeAppearance('blue')">blue</button>
          <button onclick="keepRecordsChangeAppearance('green')">green</button>
          <button onclick="keepRecordsChangeAppearance('purple')">purple</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // URL 設定
    const S_STAGE_URL = 's.html';

    // キー名（whoai_talk.html と整合）
    const KEY_CHAT_LOG   = 'whoai_chatLog';
    const KEY_APPEARANCE = 'whoai_appearance';
    const KEY_CYCLE_CT   = 'whoai_cycleCount';
    const KEY_NEW_CYCLE  = 'whoai_newCycleFlag';

    // 1) 容姿キープ・記録リセット
    function keepAppearanceResetRecords(){
      // 見た目は触らない
      localStorage.removeItem(KEY_CHAT_LOG);      // ログ削除
      localStorage.removeItem(KEY_CYCLE_CT);      // カウント削除
      localStorage.setItem(KEY_NEW_CYCLE,'1');    // 次周 0 で開始
      // 次ステージへ
      location.href = S_STAGE_URL;
    }

    // 2) 記録キープ・容姿変更
    function keepRecordsChangeAppearance(color){
      localStorage.setItem(KEY_APPEARANCE, color); // 見た目だけ更新
      localStorage.setItem(KEY_NEW_CYCLE,'1');     // 次周 0 で開始
      // 次ステージへ
      location.href = S_STAGE_URL;
    }
  </script>
</body>
</html>

<!-- ============================================================= -->
<!-- ===================== s.html（S ステージ） ==================== -->
<!-- 演出用の中継ページ。短い演出の後、自動で whoai_talk.html へ遷移します。
     もちろん、このページにマカロン演出やSE等を追加してOK。                                         -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>s - 次の周回へ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff;background:#000;display:grid;place-items:center}
    .box{padding:22px 26px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);text-align:center}
    .dot{animation:blink 1.2s infinite}
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
    button{margin-top:14px;padding:10px 16px;border-radius:12px;border:0;background:#a3e635;color:#0a0a0a;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="box">
    <div>次の周回を準備中<span class="dot">…</span></div>
    <button onclick="goTalk()">すぐ会話へ</button>
  </div>
  <script>
    const TALK_URL = 'whoai_talk.html';
    // whoai_newCycleFlag が立っていれば、whoai_talk 側で周回カウンタは 0 にリセットされます。
    function goTalk(){ location.href = TALK_URL; }
    setTimeout(goTalk, 1200); // 1.2秒後に自動遷移（必要に応じて変更）
  </script>
</body>
</html>

