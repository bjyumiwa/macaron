<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk.html - 会話（緑：元気）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bubble-user:#4aa3ff;
      --bubble-ai:#ffffff;
      --glass:rgba(255,255,255,0.14);
    }
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      color:#fff;
      display:flex;flex-direction:column;align-items:center;gap:12px;
      padding:20px;
    }
    /* もし上の背景が見つからない時のフォールバック */
    body.bg-fallback{background-image:url("assets/stage1/space_background.png");}

    h1{
      margin:4px 0 8px;font-size:28px;letter-spacing:.03em;text-shadow:0 2px 8px rgba(0,0,0,.5)
    }
    .subtitle{opacity:.9;margin-bottom:4px}
    .stage-badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 12px;border-radius:999px;background:rgba(0,0,0,.3);
      box-shadow:0 8px 24px rgba(0,0,0,.25);backdrop-filter:blur(8px)
    }
    #characterImg{
      width:140px;height:140px;object-fit:contain;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,.6));
    }
    .chat{
      width:min(720px,92vw);
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:16px;display:flex;flex-direction:column;gap:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter:blur(10px)
    }
    .log{
      height:52vh;overflow-y:auto;padding-right:8px;
      display:flex;flex-direction:column;gap:10px;
    }
    .bubble{
      max-width:86%;
      padding:12px 14px;border-radius:14px;
      background:var(--glass);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08), 0 4px 14px rgba(0,0,0,.2);
      line-height:1.6
    }
    .me{align-self:flex-end;background:rgba(74,163,255,.18)}
    .ai{align-self:flex-start;background:rgba(255,255,255,.16)}
    .inputRow{display:flex;gap:10px}
    input[type="text"]{
      flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:rgba(0,0,0,.25);color:#fff;outline:none
    }
    button{
      padding:12px 16px;border:none;border-radius:12px;cursor:pointer;
      background:#b3f26b;color:#0a1b0a;font-weight:600;box-shadow:0 6px 16px rgba(0,0,0,.25)
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .corner-tag{
      position:fixed;right:10px;bottom:10px;font-size:12px;opacity:.9;
      background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);
      padding:6px 10px;border-radius:10px;backdrop-filter:blur(6px)
    }
    .row{display:flex;align-items:center;gap:10px}
    .small{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <h1>会話（緑：元気）</h1>
  <div class="subtitle">ピークる & 最終進化キャラの表示・復元つき</div>

  <div class="stage-badge">
    <img id="characterImg" src="" alt="キャラクター">
    <div class="small" id="charMeta">—</div>
  </div>

  <div class="chat">
    <div id="log" class="log" aria-live="polite"></div>

    <div class="row small">
      <span>容姿/記憶 選択:</span>
      <select id="chooseMode">
        <option value="appearance">appearance（容姿）</option>
        <option value="memory">memory（記憶）</option>
      </select>
      <button id="saveChoiceBtn">保存</button>
      <span
