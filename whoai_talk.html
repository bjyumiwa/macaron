<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk.html - ä¼šè©±ï¼ˆtaneè‰²åŒæœŸï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
    }

    /* å³ä¸Šã®åå‰ãƒãƒƒã‚¸ */
    .whoai-name-badge{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700;color:#fff
    }
    #whoaiBadgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}

    /* ä¸­å¤®ã‚­ãƒ£ãƒ©ï¼ˆã‚†ã‚‰ã‚†ã‚‰ï¼‰ */
    .whoai-sprite{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:180px;height:180px;display:flex;align-items:center;justify-content:center;
      z-index:30; pointer-events:none; animation:float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .whoai-sprite img{max-width:100%;max-height:100%}
    @keyframes float{0%{transform:translate(-50%,-50%)}
                     50%{transform:translate(-50%,-54%)}
                     100%{transform:translate(-50%,-50%)}}
    .whoai-safe-pad{padding-top:72px}
  </style>
</head>
<body class="whoai-safe-pad">

  <!-- â–¼ ã“ã“ã«â€œæ—¢å­˜ã®ä¼šè©±UIï¼ˆfetch/TALK_ENDPOINTå«ã‚€ï¼‰â€ã‚’ãã®ã¾ã¾æ®‹ã—ã¦ãã ã•ã„ â–¼ -->
  <!-- â€» TALK_ENDPOINT ãŒçµ¶å¯¾URLï¼ˆä¾‹ï¼šhttps://macaron-one.vercel.app/api/talkï¼‰ã§ã‚ã‚‹ã“ã¨ã ã‘ç¢ºèª -->

  <!-- ä¸­å¤®ã‚­ãƒ£ãƒ© -->
  <div id="whoaiSprite" class="whoai-sprite" aria-hidden="true">
    <img id="whoaiSpriteImg" alt="character">
  </div>

  <!-- å³ä¸Šã®ãƒãƒƒã‚¸ -->
  <div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
    <img id="whoaiBadgeFace" alt="">
    <span id="whoaiBadgeText"></span>
  </div>

  <script>
  (function(){
    // ---- ä¾¿åˆ©é–¢æ•° ----
    function lsGet(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
    function setImageWithFallback(imgEl, paths){
      let i=0; const trySet=()=>{
        if(i>=paths.length) return;
        imgEl.onerror=()=>{i++; trySet();};
        imgEl.src=paths[i];
      }; trySet();
    }

    // ---- é¸æŠè‰²ã‚’å–å¾—ï¼ˆpink/blue/green/purpleï¼‰----
    const pickedRaw = lsGet('selectedMacaron') || lsGet('whoai_selectedMacaron') || 'green';
    const color = ['pink','blue','green','purple'].includes(pickedRaw) ? pickedRaw : 'green';

    // ---- å³ä¸Šãƒãƒƒã‚¸ï¼ˆtaneé¡” or é€²åŒ–é¡”ï¼‰ ----
    const badge = document.getElementById('whoaiNameBadge');
    const face  = document.getElementById('whoaiBadgeFace');
    const nameEl= document.getElementById('whoaiBadgeText');
    const charName = lsGet('characterName','ãªã¾ãˆæœªè¨­å®š');
    nameEl.textContent = `ğŸª„ ${charName}`;
    badge.style.display = 'inline-block';

    // taneè‰²åˆ¥ã«æœ€å„ªå…ˆã§èª­ã¿è¾¼ã‚€ã€‚ãªã‘ã‚Œã° green ã‚’èª­ã¿ã€CSSã§è‰²ç›¸ã‚’è¿‘ã¥ã‘ã‚‹
    function taneFaceCandidates(){
      return [
        `public/assets/stage1/tane_${color}.png`,   // ä¾‹: tane_pink.pngï¼ˆã‚ã‚Œã°ä½¿ã†ï¼‰
        `public/assets/stage1/tane_green.png`       // ç„¡ã‘ã‚Œã°ç·‘ã‚’èª­ã¿ã€å¾Œã§è‰²ç›¸èª¿æ•´
      ];
    }
    setImageWithFallback(face, taneFaceCandidates());

    // ---- ç”»é¢ä¸­å¤®ã®ã‚­ãƒ£ãƒ©ï¼ˆãƒãƒƒã‚¸ã¨åŒã˜ç”»åƒã‚’ä½¿ã†ï¼‰----
    const spriteImg = document.getElementById('whoaiSpriteImg');
    setImageWithFallback(spriteImg, taneFaceCandidates());

    // è‰²ç›¸ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆtane_* ãŒç„¡ã„è‰²ã‚’â€œãã‚Œã£ã½ãâ€è¦‹ã›ã‚‹ï¼‰
    const hueByColor = { green:0, pink:300, blue:200, purple:260 };
    const hue = hueByColor[color] ?? 0;
    if(color!=='green'){ // ç·‘ä»¥å¤–ã¯ hue-rotate
      spriteImg.style.filter = `hue-rotate(${hue}deg) drop-shadow(0 10px 22px rgba(0,0,0,.35))`;
      face.style.filter       = `hue-rotate(${hue}deg)`;
    }

    // ---- ï¼ˆä»»æ„ï¼‰ä¼šè©±å›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã¯è§¦ã‚‰ãšã€åˆ¥é€”å…¥ã‚Œã‚‹ãªã‚‰ã“ã“ã«ãƒ•ãƒƒã‚¯ ----
    // APIã®é€ä¿¡å‡¦ç†ãã®ã¾ã¾ã§OKã€‚å¿…è¦ãªã‚‰æ•™ãˆã¦ã€ã“ã¡ã‚‰ã§æœ€å°ãƒ•ãƒƒã‚¯ã ã‘è¶³ã—ã¾ã™ã€‚
  })();
  </script>
</body>
</html>
