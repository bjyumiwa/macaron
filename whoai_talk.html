<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI Talk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#fff;background:#000;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    /* 固定背景 (img で描画) */
    .bg{position:fixed;inset:0;z-index:-1;overflow:hidden;background:#000}
    .bg img{width:100%;height:100%;object-fit:cover;display:block}

    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:10;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);padding:8px 12px;border-radius:12px;font-weight:700;border:1px solid rgba(255,255,255,.15)}
    .container{width:min(900px,92vw);margin-top:22px}
    h1{margin:0 0 6px;font-size:26px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    .notice{opacity:.9;margin:4px 0 14px;font-size:14px}
    .top{display:flex;gap:14px;align-items:center}
    .avatar{width:88px;height:88px;border-radius:20px;background:rgba(255,255,255,.08);display:grid;place-items:center;border:1px solid rgba(255,255,255,.12);animation:floatY 3s ease-in-out infinite}
    .avatar img{width:64px;height:64px;object-fit:contain;animation:floatY 3s ease-in-out infinite}
    @keyframes floatY {0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .stats{line-height:1.3}
    .stats b{font-size:14px}
    .stats .small{font-size:13px;opacity:.9}
    #chat{margin-top:12px;height:56vh;min-height:340px;overflow-y:auto;padding:12px;border-radius:14px;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);border:1px solid rgba(255,255,255,.12)}
    .bubble{max-width:78%;margin:10px 0;padding:12px 14px;border-radius:16px;line-height:1.6;word-break:break-word;border:1px solid rgba(255,255,255,.12)}
    .ai{background:rgba(255,255,255,.08)}
    .me{background:rgba(72,140,255,.22);margin-left:auto}
    .sys{background:rgba(255,255,255,.06);font-size:13px;text-align:center;max-width:92%}
    form{display:flex;gap:8px;margin:10px 0 22px;width:100%}
    input[type=text]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.07);color:#fff}
    button{padding:12px 18px;border-radius:12px;border:0;background:#a3e635;color:#0a0a0a;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="bg"><img id="bgImg" alt=""/></div>
  <div class="whoai-name-badge">FILE: whoai_talk.html /macaron</div>
  <div class="container">
    <h1>WhoAI と会話する</h1>
    <div class="notice">マカロンを選択後、このページに直接遷移して会話を開始します。</div>
    <div class="top">
      <div class="avatar"><img id="avatarImg" alt="avatar (not found)"/></div>
      <div class="stats">
        <div><b>見た目:</b> <span id="appearanceLabel">-</span></div>
        <div class="small"><b>会話回数(この周回):</b> <span id="cycleCount">0</span>/10</div>
      </div>
    </div>
    <div id="chat"></div>
    <form id="talkForm">
      <input id="msg" type="text" placeholder="メッセージを入力..." autocomplete="off" />
      <button id="sendBtn" type="submit">送信</button>
    </form>
  </div>

  <script>
  'use strict';
  /* ===== 設定 ===== */
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const MAX_TURNS = 10;
  const REBIRTH_URL = './rebirth.html';

  /* ===== ストレージキー ===== */
  const K = {
    log: 'whoai_chatLog',
    appear: 'whoai_appearance',
    turns: 'whoai_cycleCount',
    flag: 'whoai_newCycleFlag'
  };

  /* ===== 画像パス候補 ===== */
  const BASES = [
    '/macaron/public/assets/stage1/',
    '/macaron/assets/stage1/',
    '../public/assets/stage1/',
    '../assets/stage1/',
    './public/assets/stage1/',
    'public/assets/stage1/',
    './assets/stage1/',
    'assets/stage1/'
  ];
  const BG_FILE = 'space_background.png';
  const SPRITE = {
    pink:  'tane_pink.png',
    blue:  'tane_blue.png',
    green: 'tane_green.png',
    purple:'tane_purple.png',
    tane:  'tane_pink.png'
  };

  function pickAppearance(){
    let raw = localStorage.getItem(K.appear);
    if(!raw){ localStorage.setItem(K.appear,'pink'); raw = 'pink'; }
    return String(raw).replace(/^\"|\"$/g,'');
  }

  function tryLoad(urls){
    return new Promise(res=>{
      let i=0; const img=new Image();
      img.onload=()=>res(urls[i]);
      img.onerror=()=>{ i++; (i<urls.length)? img.src=urls[i] : res(null); };
      img.src=urls[i];
    });
  }

  async function resolve(file){
    const urls = BASES.map(b=> b + file);
    return new Promise(res=>{
      let i=0; const img=new Image();
      img.onload=()=> res(urls[i]);
      img.onerror=()=>{ i++; (i<urls.length)? img.src=urls[i] : res(null); };
      img.src=urls[i];
    });
  }

  async function setBackground(){
    const ok = await resolve(BG_FILE);
    const bgWrap = document.querySelector('.bg');
    const imgEl = document.getElementById('bgImg');
    if(ok && imgEl){
      imgEl.src = ok;
      imgEl.style.display = 'block';
      if(bgWrap) bgWrap.style.background = '#000';
    }else{
      // Canvasプレビュー等でアセットに届かない場合のフォールバック背景
      if(imgEl) imgEl.style.display = 'none';
      if(bgWrap){
        bgWrap.style.background =
          'radial-gradient(1000px 600px at 20% 10%, rgba(255,255,255,0.15), rgba(0,0,0,0) 60%),' +
          'radial-gradient(1200px 800px at 80% 40%, rgba(110,100,255,0.18), rgba(0,0,0,0) 60%),' +
          'linear-gradient(180deg, #0b0f1a 0%, #090909 100%)';
      }
      console.warn('[WhoAI bg missing] tried:', BASES.map(b=> b + BG_FILE));
    }
  }

  async function setAvatar(name){
    const file = SPRITE[name] || SPRITE.tane;
    const ok = await resolve(file);
    const el = document.getElementById('avatarImg');
    if(el && ok){
      el.src = ok;
    }else if(el){
      // フォールバック：SVGデータURI（プレビューでも必ず表示）
      const svg = encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>
`+
        `<defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>`+
        `<stop offset='0%' stop-color='#ffd1ec'/><stop offset='100%' stop-color='#8aa3ff'/></linearGradient></defs>`+
        `<rect rx='24' ry='24' width='128' height='128' fill='url(#g)'/>`+
        `<text x='50%' y='58%' text-anchor='middle' dominant-baseline='middle'`+
        ` font-family='Noto Sans JP, sans-serif' font-size='42' fill='#111'>${name[0].toUpperCase()}</text>`+
        `</svg>`
      );
      el.src = `data:image/svg+xml;charset=utf-8,${svg}`;
      console.warn('[WhoAI avatar missing] tried:', BASES.map(b=> b + file));
    }
  }
  }

  // === DOM ===
  const $ = s => document.querySelector(s);
  const chatEl = $('#chat');
  const cycleEl = $('#cycleCount');
  const appearEl= $('#appearanceLabel');
  const form    = $('#talkForm');
  const input   = $('#msg');
  const sendBtn = $('#sendBtn');

  // === ストレージ util ===
  const getJSON = (k,d)=>{ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): d }catch{ return d } };
  const setJSON = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  // 新しい周回なら回数だけ0
  if(localStorage.getItem(K.flag)){
    localStorage.removeItem(K.flag);
    localStorage.setItem(K.turns,'0');
  }

  let chatLog = getJSON(K.log, []);
  let appearance = pickAppearance();
  let turns = parseInt(localStorage.getItem(K.turns)||'0',10);

  function renderIdentity(){
    appearEl.textContent = appearance;
    cycleEl.textContent = String(turns);
  }

  function renderChat(){
    chatEl.innerHTML='';
    for(const m of chatLog){
      const d=document.createElement('div');
      d.className='bubble ' + (m.role==='user'?'me':m.role==='assistant'?'ai':'sys');
      d.textContent=m.text; chatEl.appendChild(d);
    }
    chatEl.scrollTop=chatEl.scrollHeight;
  }

  async function init(){
    await setBackground();
    await setAvatar(appearance);
    renderIdentity();
    renderChat();
  }

  init();

  // === 会話処理 ===
  async function talkAPI(text){
    const hist = chatLog.slice(-8);
    try{
      const r = await fetch('https://macaron-one.vercel.app/api/talk',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          messages:[
            {role:'system', content:'You are WhoAI. Keep responses short (max 80 Japanese characters).'},
            ...hist.map(m=>({role:m.role==='assistant'?'assistant':m.role==='user'?'user':'system', content:m.text})),
            {role:'user', content:text}
          ]
        })
      });
      if(!r.ok) throw new Error('status '+r.status);
      const j = await r.json();
      const reply = (j.reply||j.message||j.content||'').toString().trim();
      return reply || 'なるほど。もう少し詳しく教えて!';
    }catch(_){ return 'なるほど。もう少し詳しく教えて!'; }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = input.value.trim(); if(!text) return;
    chatLog.push({role:'user', text}); setJSON(K.log, chatLog); renderChat(); input.value='';
    sendBtn.disabled=true; const reply = await talkAPI(text); sendBtn.disabled=false;
    chatLog.push({role:'assistant', text: reply}); setJSON(K.log, chatLog); renderChat();
    turns += 1; localStorage.setItem(K.turns, String(turns)); cycleEl.textContent=String(turns);
    if(turns >= MAX_TURNS){ localStorage.setItem(K.flag,'1'); location.href = REBIRTH_URL; }
  });
  </script>
</body>
</html>
