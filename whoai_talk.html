<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI と会話する</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#fff;
      background:
        radial-gradient(1200px 900px at 85% 25%,rgba(255,255,255,.08),rgba(0,0,0,0) 60%),
        radial-gradient(1200px 900px at 15% 70%,rgba(125,116,255,.15),rgba(0,0,0,0) 60%),
        linear-gradient(180deg,#0a0f1a 0%,#0a0a0a 100%);
      background-attachment:fixed; background-size:cover; background-position:center;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    }
    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:20;background:rgba(0,0,0,.45);-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px);padding:8px 12px;border-radius:12px;font-weight:700;border:1px solid rgba(255,255,255,.15)}
    .container{width:min(980px,94vw);margin:28px auto}
    h1{margin:0 0 6px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    .top{display:flex;gap:16px;align-items:center;margin-bottom:6px}
    .avatar{width:90px;height:90px;border-radius:24px;background:rgba(255,255,255,.08);display:grid;place-items:center;border:1px solid rgba(255,255,255,.16)}
    .avatar img{width:70px;height:70px;object-fit:contain;animation:floatY 3s ease-in-out infinite}
    @keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .panel{padding:16px;border-radius:18px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)}
    #chat{height:56vh;min-height:360px;overflow:auto}
    .bubble{max-width:86%;margin:10px 0;padding:12px 14px;border-radius:16px;line-height:1.6;word-break:break-word;border:1px solid rgba(255,255,255,.12)}
    .ai{background:rgba(255,255,255,.08)}
    .me{background:rgba(55,115,255,.28);margin-left:auto}
    .sys{background:rgba(255,255,255,.06);text-align:center}
    form{display:flex;gap:10px;margin-top:10px}
    input[type=text]{flex:1;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.07);color:#fff}
    button{padding:12px 20px;border-radius:14px;border:0;background:#b4f54a;color:#111;font-weight:800;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .notice{opacity:.95;margin:8px 0 12px}
  </style>
</head>
<body>
  <div class="whoai-name-badge">FILE: whoai_talk.html ／ パス: /macaron/</div>
  <div class="container">
    <h1>WhoAI と会話する</h1>
    <div class="top">
      <div class="avatar"><img id="avatarImg" alt="avatar"/></div>
      <div>
        <div><b>フェーズ:</b> <span id="phaseLabel">-</span></div>
        <div><b>見た目:</b> <span id="appearanceLabel">-</span></div>
        <div><b>会話回数(このフェーズ):</b> <span id="cycleCount">0</span>/10</div>
      </div>
    </div>

    <div class="panel">
      <div class="notice" id="notice"></div>
      <div id="chat"></div>
      <form id="talkForm">
        <input id="msg" type="text" placeholder="メッセージを入力…" autocomplete="off" />
        <button id="sendBtn" type="submit">送信</button>
      </form>
    </div>
  </div>

  <script>
  'use strict';

  /* ======= 設定 ======= */
  var TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  var MAX_TURNS = 10;
  var SELECT_URL  = './macaron.html';  // マカロン選択
  var REBIRTH_URL = './rebirth.html';  // 復活の儀式

  /* ======= localStorage キー ======= */
  var K = {
    log:'whoai_chatLog',
    appear:'whoai_appearance',
    turns:'whoai_cycleCount',
    phase:'whoai_phase',          // 'tane' or 'evolved'
    flag:'whoai_newCycleFlag',    // フェーズ切替直後のUIリセット用
    reset:'whoai_resetLog'        // 1:ログ消去 / 0:保持
  };

  /* ======= 画像 ======= */
  var BASES = [ './public/assets/stage1/', 'public/assets/stage1/', './assets/stage1/', 'assets/stage1/' ];
  var BG_NAME = 'space_background.png';
  var SPRITE_LIST = {
    green: ['tane_green.png','macaron_green.png','green_open.png','green_closed.png'],
    pink:  ['tane_pink.png','macaron_pink.png','pink_open.png','pink_closed.png'],
    blue:  ['tane_blue.png','macaron_blue.png','blue_open.png','blue_closed.png'],
    purple:['tane_purple.png','macaron_purple.png','purple_open.png','purple_closed.png'],
    tane:  ['tane_pink.png','tane_blue.png','tane_green.png','tane_purple.png']
  };
  function tryLoad(urls, cb){ var i=0, img=new Image(); img.onload=function(){cb(urls[i]);}; img.onerror=function(){ i++; if(i<urls.length){ img.src=urls[i]; } else { cb(null); } }; img.src=urls[i]; }
  function resolveOne(file, cb){ var urls=[]; for(var i=0;i<BASES.length;i++){ urls.push(BASES[i]+file); } tryLoad(urls, cb); }
  function resolveMany(files, cb){ if(!files||!files.length){ cb(null); return; } var i=0; (function next(){ resolveOne(files[i], function(ok){ if(ok){ cb(ok); } else { i++; (i<files.length)? next(): cb(null); } }); })(); }
  resolveOne(BG_NAME, function(ok){ if(ok){ document.body.style.backgroundImage = 'url("'+ok+'")'; }});

  /* ======= DOM ======= */
  function $(s){ return document.querySelector(s); }
  var chatEl = $('#chat'), cycleEl = $('#cycleCount'), appearEl= $('#appearanceLabel');
  var phaseEl= $('#phaseLabel'), avatarEl= $('#avatarImg'), noticeEl = $('#notice');
  var form    = $('#talkForm'), input   = $('#msg'), sendBtn = $('#sendBtn');

  /* ======= Storage util ======= */
  function getJSON(k,d){ try{ var v=localStorage.getItem(k); return v? JSON.parse(v): d; }catch(e){ return d; } }
  function setJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

  /* ======= 状態読み込み ======= */
  var phase = (localStorage.getItem(K.phase) || 'tane').replace(/^\"|\"$/g,''); // 'tane' or 'evolved'
  var appearance = (localStorage.getItem(K.appear)||'green').replace(/^\"|\"$/g,'');
  var turns = parseInt(localStorage.getItem(K.turns)||'0',10);
  var chatLog = getJSON(K.log, []);

  // （安全）古い system お知らせを除去
  var BEFORE = chatLog.length;
  chatLog = chatLog.filter(function(m){ return !(m.role==='system' && m.text && m.text.indexOf('10ターン到達で')>=0); });
  if(chatLog.length!==BEFORE) setJSON(K.log, chatLog);

  // rebirth.html からのフラグでログを消す/保持
  var reset = localStorage.getItem(K.reset);
  if(reset==='1'){ chatLog=[]; setJSON(K.log, chatLog); }
  if(reset==='0'){ /* 何もしない（保持） */ }
  localStorage.removeItem(K.reset);

  // 新フェーズ開始フラグ：回数だけ0に
  if(localStorage.getItem(K.flag)){
    localStorage.removeItem(K.flag);
    turns = 0; localStorage.setItem(K.turns,'0');
  }

  // 表示
  function phaseNotice(p){
    return (p==='tane')
      ? '（タネ）10ターン到達で「マカロン選択」に移動します。選んだ色で進化します。'
      : '（進化後）10ターン到達で「復活の儀式」に移動します。';
  }
  phaseEl.textContent = (phase==='tane' ? 'タネ' : '進化後');
  appearEl.textContent = appearance;
  cycleEl.textContent = String(turns);
  noticeEl.textContent = phaseNotice(phase);
  resolveMany(SPRITE_LIST[appearance]||SPRITE_LIST.tane, function(ok){ if(ok){ avatarEl.src = ok; } });

  function renderChat(){
    chatEl.innerHTML='';
    for(var i=0;i<chatLog.length;i++){
      var m = chatLog[i];
      var d = document.createElement('div');
      d.className = 'bubble ' + (m.role==='user'?'me':(m.role==='assistant'?'ai':'sys'));
      d.textContent = m.text;
      chatEl.appendChild(d);
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  renderChat();

  /* ======= API ======= */
  async function talkAPI(text){
    var hist = chatLog.slice(-8);
    try{
      var r = await fetch(TALK_ENDPOINT,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          messages:[
            {role:'system', content:'You are WhoAI. Keep responses short (max 80 Japanese characters).'},
            ...hist.map(function(m){ return {role:(m.role==='assistant'?'assistant':(m.role==='user'?'user':'system')), content:m.text}; }),
            {role:'user', content:text}
          ]
        })
      });
      if(!r.ok) throw new Error('status '+r.status);
      var j = await r.json(); var reply = (j.reply||j.message||j.content||'').toString().trim();
      return reply || 'なるほど。もう少し詳しく教えて！';
    }catch(e){ return 'なるほど。もう少し詳しく教えて！'; }
  }

  // 404ガード付き遷移
  async function safeNavigate(url){
    try{
      const r = await fetch(url,{method:'HEAD',cache:'no-store'});
      if(r.ok){ location.href=url; } else { alert('遷移先が見つかりません: '+url); }
    }catch(e){ alert('遷移先にアクセスできません: '+url); }
  }

  /* ======= 送信処理 ======= */
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    var text = input.value.trim(); if(!text) return;

    chatLog.push({role:'user', text:text}); setJSON(K.log, chatLog); renderChat(); input.value='';
    sendBtn.disabled=true; var reply = await talkAPI(text); sendBtn.disabled=false;
    chatLog.push({role:'assistant', text:reply}); setJSON(K.log, chatLog); renderChat();

    turns += 1;
    localStorage.setItem(K.turns,String(turns));
    cycleEl.textContent = String(Math.min(turns,MAX_TURNS));

    if(turns >= MAX_TURNS){
      if(phase === 'tane'){
        // 進化へ
        localStorage.setItem(K.phase, JSON.stringify('evolved'));
        localStorage.setItem(K.turns, '0');
        localStorage.setItem(K.flag, '1');
        localStorage.setItem(K.reset,'0'); // 進化直後はログ保持（好みで1に可）
        safeNavigate(SELECT_URL);
      }else{
        // 復活の儀式へ
        localStorage.setItem(K.flag, '1');
        safeNavigate(REBIRTH_URL);
      }
    }
  });
  </script>
</body>
</html>
