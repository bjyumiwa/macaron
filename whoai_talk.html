<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WhoAI 会話ページ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html,body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: "Noto Sans JP", sans-serif;
    background-image: url("public/assets/stage1/space_background.png");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h2 {
    margin-top: 10px;
    text-shadow: 0 0 8px rgba(0,0,0,0.5);
  }
  #characterImg {
    width: 160px;
    margin-top: 20px;
  }
  #charCaption {
    font-size: 0.9em;
    margin-top: 6px;
  }
  #charNameLabel {
    margin-top: 4px;
    font-weight: 600;
  }
  #chatArea {
    background: rgba(255,255,255,0.1);
    padding: 12px;
    margin-top: 16px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    height: 300px;
    overflow-y: auto;
  }
  .bubble {
    padding: 8px;
    margin-bottom: 6px;
    border-radius: 8px;
    max-width: 90%;
    word-wrap: break-word;
  }
  .bubble.user {
    background: rgba(0,128,255,0.4);
    align-self: flex-end;
  }
  .bubble.bot {
    background: rgba(255,255,255,0.2);
    align-self: flex-start;
  }
  .bubble.sys {
    background: rgba(255,255,0,0.2);
    align-self: center;
    font-style: italic;
  }
  #inputArea {
    display: flex;
    margin-top: 10px;
    width: 90%;
    max-width: 500px;
  }
  #userInput {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: none;
    font-size: 1em;
  }
  #sendBtn {
    padding: 8px 14px;
    margin-left: 6px;
    background: #ff9edf;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #menuArea {
    margin-top: 12px;
  }
  button.menu {
    padding: 6px 12px;
    margin: 4px;
    border: none;
    border-radius: 6px;
    background: #ffd1ec;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>WhoAI 会話ページ</h2>

<img id="characterImg" src="" alt="キャラクター">
<div id="charCaption">タネ（未選択）</div>
<div id="charNameLabel">名前：？？？</div>

<div id="chatArea"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="メッセージを入力">
  <button id="sendBtn">送信</button>
</div>

<div id="menuArea">
  <button class="menu" id="continueBtn">コンティニュー</button>
  <button class="menu" id="restartBtn">最初から</button>
</div>

<script>
  // ==== キャラ色と画像の対応 ====
  const COLOR_META = {
    pink: { label: '情熱', img: 'public/assets/characters/pink.png' },
    blue: { label: '静寂', img: 'public/assets/characters/blue.png' },
    green: { label: '元気', img: 'public/assets/characters/green.png' },
    purple: { label: '創造', img: 'public/assets/characters/purple.png' }
  };
  const SEED_IMG = 'public/assets/stage1/tane.png';

  // ==== DOM取得 ====
  const characterImg = document.getElementById('characterImg');
  const charCaption = document.getElementById('charCaption');
  const charNameLabel = document.getElementById('charNameLabel');
  const chatArea = document.getElementById('chatArea');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  // ==== 状態管理 ====
  function loadState(){
    const s = localStorage.getItem('whoai_state');
    return s ? JSON.parse(s) : {};
  }
  function saveState(s){
    localStorage.setItem('whoai_state', JSON.stringify(s));
  }
  function currentName(){
    const s = loadState();
    return s.name || 'ともだち';
  }

  // ==== キャラ表示 ====
  function applyAppearance(state){
    const color = state.appearanceColor;
    if(!color || !COLOR_META[color]){
      characterImg.src = SEED_IMG;
      charCaption.textContent = 'タネ（未選択）';
    } else {
      characterImg.src = COLOR_META[color].img;
      charCaption.textContent = `ピークる（${COLOR_META[color].label}）`;
    }
    charNameLabel.textContent = `名前：${currentName()}`;
  }

  // ==== バブル追加 ====
  function addBubble(role, text){
    const div = document.createElement('div');
    div.className = `bubble ${role==='user'?'user':role==='bot'?'bot':'sys'}`;
    const nm = currentName();
    const prefix = role==='user' ? 'あなた：' : role==='bot' ? `${nm}：` : '';
    div.textContent = prefix + text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  // ==== 会話送信 ====
  function sendMessage(){
    const msg = userInput.value.trim();
    if(!msg) return;
    addBubble('user', msg);
    userInput.value = '';
    // 仮のAI応答
    setTimeout(()=>{
      addBubble('bot', 'なるほど、そうなんだね！');
    }, 400);
  }

  // ==== コンティニュー ====
  document.getElementById('continueBtn').addEventListener('click', ()=>{
    const st = loadState();
    applyAppearance(st);
    addBubble('sys', '前回のキャラクターで会話を再開します。');
  });

  // ==== 最初から ====
  document.getElementById('restartBtn').addEventListener('click', ()=>{
    localStorage.removeItem('whoai_state');
    addBubble('sys', '状態をリセットしました。最初から開始します。');
    applyAppearance({});
  });

  // ==== 初期化 ====
  function init(){
    const st = loadState();
    if(Object.keys(st).length === 0){
      // 初回はタネ状態
      applyAppearance({});
    } else {
      applyAppearance(st);
      addBubble('sys', '前回のキャラクターをロードしました。');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', e=>{
    if(e.key === 'Enter') sendMessage();
  });

  init();
</script>

</body>
</html>
