<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI 会話ページ</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("assets/stage1/space_background.png") center/cover fixed no-repeat;
    color:#fff; display:flex; flex-direction:column; gap:12px; padding:18px
  }
  .panel{background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.18);border-radius:16px}
  .top{display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:999px}
  .dot{width:14px;height:14px;border-radius:50%}
  .dot.pink{background:#ff8fb1}.dot.blue{background:#88a7ff}.dot.green{background:#85f3b0}.dot.purple{background:#c59bff}

  #goalText{padding:8px 12px}
  #bar{height:12px;border-radius:8px;overflow:hidden;position:relative}
  #fill{height:100%;width:0;background:linear-gradient(90deg,#ffd1ec,#ffc5d9,#ffd1ec)}

  #log{flex:1;overflow:auto;padding:14px}
  .msg{margin:10px 0;max-width:80%}
  .me{margin-left:auto}
  .b{background:rgba(255,255,255,.1);padding:10px 12px;border-radius:14px}
  .typing{opacity:.75;font-style:italic}
  .input{display:flex;gap:8px;padding:10px}
  .input input{flex:1;border:none;border-radius:12px;padding:12px}
  .input button{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}

  /* avatar（右→左にゆらゆら） */
  .avatar{
    position:fixed; right:24px; bottom:96px; width:150px; pointer-events:none;
    filter:drop-shadow(0 10px 24px rgba(0,0,0,.5)); z-index:1;
    animation: yoko 8s ease-in-out infinite;
  }
  .avatar img{width:100%; height:auto; display:block}
  .avatar .fallback{
    width:120px; height:120px; border-radius:50%;
    border:4px solid rgba(255,255,255,.85); box-shadow:0 8px 20px rgba(0,0,0,.45);
  }
  @keyframes yoko{0%{transform:translateX(0)}50%{transform:translateX(-60px)}100%{transform:translateX(0)}}

  .disabled{opacity:.5;pointer-events:none}
</style>
</head>
<body>
  <div class="top">
    <div class="badge">
      <span class="dot" id="dot"></span>
      <span id="traitLabel">WHOAI</span>
    </div>
    <div class="badge"><span id="counter">0 / 0</span></div>
  </div>

  <div id="goalText" class="panel"></div>
  <div id="bar" class="panel" aria-label="progress"><div id="fill"></div></div>

  <div id="log" class="panel" aria-live="polite"></div>

  <div class="input panel">
    <input id="text" type="text" placeholder="メッセージを入力" />
    <button id="send">送信</button>
  </div>

  <!-- avatar -->
  <div class="avatar" aria-hidden="true">
    <img id="avatar" alt="">
  </div>

<script>
  /* ====== API（そのまま） ====== */
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';

  /* ====== ルートパスを計算（/repo/ までを抽出） ====== */
  function repoRoot(){
    // /repo/whoai_talk.html → /repo/
    // /repo/assets/macaron.html → /repo/
    const p = location.pathname;
    if (p.includes('/assets/')) return p.replace(/\/assets\/.*/,'/') ;
    return p.replace(/[^/]+$/,'');
  }
  const ROOT = repoRoot();

  /* ====== 背景フォールバック ====== */
  (()=>{
    const img = new Image();
    img.src = `${ROOT}assets/stage1/space_background.png`;
    img.onerror = ()=>{ document.body.style.backgroundImage = `url("${ROOT}public/assets/stage1/space_background.png")`; };
    // 既定CSSの相対は残してOK
  })();

  /* ====== 状態 ====== */
  function read(obj, k, def){ return (obj && obj[k]!=null)?obj[k]:def; }
  const stored = JSON.parse(localStorage.getItem('whoai_state') || "{}");
  const macaron = JSON.parse(localStorage.getItem('macaron_choice') || "null");
  const color = stored.color || (macaron?macaron.macaron:null) || localStorage.getItem('selectedMacaron') || 'pink';
  const state = {
    name: read(stored,'name','WHOAI'),
    color,
    variant: read(stored,'variant','tane'),
    stage: read(stored,'stage','seed'),
    xp: read(stored,'xp',0),
    goal: read(stored,'goal', (stored.stage==='evolved'?12:8))
  };
  window.state = state;

  document.getElementById('dot').classList.add(color);
  document.getElementById('traitLabel').textContent = state.name || "WHOAI";

  /* ====== 進捗表示 ====== */
  const goalText = document.getElementById('goalText');
  const fill = document.getElementById('fill');
  const counter = document.getElementById('counter');

  function updateGoalText(){
    const colorLabel = {pink:'ピンク / Pink', blue:'ブルー / Blue', green:'グリーン / Green', purple:'パープル / Purple'}[state.color] || state.color;
    goalText.textContent = `目標 ${state.goal} XP / ${colorLabel}：` +
      ({pink:"情熱。前向きで励ます。", blue:"静寂。落ち着いて丁寧。", green:"元気。テンポよく行動。", purple:"創造。比喩や飛躍。"}[state.color] || "");
  }
  function updateBarAndCounter(){
    const p = Math.max(0, Math.min(1, state.xp / Math.max(1,state.goal)));
    fill.style.width = (p*100)+'%';
    counter.textContent = `${state.xp} / ${state.goal}`;
  }
  updateGoalText(); updateBarAndCounter();

  /* ====== アバター ====== */
  function charPath(s){
    const name = (s.variant === "tane") ? `tane_${s.color}.png` : `${s.color}_${s.variant}.png`;
    return [`${ROOT}assets/stage1/${name}`, `${ROOT}public/assets/stage1/${name}`];
  }
  (function setAvatar(){
    const img = document.getElementById('avatar');
    const [p0, p1] = charPath(state);
    img.src = p0;
    img.alt = (state.name || 'WHOAI') + ' avatar';
    img.onerror = ()=>{
      if(img.dataset.fbk!=='1'){ img.dataset.fbk='1'; img.src = p1; return; }
      const f = document.createElement('div');
      f.className = 'fallback';
      f.style.background = {pink:'#ff8fb1', blue:'#88a7ff', green:'#85f3b0', purple:'#c59bff'}[state.color] || '#fff';
      img.replaceWith(f);
    };
  })();

  /* ====== チャット ====== */
  const logEl = document.getElementById('log');
  const textEl = document.getElementById('text');
  const sendEl = document.getElementById('send');

  function addMsg(who, content, extraClass=''){
    const label = (who==='me') ? 'あなた' : 'WHOAI';
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='me'?'me':'') + ' ' + extraClass;
    div.innerHTML = `<div class="b"><strong>${label}</strong><br>${content}</div>`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
    return div;
  }
  addMsg('ai', {pink:"やっほー！まずは一歩いってみよ！",blue:"こんにちは。ゆっくり考えていこう。",green:"やっほー！まずは一歩いってみよ！",purple:"ようこそ。物語を編んでみよう。"}[state.color] || "こんにちは！");

  function loadChat(){ try{ return JSON.parse(localStorage.getItem('whoai_chat')||'[]'); }catch{ return []; } }
  function saveChat(arr){ localStorage.setItem('whoai_chat', JSON.stringify(arr.slice(-14))); }
  let chat = loadChat();

  async function talkAPI(userText){
    const systemPrompt = `あなたはWHOAIのキャラクター。名前は「${state.name||'WHOAI'}」。色は${state.color}、形態は${state.variant||'tane'}。口調は次の方針：
- ピンク: 前向きに励ます
- ブルー: 落ち着いて丁寧に考える
- グリーン: テンポよく行動を促す
- パープル: 比喩や発想の飛躍を少し入れる
必ず日本語で、1〜2文で返答。最後に次の行動を1つだけ提案して。`;
    const payload = { userMessage:userText, history:chat, systemPrompt, temperature:0.7, max_tokens:220, model:"gpt-4o-mini" };
    const r = await fetch(TALK_ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
    if(!r.ok){ throw new Error(await r.text()); }
    const data = await r.json();
    return (data.reply||"").trim();
  }

  function toneReply(){
    return ({ pink:"うん！応援してるよ。", blue:"なるほど。順番に考えてみよう。", green:"いいね！小さく一歩、どう？", purple:"ふむ。別の想像をしてみたらどう？" }[state.color]) || "いいね、まず一歩やってみよう！";
  }

  function saveState(){ localStorage.setItem('whoai_state', JSON.stringify(state)); }
  function disableInput(disabled=true){
    textEl.disabled = disabled; sendEl.disabled = disabled;
    if(disabled){ textEl.classList.add('disabled'); sendEl.classList.add('disabled'); }
    else { textEl.classList.remove('disabled'); sendEl.classList.remove('disabled'); }
  }

  // ▼ macaron.html をオート検出（同階層 /assets/ 内 どちらでもOK）
  async function goToMacaron(){
    localStorage.setItem('whoai_need_evolve','1');
    const base = location.pathname.replace(/[^/]+$/, '');
    const candidates = [
      base + 'macaron.html',
      base + 'assets/macaron.html',
      base + 'assets/stage1/macaron.html',
      base + 'macaron_select.html'
    ];
    for (const url of candidates) {
      try {
        const res = await fetch(url, { method:'HEAD', cache:'no-store' });
        if (res.ok) { location.href = url + (url.includes('?')?'':'?from=talk'); return; }
      } catch {}
    }
    alert('macaron.html が見つかりませんでした。配置場所を確認してください。');
  }

  if(state.xp >= state.goal){ disableInput(true); }

  async function handleSend(){
    if(state.xp >= state.goal){ return; }
    const v = textEl.value.trim(); if(!v) return;
    addMsg('me', v);
    textEl.value='';
    chat.push({role:"user", content:v}); saveChat(chat);

    const typing = addMsg('ai', '入力中…', 'typing');
    let reply="";
    try{ reply = await talkAPI(v); }
    catch(e){ console.warn(e); typing.querySelector('.b').innerHTML = `<strong>WHOAI</strong><br>通信に失敗しました。ローカル応答に切り替えます。`; reply = toneReply(); }

    typing.remove();
    addMsg('ai', reply);
    chat.push({role:"assistant", content:reply}); saveChat(chat);

    state.xp = (state.xp||0) + 1;
    updateBarAndCounter();
    saveState();

    if(state.xp >= state.goal){
      disableInput(true);
      setTimeout(goToMacaron, 250);
    }
  }

  document.getElementById('send').addEventListener('click', handleSend);
  document.getElementById('text').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });
</script>
</body>
</html>
