<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk.html - ä¼šè©±ï¼ˆé€²è¡Œç®¡ç†ä»˜ãï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
    }
    /* å³ä¸Šã®åå‰ï¼†é¡”ãƒãƒƒã‚¸ */
    .whoai-name-badge{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700;color:#fff
    }
    #whoaiBadgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}
    #whoaiNameEdit{margin-left:8px;opacity:.85;cursor:pointer}
    /* ï¼ˆå‚è€ƒï¼‰æœ€ä½é™ã®ãƒãƒ£ãƒƒãƒˆæ ã€‚ã‚ãªãŸã®æ—¢å­˜UIãŒã‚ã‚‹å ´åˆã¯ç„¡è¦–ã•ã‚Œã¾ã™ */
    .placeholder-chat{max-width:680px;margin:92px auto 24px;padding:16px;border-radius:14px;background:rgba(0,0,0,.35)}
    .placeholder-chat .row{display:flex;gap:8px}
    .placeholder-chat input{flex:1;padding:10px;border-radius:10px;border:none}
    .placeholder-chat button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>

  <!-- â–¼ æ—¢å­˜ã®ä¼šè©±UIï¼ˆfetch/TALK_ENDPOINTã‚’å«ã‚€éƒ¨åˆ†ï¼‰ãŒã‚ã‚‹ãªã‚‰ã“ã®ä¸‹ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚ -->
  <!-- â–¼ æ—¢å­˜UIãŒç„¡ã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆå‰Šé™¤å¯ï¼šAPIã«ã¯è§¦ã‚Œã¾ã›ã‚“ï¼‰ -->
  <div class="placeholder-chat" id="whoaiPlaceholder">
    <div style="margin-bottom:10px;opacity:.9">ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ã“ã“ã«æ—¢å­˜ã®ä¼šè©±UIãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç„¡ã‘ã‚Œã°è‡ªç”±ã«ä½¿ã£ã¦OKã€‚</div>
    <div class="row">
      <input id="userInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" />
      <button id="sendBtn">é€ä¿¡</button>
    </div>
  </div>

  <!-- å³ä¸Šã®ãƒãƒƒã‚¸ -->
  <div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
    <img id="whoaiBadgeFace" alt="">
    <span id="whoaiBadgeText"></span>
    <span id="whoaiNameEdit" title="åå‰ã‚’å¤‰æ›´">ğŸ–Š</span>
  </div>

  <!-- ===== WHOAI é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆAPIéå¹²æ¸‰ï¼‰===== -->
  <script>
  (function(){
    // --- å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function lsGet(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
    function lsSet(k,v){localStorage.setItem(k, typeof v==="string"?v:JSON.stringify(v))}
    function setImageWithFallback(imgEl, paths){
      let i=0; const trySet=()=>{
        if(i>=paths.length) return;
        imgEl.onerror=()=>{i++; trySet();};
        imgEl.src=paths[i];
      }; trySet();
    }

    // --- åå‰ï¼†é¡”ãƒãƒƒã‚¸ï¼ˆtaneã¯å›ºå®š/é€²åŒ–ã¯open-closedï¼‰---
    const picked = lsGet('whoai_selectedMacaron','green');   // pink/blue/green/purple
    const appear = lsGet('whoai_appearance','tane');         // 'tane' or 'evolved'
    let name = lsGet('characterName','ãªã¾ãˆæœªè¨­å®š');

    const badge = document.getElementById('whoaiNameBadge');
    const face  = document.getElementById('whoaiBadgeFace');
    const text  = document.getElementById('whoaiBadgeText');
    const edit  = document.getElementById('whoaiNameEdit');

    function faceCandidates(open){
      if(appear==='tane'){
        return ['public/assets/stage1/tane_green.png']; // ã‚†ã‚‰ã‚†ã‚‰æƒ³å®šï¼ˆè¡¨æƒ…å·®åˆ†ãªã—ï¼‰
      }
      const s = open ? 'open':'closed';
      return [
        `./${picked}_${s}.png`,                                      // ä¾‹: green_open.png
        `public/assets/evolved/${picked}_${open?'open':'close'}.png` // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      ];
    }

    function drawBadge(){
      text.textContent = `ğŸª„ ${name}`;
      badge.style.display = 'inline-block';
    }
    drawBadge();

    let isOpen=true;
    setImageWithFallback(face, faceCandidates(isOpen));
    setInterval(()=>{
      isOpen=!isOpen;
      setImageWithFallback(face, faceCandidates(isOpen));
    }, (appear==='tane'? 1600 : 1200));

    edit.addEventListener('click', ()=>{
      const v = prompt('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰', name);
      if(v!=null && v.trim()){
        name = v.trim(); lsSet('characterName',name); drawBadge();
      }
    });

    // --- é€²è¡Œç®¡ç†ï¼ˆAPIã®fetchç­‰ã«ã¯ä¸€åˆ‡å¹²æ¸‰ã—ãªã„ï¼‰---
    const S1_TARGET = 5;    // taneã§5ä¼šè©± â†’ macaron_select.html
    const S2_TARGET = 10;   // é€²åŒ–ã§10ä¼šè©± â†’ rebirth.html
    const POST_TARGET = 10; // é¸æŠå¾Œ10ä¼šè©± â†’ identity_check.html

    function countAndRoute(){
      const stage = lsGet('whoai_stage','stage1');
      if(stage==='stage1'){
        const n = (lsGet('whoai_turn_s1',0)|0) + 1; lsSet('whoai_turn_s1',n);
        if(n>=S1_TARGET){ setTimeout(()=>location.href='macaron_select.html',700); }
      }else if(stage==='stage2'){
        const n = (lsGet('whoai_turn_s2',0)|0) + 1; lsSet('whoai_turn_s2',n);
        if(n>=S2_TARGET){ setTimeout(()=>location.href='rebirth.html',700); }
      }else if(stage==='post'){
        const n = (lsGet('whoai_post_turn',0)|0) + 1; lsSet('whoai_post_turn',n);
        if(n>=POST_TARGET){
          const url = lsGet('whoai_survey_url') || 'identity_check.html';
          setTimeout(()=>location.href=url,600);
        }
      }
    }

    // é€ä¿¡æ“ä½œã‚’ãƒ•ãƒƒã‚¯ï¼ˆæ—¢å­˜UIã«ã‚‚åºƒã‚ã«å¯¾å¿œï¼‰
    function hookSend(){
      const btn = document.querySelector('#sendBtn, #sendButton, button[data-send], button#send, .send');
      if(btn && !btn.dataset._whoaiHooked){
        btn.dataset._whoaiHooked="1";
        btn.addEventListener('click', ()=> setTimeout(countAndRoute,120));
      }
      const input = document.querySelector('#userInput, textarea, input[type="text"]');
      if(input && !input.dataset._whoaiHooked){
        input.dataset._whoaiHooked="1";
        input.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' && !e.shiftKey){ setTimeout(countAndRoute,150); }
        });
      }
    }
    hookSend();
    setInterval(hookSend, 1000); // å‹•çš„UIã§ã‚‚æ‹¾ã†

  })();
  </script>
  <!-- ===== /WHOAI é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ ===== -->

</body>
</html>
