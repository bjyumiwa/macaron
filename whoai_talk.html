<!-- whoai_talk.html 音声入力対応 完全版 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI Talk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;
      background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    header{padding:10px;text-align:center}
    h1{margin:4px 0;font-size:20px}
    .chat-container{flex:1;width:100%;max-width:600px;overflow-y:auto;padding:12px}
    .msg{margin:8px 0;display:flex}
    .msg.user{justify-content:flex-end}
    .msg.bot{justify-content:flex-start}
    .bubble{
      padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.5;
      word-wrap:break-word;white-space:pre-wrap
    }
    .user .bubble{background:#4e9af1;color:#fff;border-bottom-right-radius:2px}
    .bot .bubble{background:#444;color:#fff;border-bottom-left-radius:2px}
    .input-box{display:flex;width:100%;max-width:600px;padding:10px;box-sizing:border-box}
    .input-box input{flex:1;padding:10px;border-radius:8px;border:none;font-size:16px}
    .input-box button{margin-left:8px;padding:10px 16px;border:none;border-radius:8px;background:#6c5ce7;color:#fff;cursor:pointer}
    .char-img{width:80px;margin:10px auto;display:block}
    select{margin-top:6px;padding:4px}
    #micBtn{margin-left:6px;padding:10px 14px;border:none;border-radius:8px;background:#ff7675;color:#fff;cursor:pointer}
    #micBtn.on{background:#d63031}
  </style>
</head>
<body>
  <header>
    <h1 id="title">会話</h1>
    <p id="subtitle">たねキャラで3回会話すると進化へ</p>
    <img id="charImg" class="char-img" src="" alt="キャラ">
    <p id="charName"></p>
    <select id="langSelect">
      <option value="ja-JP">日本語</option>
      <option value="en-US">English</option>
      <option value="zh-CN">中文</option>
      <option value="ko-KR">한국어</option>
    </select>
  </header>

  <div id="chat" class="chat-container"></div>

  <div class="input-box">
    <input id="msgInput" type="text" placeholder="メッセージを入力..." />
    <button id="sendBtn">送信</button>
    <button id="micBtn">🎤 開始</button>
  </div>

<script>
const TALK_ENDPOINT = "https://macaron-one.vercel.app/api/talk";
const CHAT_KEY = "whoai_chat";
const MAX_TANE = 3;
const MAX_EVOLVED = 10;

const charName = localStorage.getItem("char_name") || "キャラ";
const color = localStorage.getItem("macaronColor") || "blue";
const stage = localStorage.getItem("stage") || "tane";
document.getElementById("charName").textContent = charName;

const charImg = document.getElementById("charImg");
charImg.src = (stage==="tane")
  ? `public/assets/stage1/tane_${color}.png`
  : `public/assets/stage1/evolved_${color}.png`;

// 多言語 UI
const I18N = {
  title:{ "ja-JP":"会話","en-US":"Conversation","zh-CN":"对话","ko-KR":"대화"},
  subtitle_tane:{
    "ja-JP":"たねキャラで3回会話すると進化へ",
    "en-US":"Talk 3 times with Tane → Evolution",
    "zh-CN":"和种子角色对话3次 → 进化",
    "ko-KR":"씨앗 캐릭터와 3번 대화 → 진화"
  },
  subtitle_evolved:{
    "ja-JP":"進化キャラで10回会話すると復活の儀式へ",
    "en-US":"Talk 10 times with evolved form → Rebirth ritual",
    "zh-CN":"和进化角色对话10次 → 复活仪式",
    "ko-KR":"진화 캐릭터와 10번 대화 → 부활의 의식"
  }
};
const langSelect=document.getElementById("langSelect");
function applyI18n(lang){
  document.getElementById("title").textContent = I18N.title[lang]||I18N.title["ja-JP"];
  document.getElementById("subtitle").textContent = (stage==="tane")
    ? I18N.subtitle_tane[lang]
    : I18N.subtitle_evolved[lang];
  localStorage.setItem("whoai_lang", lang);
}
const savedLang=localStorage.getItem("whoai_lang")||"ja-JP";
langSelect.value=savedLang;applyI18n(savedLang);
langSelect.addEventListener("change",()=>applyI18n(langSelect.value));

// 会話履歴
let history=[];
try{history=JSON.parse(localStorage.getItem(CHAT_KEY)||"[]");}catch(e){history=[];}
const chatDiv=document.getElementById("chat");
function renderChat(){
  chatDiv.innerHTML="";
  history.forEach(m=>{
    const msg=document.createElement("div");
    msg.className="msg "+(m.role==="user"?"user":"bot");
    msg.innerHTML=`<div class="bubble">${m.content}</div>`;
    chatDiv.appendChild(msg);
  });
  chatDiv.scrollTop=chatDiv.scrollHeight;
}
renderChat();

// 送信処理
async function handleSend(){
  const input=document.getElementById("msgInput");
  const text=input.value.trim();if(!text)return;
  input.value="";

  history.push({role:"user",content:text});
  renderChat();localStorage.setItem(CHAT_KEY,JSON.stringify(history));

  try{
    const res=await fetch(TALK_ENDPOINT,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:text,color,stage,history,charName,lang:langSelect.value})
    });
    const data=await res.json();
    const reply=data.reply||"......";
    history.push({role:"bot",content:reply});
    renderChat();localStorage.setItem(CHAT_KEY,JSON.stringify(history));
    checkProgress();
  }catch(e){
    history.push({role:"bot",content:"[接続エラー]"});
    renderChat();
  }
}

// 進行管理
function checkProgress(){
  const userTurns=history.filter(m=>m.role==="user").length;
  if(stage==="tane" && userTurns>=MAX_TANE){
    localStorage.setItem("stage","evolved");
    window.location.href="macaron_select.html";
  }
  if(stage==="evolved" && userTurns>=MAX_EVOLVED){
    window.location.href="rebirth.html";
  }
}

// イベント
document.getElementById("sendBtn").addEventListener("click",handleSend);
document.getElementById("msgInput").addEventListener("keypress",e=>{
  if(e.key==="Enter"){handleSend();}
});

// 🎤 音声認識
const micBtn=document.getElementById("micBtn");
let rec;let listening=false;
if('webkitSpeechRecognition'in window){
  rec=new webkitSpeechRecognition();
  rec.lang=savedLang; // UI言語と揃える
  rec.interimResults=false;
  rec.maxAlternatives=1;
  rec.continuous=false; // 一旦認識で終了

  rec.onstart=()=>{
    listening=true;micBtn.classList.add("on");micBtn.textContent="🔴 停止";
  };
  rec.onend=()=>{
    listening=false;micBtn.classList.remove("on");micBtn.textContent="🎤 開始";
  };
  rec.onerror=(e)=>{console.warn(e);listening=false;micBtn.classList.remove("on");micBtn.textContent="🎤 開始";};
  rec.onresult=(e)=>{
    let text=e.results[0][0].transcript;
    document.getElementById("msgInput").value=text;
  };

  micBtn.addEventListener("click",()=>{
    if(!listening){rec.start();}else{rec.stop();}
  });
}else{
  micBtn.style.display="none"; // ブラウザ未対応なら非表示
}
</script>
</body>
</html>
