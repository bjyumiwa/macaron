<!-- whoai_talk.html éŸ³å£°å…¥åŠ›å¯¾å¿œ å®Œå…¨ç‰ˆ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI Talk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;
      background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    header{padding:10px;text-align:center}
    h1{margin:4px 0;font-size:20px}
    .chat-container{flex:1;width:100%;max-width:600px;overflow-y:auto;padding:12px}
    .msg{margin:8px 0;display:flex}
    .msg.user{justify-content:flex-end}
    .msg.bot{justify-content:flex-start}
    .bubble{
      padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.5;
      word-wrap:break-word;white-space:pre-wrap
    }
    .user .bubble{background:#4e9af1;color:#fff;border-bottom-right-radius:2px}
    .bot .bubble{background:#444;color:#fff;border-bottom-left-radius:2px}
    .input-box{display:flex;width:100%;max-width:600px;padding:10px;box-sizing:border-box}
    .input-box input{flex:1;padding:10px;border-radius:8px;border:none;font-size:16px}
    .input-box button{margin-left:8px;padding:10px 16px;border:none;border-radius:8px;background:#6c5ce7;color:#fff;cursor:pointer}
    .char-img{width:80px;margin:10px auto;display:block}
    select{margin-top:6px;padding:4px}
    #micBtn{margin-left:6px;padding:10px 14px;border:none;border-radius:8px;background:#ff7675;color:#fff;cursor:pointer}
    #micBtn.on{background:#d63031}
  </style>
</head>
<body>
  <header>
    <h1 id="title">ä¼šè©±</h1>
    <p id="subtitle">ãŸã­ã‚­ãƒ£ãƒ©ã§3å›ä¼šè©±ã™ã‚‹ã¨é€²åŒ–ã¸</p>
    <img id="charImg" class="char-img" src="" alt="ã‚­ãƒ£ãƒ©">
    <p id="charName"></p>
    <select id="langSelect">
      <option value="ja-JP">æ—¥æœ¬èª</option>
      <option value="en-US">English</option>
      <option value="zh-CN">ä¸­æ–‡</option>
      <option value="ko-KR">í•œêµ­ì–´</option>
    </select>
  </header>

  <div id="chat" class="chat-container"></div>

  <div class="input-box">
    <input id="msgInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
    <button id="sendBtn">é€ä¿¡</button>
    <button id="micBtn">ğŸ¤ é–‹å§‹</button>
  </div>

<script>
const TALK_ENDPOINT = "https://macaron-one.vercel.app/api/talk";
const CHAT_KEY = "whoai_chat";
const MAX_TANE = 3;
const MAX_EVOLVED = 10;

const charName = localStorage.getItem("char_name") || "ã‚­ãƒ£ãƒ©";
const color = localStorage.getItem("macaronColor") || "blue";
const stage = localStorage.getItem("stage") || "tane";
document.getElementById("charName").textContent = charName;

const charImg = document.getElementById("charImg");
charImg.src = (stage==="tane")
  ? `public/assets/stage1/tane_${color}.png`
  : `public/assets/stage1/evolved_${color}.png`;

// å¤šè¨€èª UI
const I18N = {
  title:{ "ja-JP":"ä¼šè©±","en-US":"Conversation","zh-CN":"å¯¹è¯","ko-KR":"ëŒ€í™”"},
  subtitle_tane:{
    "ja-JP":"ãŸã­ã‚­ãƒ£ãƒ©ã§3å›ä¼šè©±ã™ã‚‹ã¨é€²åŒ–ã¸",
    "en-US":"Talk 3 times with Tane â†’ Evolution",
    "zh-CN":"å’Œç§å­è§’è‰²å¯¹è¯3æ¬¡ â†’ è¿›åŒ–",
    "ko-KR":"ì”¨ì•— ìºë¦­í„°ì™€ 3ë²ˆ ëŒ€í™” â†’ ì§„í™”"
  },
  subtitle_evolved:{
    "ja-JP":"é€²åŒ–ã‚­ãƒ£ãƒ©ã§10å›ä¼šè©±ã™ã‚‹ã¨å¾©æ´»ã®å„€å¼ã¸",
    "en-US":"Talk 10 times with evolved form â†’ Rebirth ritual",
    "zh-CN":"å’Œè¿›åŒ–è§’è‰²å¯¹è¯10æ¬¡ â†’ å¤æ´»ä»ªå¼",
    "ko-KR":"ì§„í™” ìºë¦­í„°ì™€ 10ë²ˆ ëŒ€í™” â†’ ë¶€í™œì˜ ì˜ì‹"
  }
};
const langSelect=document.getElementById("langSelect");
function applyI18n(lang){
  document.getElementById("title").textContent = I18N.title[lang]||I18N.title["ja-JP"];
  document.getElementById("subtitle").textContent = (stage==="tane")
    ? I18N.subtitle_tane[lang]
    : I18N.subtitle_evolved[lang];
  localStorage.setItem("whoai_lang", lang);
}
const savedLang=localStorage.getItem("whoai_lang")||"ja-JP";
langSelect.value=savedLang;applyI18n(savedLang);
langSelect.addEventListener("change",()=>applyI18n(langSelect.value));

// ä¼šè©±å±¥æ­´
let history=[];
try{history=JSON.parse(localStorage.getItem(CHAT_KEY)||"[]");}catch(e){history=[];}
const chatDiv=document.getElementById("chat");
function renderChat(){
  chatDiv.innerHTML="";
  history.forEach(m=>{
    const msg=document.createElement("div");
    msg.className="msg "+(m.role==="user"?"user":"bot");
    msg.innerHTML=`<div class="bubble">${m.content}</div>`;
    chatDiv.appendChild(msg);
  });
  chatDiv.scrollTop=chatDiv.scrollHeight;
}
renderChat();

// é€ä¿¡å‡¦ç†
async function handleSend(){
  const input=document.getElementById("msgInput");
  const text=input.value.trim();if(!text)return;
  input.value="";

  history.push({role:"user",content:text});
  renderChat();localStorage.setItem(CHAT_KEY,JSON.stringify(history));

  try{
    const res=await fetch(TALK_ENDPOINT,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:text,color,stage,history,charName,lang:langSelect.value})
    });
    const data=await res.json();
    const reply=data.reply||"......";
    history.push({role:"bot",content:reply});
    renderChat();localStorage.setItem(CHAT_KEY,JSON.stringify(history));
    checkProgress();
  }catch(e){
    history.push({role:"bot",content:"[æ¥ç¶šã‚¨ãƒ©ãƒ¼]"});
    renderChat();
  }
}

// é€²è¡Œç®¡ç†
function checkProgress(){
  const userTurns=history.filter(m=>m.role==="user").length;
  if(stage==="tane" && userTurns>=MAX_TANE){
    localStorage.setItem("stage","evolved");
    window.location.href="macaron_select.html";
  }
  if(stage==="evolved" && userTurns>=MAX_EVOLVED){
    window.location.href="rebirth.html";
  }
}

// ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("sendBtn").addEventListener("click",handleSend);
document.getElementById("msgInput").addEventListener("keypress",e=>{
  if(e.key==="Enter"){handleSend();}
});

// ğŸ¤ éŸ³å£°èªè­˜
const micBtn=document.getElementById("micBtn");
let rec;let listening=false;
if('webkitSpeechRecognition'in window){
  rec=new webkitSpeechRecognition();
  rec.lang=savedLang; // UIè¨€èªã¨æƒãˆã‚‹
  rec.interimResults=false;
  rec.maxAlternatives=1;
  rec.continuous=false; // ä¸€æ—¦èªè­˜ã§çµ‚äº†

  rec.onstart=()=>{
    listening=true;micBtn.classList.add("on");micBtn.textContent="ğŸ”´ åœæ­¢";
  };
  rec.onend=()=>{
    listening=false;micBtn.classList.remove("on");micBtn.textContent="ğŸ¤ é–‹å§‹";
  };
  rec.onerror=(e)=>{console.warn(e);listening=false;micBtn.classList.remove("on");micBtn.textContent="ğŸ¤ é–‹å§‹";};
  rec.onresult=(e)=>{
    let text=e.results[0][0].transcript;
    document.getElementById("msgInput").value=text;
  };

  micBtn.addEventListener("click",()=>{
    if(!listening){rec.start();}else{rec.stop();}
  });
}else{
  micBtn.style.display="none"; // ãƒ–ãƒ©ã‚¦ã‚¶æœªå¯¾å¿œãªã‚‰éè¡¨ç¤º
}
</script>
</body>
</html>
