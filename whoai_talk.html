<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WHOAI - Talk</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    color:#fff; display:flex; flex-direction:column; gap:12px; padding:18px
  }
  .top{display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:999px}
  .dot{width:14px;height:14px;border-radius:50%}
  .dot.pink{background:#ff8fb1}.dot.blue{background:#88a7ff}.dot.green{background:#85f3b0}.dot.purple{background:#c59bff}
  .lang{display:flex;gap:8px}
  .lang button{border:none;border-radius:999px;padding:6px 12px;background:rgba(255,255,255,.15);color:#fff;cursor:pointer}
  .lang button.active{background:#fff;color:#111}
  .panel{background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.18);border-radius:16px}
  #hint{padding:10px 14px}
  #log{flex:1;overflow:auto;padding:14px}
  .msg{margin:10px 0;max-width:80%}
  .me{margin-left:auto}
  .b{background:rgba(255,255,255,.1);padding:10px 12px;border-radius:14px}
  .typing{opacity:.75;font-style:italic}
  .input{display:flex;gap:8px;padding:10px}
  .input input{flex:1;border:none;border-radius:12px;padding:12px}
  .input button{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .footer{opacity:.6;font-size:12px;text-align:right}
</style>
</head>
<body>
  <div class="top">
    <div class="badge">
      <span class="dot" id="dot"></span>
      <span id="traitLabel">—</span>
    </div>
    <div class="lang">
      <button type="button" data-lang="ja" class="active">日本語</button>
      <button type="button" data-lang="en">English</button>
    </div>
  </div>

  <div id="hint" class="panel"></div>
  <div id="log" class="panel" aria-live="polite"></div>

  <div class="input panel">
    <input id="text" type="text" placeholder="メッセージを入力 / Type a message" />
    <button id="send">送信</button>
  </div>
  <div class="footer">whoai_talk.html</div>

<script>
  // ====== 設定 ======
  const TALK_ENDPOINT = '/api/talk';   // 同ドメインで動かす場合はこのまま
  const USE_API = true;                // API失敗時はローカル応答に自動フォールバック

  // ====== i18n ======
  const I18N = {
    ja:{
      hint:{
        pink:"ピンク：情熱。前向きで励ますトーン。",
        blue:"ブルー：静寂。落ち着いて丁寧に考える。",
        green:"グリーン：元気。テンポよく行動を促す。",
        purple:"パープル：創造。比喩や発想の飛躍が増える。"
      },
      greet:{pink:"こんにちは！一緒に走り出そう。",blue:"こんにちは。ゆっくり考えていこう。",green:"やっほー！まずは一歩いってみよ！",purple:"ようこそ。物語を編んでみよう。"},
      you:"あなた", ai:"WHOAI", send:"送信", placeholder:"メッセージを入力",
      done3:"3回の会話が完了！もう一度マカロンを選んで、次の形態に進化させよう。",
      done10:"10回の会話が完了！次の進化のために、もう一度マカロンを選ぼう。",
      typing:"入力中…", err:"通信に失敗しました。ローカル応答に切り替えます。"
    },
    en:{
      hint:{
        pink:"Pink: Passion. Upbeat, encouraging tone.",
        blue:"Blue: Calm. Thoughtful and measured.",
        green:"Green: Energy. Snappy, action-nudging.",
        purple:"Purple: Creativity. More metaphors and leaps."
      },
      greet:{pink:"Hey! Let’s get rolling.",blue:"Hello. Let’s think this through.",green:"Yo! Let’s take the first step!",purple:"Welcome—let’s weave a story."},
      you:"You", ai:"WHOAI", send:"Send", placeholder:"Type a message",
      done3:"Three messages done! Choose another macaron to evolve to the next form.",
      done10:"Ten messages done! Pick another macaron for the next evolution.",
      typing:"typing…", err:"API failed. Falling back to local reply."
    }
  };
  const langBtns = document.querySelectorAll('.lang button');
  function currentLang(){ return (document.documentElement.lang==='ja'?'ja':'en'); }
  function applyLang(lang){
    document.documentElement.lang = (lang==='ja'?'ja':'en');
    langBtns.forEach(b=>b.classList.toggle('active', b.dataset.lang===lang));
    document.getElementById('send').textContent = I18N[lang].send;
    document.getElementById('text').placeholder = I18N[lang].placeholder + " / " + (lang==='ja'?'Type a message':'メッセージを入力');
    if(window.color){ document.getElementById('hint').textContent = I18N[lang].hint[color] || ""; }
    localStorage.setItem('lang', lang);
  }
  langBtns.forEach(b=>b.addEventListener('click',()=>applyLang(b.dataset.lang)));

  // ====== 状態読み込み ======
  const state = JSON.parse(localStorage.getItem('whoai_state') || "{}");
  const color = state.color || localStorage.getItem('selectedMacaron');
  if(!color){ location.href = 'macaron_select.html'; }
  document.getElementById('dot').classList.add(color);
  document.getElementById('traitLabel').textContent = state.name || "WHOAI";
  applyLang(localStorage.getItem('lang') || 'ja');

  // ★ 目標回数：seed=3 / evolved=10
  const TALK_TARGET = (state.stage === 'seed') ? 3 : 10;

  // ====== チャットUI ======
  const logEl = document.getElementById('log');
  const textEl = document.getElementById('text');
  const sendEl = document.getElementById('send');

  function addMsg(who, content, extraClass=''){
    const lang = currentLang();
    const label = (who==='me') ? I18N[lang].you : I18N[lang].ai;
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='me'?'me':'') + ' ' + extraClass;
    div.innerHTML = `<div class="b"><strong>${label}</strong><br>${content}</div>`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
    return div;
  }

  // 挨拶 & ヒント
  addMsg('ai', I18N[currentLang()].greet[color]);
  document.getElementById('hint').textContent = I18N[currentLang()].hint[color];

  // ====== フォールバック返信 ======
  function toneReply(input, lang){
    const ja = { pink:"うん！応援してるよ。", blue:"なるほど。順番に考えてみよう。", green:"いいね！小さく一歩、どう？", purple:"ふむ。別の想像をしてみたらどう？" }[color];
    const en = { pink:"Yes! I’m rooting for you.", blue:"I see. Let’s consider it step by step.", green:"Nice! How about one small action?", purple:"Hmm. What if we imagine it differently?" }[color];
    return (lang==='ja') ? ja : en;
  }

  // ====== 会話履歴 ======
  function loadChat(){ try{ return JSON.parse(localStorage.getItem('whoai_chat')||'[]'); }catch{ return []; } }
  function saveChat(arr){ localStorage.setItem('whoai_chat', JSON.stringify(arr.slice(-12))); }
  let chat = loadChat();

  // ====== API呼び出し ======
  async function talkAPI(userText){
    const lang = currentLang();
    const systemPrompt = (lang==='ja')
      ? `あなたはWHOAIのキャラクター。名前は「${state.name||'WHOAI'}」。色は${color}、形態は${state.variant||'tane'}。口調は次の方針：
- ピンク: 前向きに励ます
- ブルー: 落ち着いて丁寧に考える
- グリーン: テンポよく行動を促す
- パープル: 比喩や発想の飛躍を少し入れる
必ず日本語で、1〜2文で返答。最後に次の行動を1つだけ提案して。`
      : `You are WHOAI. Name: ${state.name||'WHOAI'}. Color: ${color}, Form: ${state.variant||'tane'}. Tone:
- Pink: upbeat encouragement
- Blue: calm, thoughtful
- Green: snappy, action-nudging
- Purple: creative, a bit metaphorical
Reply strictly in ${lang==='ja'?'Japanese':'English'}, in 1–2 sentences, ending with exactly one next-step prompt.`;

    const payload = { userMessage:userText, history:chat, systemPrompt, language:lang, temperature:0.7, max_tokens:220, model:"gpt-4o-mini" };

    const r = await fetch(TALK_ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();
    return data.reply?.trim() || "";
  }

  // ====== ターン数カウント ======
  function bumpTurns(){
    const s = JSON.parse(localStorage.getItem('whoai_state') || "{}");
    s.turns = (s.turns || 0) + 1;
    localStorage.setItem('whoai_state', JSON.stringify(s));
    return s;
  }

  // ====== 送信処理 ======
  async function handleSend(){
    const v = textEl.value.trim(); if(!v) return;
    const lang = currentLang();

    addMsg('me', v);
    textEl.value='';
    chat.push({role:"user", content:v}); saveChat(chat);

    const typing = addMsg('ai', I18N[lang].typing, 'typing');

    let reply = "";
    try{ if(USE_API) reply = await talkAPI(v); }catch(e){
      console.warn(e); typing.querySelector('.b').innerHTML = `<strong>${I18N[lang].ai}</strong><br>${I18N[lang].err}`;
    }
    if(!reply) reply = toneReply(v, lang);

    typing.remove();
    addMsg('ai', reply);
    chat.push({role:"assistant", content:reply}); saveChat(chat);

    const s = bumpTurns();
    if(s.turns >= TALK_TARGET){
      alert(TALK_TARGET===3 ? I18N[lang].done3 : I18N[lang].done10);
      location.href = 'macaron_select.html';
    }
  }

  sendEl.addEventListener('click', handleSend);
  textEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });
</script>
</body>
</html>
