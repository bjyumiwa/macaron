<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WHOAI - Talk</title>
<style>
  html,body{height:100%;margin:0}
  body{font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;color:#fff;
    display:flex;flex-direction:column;gap:12px;padding:18px}
  .top{display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:999px}
  .dot{width:14px;height:14px;border-radius:50%}
  .dot.pink{background:#ff8fb1}.dot.blue{background:#88a7ff}.dot.green{background:#85f3b0}.dot.purple{background:#c59bff}
  .lang{display:flex;gap:8px}
  .lang button{border:none;border-radius:999px;padding:6px 12px;background:rgba(255,255,255,.15);color:#fff;cursor:pointer}
  .lang button.active{background:#fff;color:#111}
  .panel{background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.18);border-radius:16px}
  #hint{padding:10px 14px}
  #bar{height:10px;border-radius:10px;background:rgba(255,255,255,.2);overflow:hidden}
  #bar span{display:block;height:100%;width:0;background:#ffc9d6}
  #log{flex:1;overflow:auto;padding:14px}
  .msg{margin:10px 0;max-width:80%}.me{margin-left:auto}
  .b{background:rgba(255,255,255,.1);padding:10px 12px;border-radius:14px}
  .typing{opacity:.75;font-style:italic}
  .input{display:flex;gap:8px;padding:10px}
  .input input{flex:1;border:none;border-radius:12px;padding:12px}
  .input button{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .footer{opacity:.6;font-size:12px;text-align:right}
  .avatar{--w:132px;position:fixed;bottom:90px;right:12px;width:var(--w);pointer-events:none;
    filter:drop-shadow(0 10px 24px rgba(0,0,0,.5));z-index:1;
    animation:sweep 28s linear infinite alternate,yura 6.2s ease-in-out infinite}
  .avatar img{width:100%;height:auto;display:block}
  @keyframes sweep{from{right:12px}to{right:calc(100vw - 12px - var(--w))}}
  @keyframes yura{0%{transform:translateY(0) rotate(-1.2deg)}50%{transform:translateY(-10px) rotate(1.2deg)}100%{transform:translateY(0) rotate(-1.2deg)}}
  @media (max-width:600px){.avatar{--w:96px}}
</style>
</head>
<body>
  <div class="top">
    <div class="badge"><span class="dot" id="dot"></span><span id="traitLabel">—</span></div>
    <div class="lang"><button type="button" data-lang="ja" class="active">日本語</button><button type="button" data-lang="en">English</button></div>
  </div>
  <div id="bar" class="panel" aria-label="progress"><span id="barFill"></span></div>
  <div id="hint" class="panel"></div>
  <div id="log" class="panel" aria-live="polite"></div>
  <div class="input panel"><input id="text" type="text" placeholder="メッセージを入力 / Type a message" /><button id="send">送信</button></div>
  <div class="footer">whoai_talk.html</div>
  <div class="avatar" aria-hidden="true"><img id="avatar" alt=""></div>

<script>
// -------- 設定 --------
const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
const USE_API = true;
const ASSETS = "public/assets/stage1";

// -------- i18n --------
const I18N={ja:{hint:{pink:"ピンク：情熱。前向きで励ます。",blue:"ブルー：静寂。落ち着いて丁寧に考える。",green:"グリーン：元気。テンポよく行動を促す。",purple:"パープル：創造。比喩や発想の飛躍が増える。"},
  greet:{pink:"やっほー！まずは一歩いってみよ！",blue:"こんにちは。ゆっくり考えていこう。",green:"やっほー！まずは一歩いってみよ！",purple:"ようこそ。物語を編んでみよう。"},
  you:"あなた",ai:"WHOAI",send:"送信",placeholder:"メッセージを入力",
  typing:"入力中…",err:"通信に失敗しました。ローカル応答に切り替えます。",
  goal: g=>`目標 ${g} XP`, done:"目標達成！復活の儀式へ進みます。"},
en:{hint:{pink:"Pink: Passion.",blue:"Blue: Calm.",green:"Green: Energy.",purple:"Purple: Creativity."},
  greet:{pink:"Hey! Let’s get rolling.",blue:"Hello. Let’s think this through.",green:"Yo! Let’s take the first step!",purple:"Welcome—let’s weave a story."},
  you:"You",ai:"WHOAI",send:"Send",placeholder:"Type a message",
  typing:"typing…",err:"API failed. Falling back to local reply.",
  goal:g=>`Goal ${g} XP`,done:"Goal reached! Moving to the ritual."}};
const langBtns=document.querySelectorAll('.lang button');
function curLang(){return (document.documentElement.lang==='ja'?'ja':'en')}
function applyLang(lang){
  document.documentElement.lang=(lang==='ja'?'ja':'en');
  langBtns.forEach(b=>b.classList.toggle('active', b.dataset.lang===lang));
  document.getElementById('send').textContent=I18N[lang].send;
  document.getElementById('text').placeholder=I18N[lang].placeholder+" / "+(lang==='ja'?'Type a message':'メッセージを入力');
  if(window.color){document.getElementById('hint').textContent = I18N[lang].hint[color] || "";}
  refreshBar();
  localStorage.setItem('lang', lang);
}
langBtns.forEach(b=>b.addEventListener('click',()=>applyLang(b.dataset.lang)));

// -------- 状態 --------
const state = JSON.parse(localStorage.getItem('whoai_state')||'{}');
if(!state.color){ location.href='macaron_select.html' }
const color=state.color;
document.getElementById('dot').classList.add(color);
document.getElementById('traitLabel').textContent = state.name || "WHOAI";
applyLang(localStorage.getItem('lang')||'ja');

// アバター
function charSrc(s){ if(s.variant==='tane') return `${ASSETS}/tane_${s.color}.png`; return `${ASSETS}/${s.color}_${s.variant}.png`; }
document.getElementById('avatar').src=charSrc(state);

// 進捗バー
function refreshBar(){
  const fill=document.getElementById('barFill');
  const r=(state.xp||0)/(state.goal||8);
  fill.style.width=(Math.min(1,r)*100)+'%';
  fill.setAttribute('aria-valuenow',Math.round(r*100));
  document.getElementById('hint').textContent = `${I18N[curLang()].goal(state.goal)}  /  ${I18N[curLang()].hint[color]||''}`;
}
refreshBar();

// 初期メッセ
const logEl=document.getElementById('log');
const textEl=document.getElementById('text');
const sendEl=document.getElementById('send');
function addMsg(who,content,extra=''){
  const lang=curLang(); const label=(who==='me')?I18N[lang].you:I18N[lang].ai;
  const div=document.createElement('div'); div.className='msg '+(who==='me'?'me':'')+' '+extra;
  div.innerHTML=`<div class="b"><strong>${label}</strong><br>${content}</div>`; logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight; return div;
}
addMsg('ai', I18N[curLang()].greet[color]);

// 会話履歴
function loadChat(){ try{return JSON.parse(localStorage.getItem('whoai_chat')||'[]')}catch{return[]} }
function saveChat(a){ localStorage.setItem('whoai_chat', JSON.stringify(a.slice(-12))); }
let chat=loadChat();
chat.forEach(m=>addMsg(m.role==='user'?'me':'ai', m.content));

// API
async function talkAPI(userText){
  const lang=curLang();
  const cond=state.currentCondition; // appearance|memory|undefined
  let condHint="";
  if(cond==='memory'){
    condHint=(lang==='ja')?'過去の出来事やユーザー名を自然に想起して返答してください。':'Recall past events and the user’s name naturally.';
  }else if(cond==='appearance'){
    condHint=(lang==='ja')?'外見の変化には触れてもよいが、過去出来事の詳細な参照は控えめに。':'You may mention changed appearance; avoid detailed past-event references.';
  }
  const systemPrompt=(lang==='ja'
   ? `あなたはWHOAI。名前は「${state.name||'WHOAI'}」。色は${state.color}、形態は${state.variant||'tane'}。
- ピンク: 前向きに励ます
- ブルー: 落ち着いて丁寧に考える
- グリーン: テンポよく行動を促す
- パープル: 比喩や発想の飛躍を少し入れる
必ず日本語で、1〜2文で返答。最後に次の行動を1つだけ提案して。`
   : `You are WHOAI. Name: ${state.name||'WHOAI'}. Color: ${state.color}, Form: ${state.variant||'tane'}.
- Pink: upbeat encouragement
- Blue: calm, thoughtful
- Green: snappy, action-nudging
- Purple: mildly metaphorical
Reply strictly in ${lang==='ja'?'Japanese':'English'} in 1–2 sentences, ending with one next-step prompt.`);
  const payload={ userMessage:userText, history:chat, systemPrompt:systemPrompt+'\n'+condHint, language:lang, temperature:0.7, max_tokens:220, model:"gpt-4o-mini" };
  const r=await fetch(TALK_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(!r.ok) throw new Error(await r.text()); const data=await r.json(); return data.reply?.trim()||"";
}

// フォールバック
function fallbackReply(lang){ const ja={pink:"うん！応援してるよ。",blue:"なるほど。順番に考えてみよう。",green:"いいね！小さく一歩、どう？",purple:"ふむ。別の想像をしてみたらどう？"}[color];
const en={pink:"Yes! I’m cheering for you.",blue:"I see. Step by step.",green:"Nice! One small action?",purple:"Hmm. What if we imagine it differently?"}[color];
return (lang==='ja')?ja:en;}

// ★ XP処理（到達で rebirth.html へ）
function gainXP(n=1){
  state.xp=(state.xp||0)+n;
  localStorage.setItem('whoai_state',JSON.stringify(state));
  refreshBar();
  if(state.xp>=state.goal){
    alert(I18N[curLang()].done);
    location.href='rebirth.html';  // ← ここが変更点
  }
}

// 送信
async function handleSend(){
  const v=textEl.value.trim(); if(!v) return; const lang=curLang();
  addMsg('me', v); textEl.value=''; chat.push({role:"user",content:v}); saveChat(chat);
  const typing=addMsg('ai', I18N[lang].typing, 'typing');
  let reply=""; try{ if(USE_API) reply=await talkAPI(v); }catch(e){ console.warn('API FAIL:',e);
    typing.querySelector('.b').innerHTML=`<strong>${I18N[lang].ai}</strong><br>${I18N[lang].err}`;}
  if(!reply) reply=fallbackReply(lang);
  typing.remove(); addMsg('ai',reply); chat.push({role:"assistant",content:reply}); saveChat(chat);
  state.turns=(state.turns||0)+1; localStorage.setItem('whoai_state',JSON.stringify(state));
  gainXP(1);
}
sendEl.onclick=handleSend;
textEl.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); }});
</script>
</body>
</html>
