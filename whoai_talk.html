<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk.html - ä¼šè©±ï¼ˆå¾©æ—§ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
    }
    /* å³ä¸Šã®åå‰ãƒãƒƒã‚¸ */
    .whoai-name-badge{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700;color:#fff
    }
    #whoaiBadgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}

    /* ç”»é¢ä¸­å¤®ã®ã‚­ãƒ£ãƒ©ï¼ˆtane / é€²åŒ–ï¼‰ */
    .whoai-sprite{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:180px;height:180px;display:flex;align-items:center;justify-content:center;
      z-index:30; pointer-events:none;
      animation:float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .whoai-sprite img{max-width:100%;max-height:100%}
    @keyframes float{0%{transform:translate(-50%,-50%)}
                     50%{transform:translate(-50%,-54%)}
                     100%{transform:translate(-50%,-50%)}}

    /* æ—¢å­˜ã®ä¼šè©±UIãŒè¢«ã£ã¦ã‚‚OKãªã‚ˆã†ã«è»½ãä½™ç™½ã ã‘ç¢ºä¿ï¼ˆä»»æ„ï¼‰ */
    .whoai-safe-pad{padding-top:72px}
  </style>
</head>
<body class="whoai-safe-pad">

  <!-- â–¼ ã“ã“ã«â€œæ—¢å­˜ã®ä¼šè©±UIï¼ˆfetch/TALK_ENDPOINTå«ã‚€ï¼‰â€ã‚’ãã®ã¾ã¾ç½®ã„ã¦ãã ã•ã„ â–¼ -->
  <!-- æ—¢å­˜UIãŒç„¡ãã¦ã‚‚ã“ã®ãƒšãƒ¼ã‚¸ã¯å‹•ãã¾ã™ï¼ˆAPIã«ã¯ä¸€åˆ‡å¹²æ¸‰ã—ã¾ã›ã‚“ï¼‰ -->

  <!-- ä¸­å¤®ã‚­ãƒ£ãƒ© -->
  <div id="whoaiSprite" class="whoai-sprite" aria-hidden="true">
    <img id="whoaiSpriteImg" alt="character">
  </div>

  <!-- å³ä¸Šã®ãƒãƒƒã‚¸ -->
  <div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
    <img id="whoaiBadgeFace" alt="">
    <span id="whoaiBadgeText"></span>
  </div>

  <!-- ===== é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆAPIéå¹²æ¸‰/å®Œå…¨å¾©æ—§ï¼‰ ===== -->
  <script>
  (function(){
    // ---------- å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
    function lsGet(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
    function lsSet(k,v){localStorage.setItem(k, typeof v==="string"?v:JSON.stringify(v))}
    function setImageWithFallback(imgEl, paths){
      let i=0; const trySet=()=>{
        if(i>=paths.length) return;
        imgEl.onerror=()=>{i++; trySet();};
        imgEl.src=paths[i];
      }; trySet();
    }

    // ---------- æ—¢å­˜ã‚­ãƒ¼äº’æ› ----------
    const pickedRaw = lsGet('selectedMacaron') || lsGet('whoai_selectedMacaron') || 'green';
    const color = ['pink','blue','green','purple'].includes(pickedRaw) ? pickedRaw : 'green';
    const stage = lsGet('whoai_stage') || 'stage1';              // stage1=tane / stage2=evolved / post=é¸æŠå¾Œ
    const appearance = lsGet('whoai_appearance') || (stage==='stage1'?'tane':'evolved');
    let charName = lsGet('characterName','ãªã¾ãˆæœªè¨­å®š');

    // ---------- ãƒãƒƒã‚¸æç”» ----------
    const badge = document.getElementById('whoaiNameBadge');
    const face  = document.getElementById('whoaiBadgeFace');
    const nameEl= document.getElementById('whoaiBadgeText');
    nameEl.textContent = `ğŸª„ ${charName}`;
    badge.style.display = 'inline-block';

    function faceCandidates(open){
      if(appearance==='tane'){
        return ['public/assets/stage1/tane_green.png'];
      }
      const s = open ? 'open':'closed';
      return [
        `./${color}_${s}.png`,
        `public/assets/evolved/${color}_${open?'open':'close'}.png`
      ];
    }
    let isOpen=true;
    setImageWithFallback(face, faceCandidates(isOpen));
    setInterval(()=>{ isOpen=!isOpen; setImageWithFallback(face, faceCandidates(isOpen)); },
      (appearance==='tane'?1600:1200));

    // ---------- ç”»é¢ä¸­å¤®ã®ã‚­ãƒ£ãƒ©ï¼ˆè¦‹é€ƒã—é˜²æ­¢ã®æœ¬ä½“ï¼‰ ----------
    const spriteImg = document.getElementById('whoaiSpriteImg');
    function spriteCandidates(open){
      if(appearance==='tane'){
        return ['public/assets/stage1/tane_green.png'];
      }
      const s = open ? 'open':'closed';
      return [
        `./${color}_${s}.png`,
        `public/assets/evolved/${color}_${open?'open':'close'}.png`
      ];
    }
    let sOpen=true;
    setImageWithFallback(spriteImg, spriteCandidates(sOpen));
    setInterval(()=>{ sOpen=!sOpen; setImageWithFallback(spriteImg, spriteCandidates(sOpen)); },
      (appearance==='tane'?1600:1100));

    // ----------ï¼ˆä»»æ„ï¼‰é€²è¡Œã‚«ã‚¦ãƒ³ãƒˆï¼šAPIã®é€ä¿¡ã«å‰²ã‚Šè¾¼ã¾ãšâ€œå¾Œè¿½ã„â€ ----------
    const S1_TARGET=5, S2_TARGET=10, POST_TARGET=10;
    function countAndRoute(){
      const st = lsGet('whoai_stage','stage1');
      if(st==='stage1'){
        const n=(lsGet('whoai_turn_s1',0)|0)+1; lsSet('whoai_turn_s1',n);
        if(n>=S1_TARGET) setTimeout(()=>location.href='macaron_select.html',700);
      }else if(st==='stage2'){
        const n=(lsGet('whoai_turn_s2',0)|0)+1; lsSet('whoai_turn_s2',n);
        if(n>=S2_TARGET) setTimeout(()=>location.href='rebirth.html',700);
      }else if(st==='post'){
        const n=(lsGet('whoai_post_turn',0)|0)+1; lsSet('whoai_post_turn',n);
        if(n>=POST_TARGET){
          const url=lsGet('whoai_survey_url')||'identity_check.html';
          setTimeout(()=>location.href=url,600);
        }
      }
    }
    // ãƒœã‚¿ãƒ³ã‚„Enteré€ä¿¡ã‚’ã–ã£ãã‚Šãƒ•ãƒƒã‚¯ï¼ˆæ—¢å­˜UIãŒç„¡ãã¦ã‚‚ç„¡å®³ï¼‰
    function hookSend(){
      const btn=document.querySelector('#sendBtn, #sendButton, button[data-send], button#send, .send');
      if(btn && !btn.dataset._whoaiHooked){ btn.dataset._whoaiHooked='1';
        btn.addEventListener('click', ()=>setTimeout(countAndRoute,120)); }
      const input=document.querySelector('#userInput, textarea, input[type="text"]');
      if(input && !input.dataset._whoaiHooked){ input.dataset._whoaiHooked='1';
        input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.shiftKey) setTimeout(countAndRoute,150); });}
    }
    hookSend(); setInterval(hookSend,1000);
  })();
  </script>
  <!-- ===== /é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ ===== -->
</body>
</html>
