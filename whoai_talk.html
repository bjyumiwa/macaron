<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk - 会話（tane3→openclause10→儀式→姿保持10）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("./public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;padding:16px
    }
    .wrap{width:min(880px,92%);}
    .badge{
      position:fixed;top:8px;right:8px;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:12px;
      font-weight:700;backdrop-filter:blur(3px)
    }
    #chat{min-height:320px;background:rgba(255,255,255,.08);border-radius:14px;padding:12px;margin:10px 0;overflow:auto}
    #controls{display:flex;gap:8px}
    input,button{border:none;border-radius:12px;padding:10px 12px}
    input{flex:1;background:rgba(255,255,255,.9);color:#111}
    button{background:#ffd1ec;color:#111;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="badge" id="stateBadge">loading…</div>
  <div class="wrap">
    <h2>会話</h2>
    <div id="chat"></div>
    <div id="controls">
      <input id="msg" placeholder="メッセージを入力…" />
      <button id="sendBtn">送信</button>
    </div>
    <div id="hint" style="opacity:.85;margin-top:6px;font-size:.95em"></div>
  </div>

  <!-- 共通ストレージ -->
  <script>
  window.WhoAI = window.WhoAI || (function(){
    const KEY='whoai_progress';
    function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch(e){return{}}}
    function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
    function ensureInit(){
      const s = load();
      if(!s.stage) s.stage='tane';
      if(!('talkCount' in s)) s.talkCount=0;
      if(!s.phase) s.phase='preRebirth';
      return s;
    }
    return {KEY,load,save,ensureInit};
  })();
  </script>

  <script>
  (()=>{
    const chat = document.getElementById('chat');
    const sendBtn = document.getElementById('sendBtn');
    const msg = document.getElementById('msg');
    const hint = document.getElementById('hint');
    const badge = document.getElementById('stateBadge');
    const SURVEY = 'https://docs.google.com/forms/d/e/1FAIpQLSfzWdkmMetDfQ9CZGPzvmTaIaANHV6Ie471LA7mrPAXfpVmuA/viewform?usp=header';

    let s = WhoAI.ensureInit();
    renderBadge();

    function renderBadge(){
      const stageLabel = s.stage==='tane'?'stage1 (tane)':'stage2 (openclause)';
      const phaseLabel = s.phase==='preRebirth'?'前半':'復活後';
      const countLabel = (s.phase==='postRebirth' && s.postMode==='keepAppearance')
        ? `postTalk ${s.postTalkCount||0}/10`
        : `talk ${s.talkCount||0}/${s.stage==='tane'?3:10}`;
      badge.textContent = `${stageLabel} | ${phaseLabel} | ${countLabel} | color:${s.color||'-'}`;
      hint.textContent =
        (s.phase==='preRebirth' && s.stage==='tane') ? 'taneで3回会話すると、もう一度マカロンへ' :
        (s.phase==='preRebirth' && s.stage==='openclause') ? 'openclauseで10回会話すると、復活の儀式へ' :
        (s.phase==='postRebirth' && s.postMode==='keepAppearance') ? '復活後：姿はそのまま。会話を10回でアンケートへ' :
        '';
    }

    function append(role, text){
      const b = document.createElement('div');
      b.style.margin='8px 0';
      b.innerHTML = `<b>${role}:</b> ${text}`;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    // ★ ここで既存のAPI送信を使ってもOK。最低限のダミー応答も入れておく。
    async function send(){
      const q = msg.value.trim();
      if(!q) return;
      msg.value='';
      append('You', q);

      // ここで既存のAPI呼び出しがあれば差し替え（レス描画後に advance() を呼んでね）
      // ダミー応答
      await new Promise(r=>setTimeout(r, 200));
      append('WhoAI', '…うん、なるほど！');

      setTimeout(advance, 30); // 応答描画後に進行判定
    }

    function advance(){
      s = WhoAI.ensureInit();

      // === 前半：taneで3回 → macaronへ戻す（戻った印を付ける） ===
      if(s.phase==='preRebirth' && s.stage==='tane'){
        s.talkCount = (s.talkCount||0)+1;
        WhoAI.save(s); renderBadge();
        if(s.talkCount>=3){
          s.talkCount=0;
          s._cameBackAfter3 = true; // 2回目マカロンで進化ボタン表示用
          WhoAI.save(s);
          location.href='macaron.html';
        }
        return;
      }

      // === 前半：openclauseで10回 → 儀式へ ===
      if(s.phase==='preRebirth' && s.stage==='openclause'){
        s.talkCount = (s.talkCount||0)+1;
        WhoAI.save(s); renderBadge();
        if(s.talkCount>=10){
          WhoAI.save(s);
          location.href='rebirth.html';
        }
        return;
      }

      // === 後半：容姿キープ（会話リセット）で10回 → アンケート ===
      if(s.phase==='postRebirth' && s.postMode==='keepAppearance'){
        s.postTalkCount = (s.postTalkCount||0)+1;
        WhoAI.save(s); renderBadge();
        if(s.postTalkCount>=10){
          location.href = SURVEY;
        }
        return;
      }
    }

    sendBtn.addEventListener('click', send);
    msg.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });
  })();
  </script>
</body>
</html>
