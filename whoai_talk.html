<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WHOAI - Talk</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    color:#fff; display:flex; flex-direction:column; gap:12px; padding:18px
  }
  .top{display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:999px}
  .dot{width:14px;height:14px;border-radius:50%}
  .dot.pink{background:#ff8fb1}.dot.blue{background:#88a7ff}.dot.green{background:#85f3b0}.dot.purple{background:#c59bff}
  .lang{display:flex;gap:8px}
  .lang button{border:none;border-radius:999px;padding:6px 12px;background:rgba(255,255,255,.15);color:#fff;cursor:pointer}
  .lang button.active{background:#fff;color:#111}

  .panel{background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.18);border-radius:16px}

  /* progress */
  #bar{height:12px;border-radius:8px;overflow:hidden;position:relative}
  #fill{height:100%;width:0;background:linear-gradient(90deg,#ffd1ec,#ffc5d9,#ffd1ec)}
  #goalText{padding:8px 12px}

  #hint{padding:10px 14px}
  #log{flex:1;overflow:auto;padding:14px}
  .msg{margin:10px 0;max-width:80%}
  .me{margin-left:auto}
  .b{background:rgba(255,255,255,.1);padding:10px 12px;border-radius:14px}
  .typing{opacity:.75;font-style:italic}
  .input{display:flex;gap:8px;padding:10px}
  .input input{flex:1;border:none;border-radius:12px;padding:12px}
  .input button{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .footer{opacity:.6;font-size:12px;text-align:right}

  /* avatar - 横方向にゆらゆら動く */
  .avatar{
    position:fixed; bottom:96px; width:150px; pointer-events:none;
    filter:drop-shadow(0 10px 24px rgba(0,0,0,.5)); z-index:1;
    animation: yoko 8s ease-in-out infinite;
    transform-origin:center;
  }
  .avatar img{width:100%; height:auto; display:block}
  .avatar .fallback{
    width:120px; height:120px; border-radius:50%;
    border:4px solid rgba(255,255,255,.85); box-shadow:0 8px 20px rgba(0,0,0,.45);
  }
  @keyframes yoko{
    0%   { transform: translateX(0) }
    50%  { transform: translateX(-60px) }
    100% { transform: translateX(0) }
  }

  .disabled{opacity:.5;pointer-events:none}
</style>
</head>
<body>
  <div class="top">
    <div class="badge">
      <span class="dot" id="dot"></span>
      <span id="traitLabel">—</span>
    </div>
    <div class="lang">
      <button type="button" data-lang="ja" class="active">日本語</button>
      <button type="button" data-lang="en">English</button>
    </div>
  </div>

  <div id="goalText" class="panel"></div>
  <div id="bar" class="panel" aria-label="progress"><div id="fill"></div></div>

  <div id="hint" class="panel"></div>
  <div id="log" class="panel" aria-live="polite"></div>

  <div class="input panel">
    <input id="text" type="text" placeholder="メッセージを入力 / Type a message" />
    <button id="send">送信</button>
  </div>
  <div class="footer">whoai_talk.html</div>

  <!-- avatar -->
  <div class="avatar" aria-hidden="true" style="right:24px;">
    <img id="avatar" alt="">
  </div>

<script>
  /* ====== APIエンドポイント ====== */
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const ASSETS = "public/assets/stage1";

  /* ====== i18n ====== */
  const I18N = {
    ja:{ hint:{pink:"ピンク：情熱。前向きで励ますトーン。",blue:"ブルー：静寂。落ち着いて丁寧に考える。",green:"グリーン：元気。テンポよく行動を促す。",purple:"パープル：創造。比喩や発想の飛躍が増える。"},
      greet:{pink:"やっほー！まずは一歩いってみよ！",blue:"こんにちは。ゆっくり考えていこう。",green:"やっほー！まずは一歩いってみよ！",purple:"ようこそ。物語を編んでみよう。"},
      you:"あなた", ai:"WHOAI", send:"送信", placeholder:"メッセージを入力",
      goal:(n,c)=>`目標 ${n} XP / ${c}：`, typing:"入力中…", err:"通信に失敗しました。ローカル応答に切り替えます。", done:"目標に到達！次のステップへ進みます。"},
    en:{ hint:{pink:"Pink: Passion. Upbeat, encouraging tone.",blue:"Blue: Calm. Thoughtful and measured.",green:"Green: Energy. Snappy, action-nudging.",purple:"Purple: Creativity. More metaphors and leaps."},
      greet:{pink:"Yo! Let’s take the first step!",blue:"Hello. Let’s think this through.",green:"Yo! Let’s take the first step!",purple:"Welcome—let’s weave a story."},
      you:"You", ai:"WHOAI", send:"Send", placeholder:"Type a message",
      goal:(n,c)=>`Goal ${n} XP / ${c}: `, typing:"typing…", err:"API failed. Falling back to local reply.", done:"Goal reached! Moving to the next step."}
  };

  /* ====== 状態・進捗バーを先に初期化 ====== */
  const bar = document.getElementById('bar');
  const fill = document.getElementById('fill');
  const goalText = document.getElementById('goalText');

  function currentLang(){ return (document.documentElement.lang==='ja'?'ja':'en'); }
  function updateGoalText(){
    const lang = currentLang();
    const colorLabel = {pink:'ピンク / Pink', blue:'ブルー / Blue', green:'グリーン / Green', purple:'パープル / Purple'}[state.color] || state.color;
    goalText.textContent = I18N[lang].goal(state.goal, colorLabel) + (lang==='ja'
      ? ({pink:"情熱。前向きで励ます。", blue:"静寂。落ち着いて丁寧。", green:"元気。テンポよく行動。", purple:"創造。比喩や飛躍。"}[state.color] || "")
      : ({pink:"Passion, upbeat.", blue:"Calm, thoughtful.", green:"Energetic, snappy.", purple:"Creative, metaphorical."}[state.color] || "")
    );
  }
  function updateBar(){
    const p = Math.max(0, Math.min(1, state.xp / Math.max(1,state.goal)));
    fill.style.width = (p*100)+'%';
  }

  /* ====== 言語切替 ====== */
  const langBtns = document.querySelectorAll('.lang button');
  function applyLang(lang){
    document.documentElement.lang = (lang==='ja'?'ja':'en');
    langBtns.forEach(b=>b.classList.toggle('active', b.dataset.lang===lang));
    document.getElementById('send').textContent = I18N[lang].send;
    document.getElementById('text').placeholder =
      I18N[lang].placeholder + " / " + (lang==='ja'?'Type a message':'メッセージを入力');
    if(window.state){
      document.getElementById('hint').textContent = I18N[lang].hint[state.color] || "";
      updateGoalText();
    }
    localStorage.setItem('lang', lang);
  }
  langBtns.forEach(b=>b.addEventListener('click',()=>applyLang(b.dataset.lang)));

  /* ====== 状態ロード ====== */
  function read(obj, k, def){ return (obj && obj[k]!=null)?obj[k]:def; }
  const stored = JSON.parse(localStorage.getItem('whoai_state') || "{}");
  const macaron = JSON.parse(localStorage.getItem('macaron_choice') || "null");
  let color = stored.color || (macaron?macaron.macaron:null) || localStorage.getItem('selectedMacaron') || 'pink';
  const state = {
    name: read(stored,'name','WHOAI'),
    color, variant: read(stored,'variant','tane'),
    stage: read(stored,'stage','seed'),
    xp: read(stored,'xp',0),
    goal: read(stored,'goal', (stored.stage==='evolved'?12:8))
  };
  window.state = state;

  document.getElementById('dot').classList.add(color);
  document.getElementById('traitLabel').textContent = state.name || "WHOAI";
  applyLang(localStorage.getItem('lang') || 'ja');

  /* ====== アバター ====== */
  function charSrc(s){
    if(s.variant === "tane") return `${ASSETS}/tane_${s.color}.png`;
    return `${ASSETS}/${s.color}_${s.variant}.png`;
  }
  const img = document.getElementById('avatar');
  img.src = charSrc(state);
  img.alt = (state.name || 'WHOAI') + ' avatar';
  img.onerror = ()=>{
    const f = document.createElement('div');
    f.className = 'fallback';
    f.style.background = {pink:'#ff8fb1', blue:'#88a7ff', green:'#85f3b0', purple:'#c59bff'}[color] || '#fff';
    img.replaceWith(f);
  };

  updateGoalText(); updateBar();

  /* ====== チャットUI ====== */
  const logEl = document.getElementById('log');
  const textEl = document.getElementById('text');
  const sendEl = document.getElementById('send');

  function addMsg(who, content, extraClass=''){
    const lang = currentLang();
    const label = (who==='me') ? I18N[lang].you : I18N[lang].ai;
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='me'?'me':'') + ' ' + extraClass;
    div.innerHTML = `<div class="b"><strong>${label}</strong><br>${content}</div>`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
    return div;
  }
  addMsg('ai', I18N[currentLang()].greet[color]);
  document.getElementById('hint').textContent = I18N[currentLang()].hint[color];

  function loadChat(){ try{ return JSON.parse(localStorage.getItem('whoai_chat')||'[]'); }catch{ return []; } }
  function saveChat(arr){ localStorage.setItem('whoai_chat', JSON.stringify(arr.slice(-14))); }
  let chat = loadChat();

  /* ====== API呼び出し ====== */
  async function talkAPI(userText){
    const lang = currentLang();
    const systemPrompt = (lang==='ja')
      ? `あなたはWHOAIのキャラクター。名前は「${state.name||'WHOAI'}」。色は${state.color}、形態は${state.variant||'tane'}。口調は次の方針：
- ピンク: 前向きに励ます
- ブルー: 落ち着いて丁寧に考える
- グリーン: テンポよく行動を促す
- パープル: 比喩や発想の飛躍を少し入れる
必ず日本語で、1〜2文で返答。最後に次の行動を1つだけ提案して。`
      : `You are WHOAI. Name: ${state.name||'WHOAI'}. Color: ${state.color}, Form: ${state.variant||'tane'}...`;
    const payload = { userMessage:userText, history:chat, systemPrompt, language:lang, temperature:0.7, max_tokens:220, model:"gpt-4o-mini" };
    const r = await fetch(TALK_ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();
    return data.reply?.trim() || "";
  }

  function toneReply(lang){
    const ja = { pink:"うん！応援してるよ。", blue:"なるほど。順番に考えてみよう。", green:"いいね！小さく一歩、どう？", purple:"ふむ。別の想像をしてみたらどう？" }[state.color];
    const en = { pink:"Yes! I’m rooting for you.", blue:"I see. Let’s consider it step by step.", green:"Nice! How about one small action?", purple:"Hmm. What if we imagine it differently?" }[state.color];
    return (lang==='ja') ? ja : en;
  }

  function saveState(){ localStorage.setItem('whoai_state', JSON.stringify(state)); }
  function reachGoal(){ alert(I18N[currentLang()].done); location.href = 'rebirth.html'; }
  function disableInput(disabled=true){
    textEl.disabled = disabled; sendEl.disabled = disabled;
    if(disabled){ textEl.classList.add('disabled'); sendEl.classList.add('disabled'); }
    else { textEl.classList.remove('disabled'); sendEl.classList.remove('disabled'); }
  }
  if(state.xp >= state.goal){ disableInput(true); }

  async function handleSend(){
    if(state.xp >= state.goal){ return; }
    const v = textEl.value.trim(); if(!v) return;
    const lang = currentLang();
    addMsg('me', v);
    textEl.value='';
    chat.push({role:"user", content:v}); saveChat(chat);
    const typing = addMsg('ai', I18N[lang].typing, 'typing');
    let reply = "";
    try{ reply = await talkAPI(v); }
    catch(e){ console.warn(e); typing.querySelector('.b').innerHTML = `<strong>${I18N[lang].ai}</strong><br>${I18N[lang].err}`; reply = toneReply(lang); }
    typing.remove();
    addMsg('ai', reply);
    chat.push({role:"assistant", content:reply}); saveChat(chat);
    state.xp = (state.xp||0) + 1;
    updateBar(); saveState();
    if(state.xp >= state.goal){ disableInput(true); setTimeout(reachGoal, 250); }
  }
  sendEl.addEventListener('click', handleSend);
  textEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });
</script>
</body>
</html>
