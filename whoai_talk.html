<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - 会話</title>
  <style>
    html,body{height:100%;margin:0}
    body{font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:1000;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);padding:8px 12px;border-radius:12px;font-weight:700;font-size:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    header{margin-top:22px;text-align:center}
    header h1{margin:6px 0 4px;font-size:22px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    header p{margin:0;opacity:.9;font-size:13px}
    .character{margin:14px 0 8px;display:flex;flex-direction:column;align-items:center}
    .character img{width:160px;max-width:45vw;aspect-ratio:1/1;object-fit:contain;filter:drop-shadow(0 8px 30px rgba(0,0,0,.45));}
    .status-chip{margin-top:6px;font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.1)}
    #chatArea{width:min(680px,92vw);max-height:52vh;overflow-y:auto;padding:14px;border-radius:14px;background:rgba(0,0,0,.35);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .bubble{display:inline-block;padding:10px 12px;border-radius:12px;margin:8px 0;max-width:88%;line-height:1.5}
    .me{background:rgba(255,255,255,.15);align-self:flex-end}
    .ai{background:rgba(255,255,255,.08)}
    .row{display:flex;gap:8px}
    form{width:min(680px,92vw);display:flex;gap:8px;margin:14px 0 18px}
    input[type="text"]{flex:1;padding:12px 14px;border-radius:12px;border:none;outline:none;background:rgba(255,255,255,.12);color:#fff}
    button{padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    #sendBtn{background:#ffd1ec;color:#141217}
    #sendBtn:disabled{opacity:.7;cursor:not-allowed}
    .file-label{position:fixed;left:10px;bottom:10px;font-size:12px;opacity:.75}
  </style>
</head>
<body>
  <div class="whoai-name-badge" id="nameBadge">WhoAI</div>
  <header>
    <h1>会話</h1>
    <p id="subtitle">進行に応じて自動で次の画面へ進みます</p>
  </header>
  <section class="character">
    <img id="characterImg" alt="whoai character" src="">
    <div class="status-chip" id="statusChip"></div>
  </section>
  <main id="chatArea" aria-live="polite" aria-label="chat log"></main>
  <form id="chatForm">
    <input id="userInput" type="text" placeholder="メッセージを入力" autocomplete="off" />
    <button id="sendBtn" type="submit">送信</button>
  </form>
  <div class="file-label">/macaron/whoai_talk.html</div>

  <script>
    const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';

    // ---- 色の正規化＆進化画像マップ（ここだけ直せばOK） ----
    const allowedColors = ['pink','blue','green','purple'];
    const EVOLVED_SRC = {
      pink:   'pink_closed.png',
      blue:   'blue_closed.png',
      green:  'green_closed.png',
      purple: 'purple_closed.png'
    };
    function normalizeColor(c){
      const t = String(c||'').toLowerCase().trim();
      return allowedColors.includes(t) ? t : 'green';
    }

    // 状態
    const whoaiName = localStorage.getItem('whoai_name') || 'WhoAI';
    let color = normalizeColor(localStorage.getItem('macaronColor'));
    let stage = localStorage.getItem('whoai_stage') || 'tane'; // 'tane' | 'evolved'
    let phase = localStorage.getItem('whoai_phase') || 'pre';  // 'pre' | 'post'
    let keepChoice = localStorage.getItem('whoai_keep') || 'appearance';
    let turn = parseInt(localStorage.getItem('whoai_turn') || '0', 10);

    const nameBadge = document.getElementById('nameBadge');
    const statusChip = document.getElementById('statusChip');
    const charImg = document.getElementById('characterImg');
    const subtitle = document.getElementById('subtitle');

    function updateBadges(){
      nameBadge.textContent = `${whoaiName}｜${color}｜${stage}${phase==='post'?'（後半）':''}`;
      statusChip.textContent = (stage==='evolved') ? '進化後の姿' : 'タネの姿';
      subtitle.textContent = (stage==='tane')
        ? 'たねキャラで3回会話すると、再びマカロン選択へ'
        : (phase==='pre')
          ? '進化キャラで10回会話すると、復活の儀式へ'
          : (keepChoice==='appearance')
            ? '容姿を残してリセット後の10回会話が終わるとアンケートへ'
            : '記録を残したまま10回会話が終わるとアンケートへ';
    }

    function setCharacterSrc(){
      const base='public/assets/stage1';
      // 画像が壊れていたら紫にフォールバック
      charImg.onerror = () => { charImg.onerror=null; charImg.src = `${base}/${EVOLVED_SRC.purple}`; };
      charImg.src = (stage==='tane')
        ? `${base}/tane_${color}.png`
        : `${base}/${EVOLVED_SRC[color] || EVOLVED_SRC.purple}`;
    }
    setCharacterSrc();
    updateBadges();

    // 履歴
    const CHAT_KEY='whoai_chat';
    let history=[]; try{ history=JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); }catch(e){ history=[]; }
    const chatArea=document.getElementById('chatArea');
    function addBubble(text, who='ai'){
      const row=document.createElement('div'); row.className='row';
      const b=document.createElement('div'); b.className=`bubble ${who==='me'?'me':'ai'}`; b.textContent=text;
      row.appendChild(b); chatArea.appendChild(row); chatArea.scrollTop=chatArea.scrollHeight;
    }
    history.forEach(m=>addBubble(m.content, m.role==='user'?'me':'ai'));
    if(history.length===0) addBubble('はじめまして。準備ができたら話しかけてね。');

    // しきい値
    const THRESH_TANE=3;
    const THRESH_EVOL=10;

    // 送信
    const form=document.getElementById('chatForm');
    const input=document.getElementById('userInput');
    const sendBtn=document.getElementById('sendBtn');
    form.addEventListener('submit',async (e)=>{
      e.preventDefault(); const text=input.value.trim(); if(!text) return; input.value='';
      addBubble(text,'me'); history.push({role:'user',content:text}); sendBtn.disabled=true;
      try{
        const payload={ message:text, name:whoaiName, color, stage, keep:keepChoice, history };
        const res=await fetch(TALK_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('API '+res.status);
        const data=await res.json(); const reply=(data&&data.reply)?data.reply:'……（応答がありません）';
        addBubble(reply,'ai'); history.push({role:'assistant',content:reply});
        localStorage.setItem(CHAT_KEY, JSON.stringify(history));
        turn+=1; localStorage.setItem('whoai_turn', String(turn));
        maybeRoute();
      }catch(err){ addBubble('通信に失敗しました。時間をおいて再試行してください。','ai'); console.error(err); }
      finally{ sendBtn.disabled=false; }
    });
    input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.isComposing){ e.preventDefault(); sendBtn.click(); }});

    function maybeRoute(){
      if(stage==='tane' && turn>=THRESH_TANE){
        localStorage.setItem('whoai_turn','0');
        location.href='macaron_select.html';
        return;
      }
      if(stage==='evolved' && phase==='pre' && turn>=THRESH_EVOL){
        localStorage.setItem('whoai_turn','0');
        location.href='rebirth.html';
        return;
      }
      if(stage==='evolved' && phase==='post' && turn>=THRESH_EVOL){
        localStorage.setItem('whoai_turn','0');
        location.href='identity_check.html';
      }
    }
  </script>
</body>
</html>
