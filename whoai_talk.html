<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk.html - 進化後の会話（10回で選択）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Noto Sans JP", sans-serif;
      background-image: url("public/assets/stage1/space_background.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      margin: 8px 0 6px;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    #characterImg {
      width: 140px;
      margin: 10px 0;
    }
    #chatArea {
      background: rgba(255,255,255,0.1);
      padding: 16px;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .msg {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background: rgba(0, 150, 255, 0.4);
      align-self: flex-end;
    }
    .assistant {
      background: rgba(255, 255, 255, 0.2);
      align-self: flex-start;
    }
    #inputArea {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 500px;
    }
    #userInput {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
    }
    button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #ffd1ec;
      color: #111;
      cursor: pointer;
    }
    button:hover {
      background: #ffbde0;
    }
  </style>
</head>
<body>
  <h2 id="title">会話</h2>
  <img id="characterImg" src="" alt="キャラクター" />
  <div id="chatArea"></div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="メッセージを入力..." />
    <button id="sendBtn">送信</button>
  </div>

  <script>
    // ===== マカロン色と意味・会話スタイル設定 =====
    const MACARON_PERSONA = {
      pink:   { name: "ピンク", meaning: "情熱", style: "テンポ速め。エネルギッシュで前向き。相手を励ます。感嘆符を時々。" },
      blue:   { name: "青", meaning: "静寂", style: "落ち着いた口調。短く丁寧。安心感を与える。改行を使って余白を作る。" },
      green:  { name: "緑", meaning: "元気", style: "明るくフレンドリー。相手の発言を要約→提案を1つ。顔文字は控えめに。" },
      purple: { name: "紫", meaning: "創造", style: "比喩や発想の飛躍を少し。問い返しを1つ入れる。言い切りすぎない。" }
    };

    const OPENING_LINES = {
      pink:   "熱、きたね！今の気持ち、ひとことで教えて？",
      blue:   "大丈夫。ゆっくりでいいよ。今日は何から話す？",
      green:  "元気チャージOK！やってみたいこと、ある？",
      purple: "ひらめきの種を1つ。今、心に浮かぶ色は？"
    };

    function getActiveColor(){
      const finalColor   = localStorage.getItem("finalColor");
      const evolvedColor = localStorage.getItem("evolvedColor");
      const choice = (()=>{ try{return JSON.parse(localStorage.getItem("macaron_choice")||"{}");}catch{return{}}})();
      return finalColor || evolvedColor || choice.macaron || "green";
    }

    // ===== 会話データ管理 =====
    let conversation = JSON.parse(localStorage.getItem("conversation") || "[]");
    let turnCount = parseInt(localStorage.getItem("turnCount") || "0");

    const chatArea = document.getElementById("chatArea");
    const inputEl = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const titleEl = document.getElementById("title");
    const charImg = document.getElementById("characterImg");

    function saveConversation(){
      localStorage.setItem("conversation", JSON.stringify(conversation));
      localStorage.setItem("turnCount", turnCount);
    }

    function renderMessage(msg){
      const div = document.createElement("div");
      div.className = `msg ${msg.role}`;
      div.textContent = msg.text;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function loadConversation(){
      conversation.forEach(renderMessage);
    }

    function initCharacter(){
      const imgPath = localStorage.getItem("characterImg") || "public/assets/stage1/tane.png";
      charImg.src = imgPath;
    }

    function decorateTitle(){
      const color = getActiveColor();
      const p = MACARON_PERSONA[color] || MACARON_PERSONA.green;
      titleEl.textContent = `会話（${p.name}：${p.meaning}）`;
    }

    function maybePostOpening(){
      if (conversation.length > 0) return;
      const color = getActiveColor();
      const line = OPENING_LINES[color] || OPENING_LINES.green;
      const aiMsg = { role: "assistant", text: line, ts: Date.now() };
      conversation.push(aiMsg);
      renderMessage(aiMsg);
      saveConversation();
    }

    // ===== AI返答処理 =====
    const API_URL = "https://your-server-domain/api/talk"; // ← サーバーURLに置き換え

    async function aiReply(userText){
      const color = getActiveColor();
      const persona = MACARON_PERSONA[color] || MACARON_PERSONA.green;

      const recent = conversation.slice(-6).map(m => ({
        role: m.role === "assistant" ? "assistant" : "user",
        content: m.text
      }));

      const systemPrompt =
        `あなたは優しい相棒AI。返答は日本語。最大50文字程度で簡潔に。
色テーマ: ${persona.name}（意味: ${persona.meaning}）
会話スタイル: ${persona.style}
相手の意図を尊重し、断定しすぎない。必要なら質問は1つまで。`;

      const payload = {
        messages: [
          { role: "system", content: systemPrompt },
          ...recent,
          { role: "user", content: userText }
        ]
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error(text); }
      if (!res.ok) throw new Error(data.error || text);
      return data.reply || "";
    }

    async function handleSend(){
      const userText = inputEl.value.trim();
      if (!userText) return;
      const userMsg = { role: "user", text: userText, ts: Date.now() };
      conversation.push(userMsg);
      renderMessage(userMsg);
      inputEl.value = "";

      turnCount++;
      saveConversation();

      // 10ターンごとにマカロンイベントへ
      if (turnCount >= 10){
        turnCount = 0;
        saveConversation();
        window.location.href = "macaron.html";
        return;
      }

      try {
        const reply = await aiReply(userText);
        const aiMsg = { role: "assistant", text: reply, ts: Date.now() };
        conversation.push(aiMsg);
        renderMessage(aiMsg);
        saveConversation();
      } catch (err){
        console.error(err);
        const aiMsg = { role: "assistant", text: "通信に失敗しました。", ts: Date.now() };
        conversation.push(aiMsg);
        renderMessage(aiMsg);
      }
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keypress", e => {
      if (e.key === "Enter") handleSend();
    });

    // ===== 初期化 =====
    initCharacter();
    decorateTitle();
    loadConversation();
    maybePostOpening();
  </script>
</body>
</html>
