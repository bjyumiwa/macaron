<!-- FILE: /macaron/whoai_talk.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI（タネ）— 会話</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,sans-serif;color:#fff;
      background:#000 url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:14px
    }
    .topbar{
      width:min(920px,96vw);display:flex;align-items:center;gap:8px;
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border-radius:14px;padding:8px 10px
    }
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12)}
    .stage{
      width:min(920px,96vw);display:grid;grid-template-columns:150px 1fr;gap:14px;
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);border-radius:16px;padding:14px
    }
    .avatar{display:flex;align-items:flex-start;justify-content:center}
    .avatar img{width:130px;height:auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,.45))}
    .chat{display:flex;flex-direction:column;gap:10px}
    .name{font-weight:800;opacity:.95}
    #chatArea{height:420px;overflow:auto;padding:12px;border-radius:12px;background:rgba(255,255,255,.1)}
    .msg{margin:8px 0;display:flex}
    .msg.user{justify-content:flex-end}
    .msg.assistant{justify-content:flex-start}
    .bubble{
      max-width:75%;padding:10px 12px;border-radius:12px;line-height:1.6;
      background:rgba(255,255,255,.12);white-space:pre-wrap;word-wrap:break-word
    }
    .msg.user .bubble{background:rgba(61,180,255,.22)}
    .msg.assistant .bubble{background:rgba(255,97,200,.22)}
    .role{display:block;font-size:12px;opacity:.8;margin-bottom:4px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type=text]{
      flex:1;padding:10px 12px;border-radius:10px;border:none;background:rgba(255,255,255,.95);color:#111;outline:none
    }
    button{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer;background:#ffd1ec;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .select{appearance:none;border:none;border-radius:10px;padding:9px 12px;background:rgba(255,255,255,.85);color:#111;font-weight:700}
    .mic{
      width:42px;height:42px;border-radius:10px;background:#ffd1ec;color:#111;display:inline-flex;align-items:center;justify-content:center;font-weight:900
    }
    .mic.rec{outline:2px solid #ff6ab9;box-shadow:0 0 0 4px rgba(255,106,185,.25) inset}
    .hint{font-size:12px;opacity:.85}
    @media (max-width:680px){ .stage{grid-template-columns:1fr}.avatar{order:2}.chat{order:1} }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="tag">FILE: /macaron/whoai_talk.html</span>
    <span class="tag" id="userTag">user:-</span>
    <span class="tag" id="convoTag">convo:-</span>
    <span class="tag">turn:<span id="turnTag">0</span>/3</span>
    <div style="flex:1"></div>
    <select id="langSel" class="select" title="Language">
      <option value="ja">日本語</option>
      <option value="en">English</option>
      <option value="zh">中文</option>
      <option value="ko">한국어</option>
    </select>
  </div>

  <div class="stage">
    <div class="avatar">
      <img id="characterImg" alt="tane">
    </div>
    <div class="chat">
      <div class="name">会話相手：<span id="assistantName">WhoAI</span>（タネ）</div>
      <div id="chatArea"></div>
      <div class="controls">
        <button id="micBtn" class="mic" title="音声入力（認識→自動送信）">🎤</button>
        <input id="userInput" type="text" placeholder="メッセージを入力…（Enterで送信）">
        <button id="sendBtn">送信</button>
      </div>
      <div class="hint">※ 直近12発言をAPIに同封し、会話は端末の <b>localStorage</b> に保存されます。音声入力はブラウザのWeb Speech APIを使用。</div>
    </div>
  </div>

  <script>
    // ================== 設定 ==================
    const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
    const WINDOW_N = 12;
    const MAX_TURNS = 3;                           // タネ期は3往復で進化
    const EVOLVE_URL = 'whoai_talk_evolved.html';  // 進化後へ
    const COLOR_TO_TANE = {
      pink:  'public/assets/stage1/tane_pink.png',
      blue:  'public/assets/stage1/tane_blue.png',
      green: 'public/assets/stage1/tane_green.png',
      purple:'public/assets/stage1/tane_purple.png'
    };
    const LANGS = {
      ja:{ label:'日本語', sr:'ja-JP',
        system:`あなたは優しい相棒AI「{name}」。短く親しみやすく、絵文字は控えめに。` },
      en:{ label:'English', sr:'en-US',
        system:`You are a kind companion AI named "{name}". Reply briefly and warmly.` },
      zh:{ label:'中文', sr:'zh-CN',
        system:`你是名为“{name}”的温柔聊天伙伴AI。请简短而温暖地回答。` },
      ko:{ label:'한국어', sr:'ko-KR',
        system:`당신은 "{name}"라는 따뜻한 동반자 AI입니다. 짧고 다정하게 답하세요.` }
    };

    // ============ localStorage & 基本情報 ============
    const getOrCreate = (k)=>{ const v=localStorage.getItem(k); if(v) return v; const nv=crypto.randomUUID(); localStorage.setItem(k,nv); return nv; };
    const userId = getOrCreate('whoai_userId');
    const convoId = getOrCreate('whoai_conversationId');  // タネ期用
    const key = (s)=>`whoai:${userId}:${convoId}:${s}`;
    const readLog = ()=>JSON.parse(localStorage.getItem(key('chatLog'))||'[]');
    const writeLog= (log)=>localStorage.setItem(key('chatLog'), JSON.stringify(log));

    const playerName = localStorage.getItem('whoai_player_name') || 'あなた';
    // ★ キーゆれ両対応：whoai_character_name / whoai_name
    const assistantName = localStorage.getItem('whoai_character_name') || localStorage.getItem('whoai_name') || 'WhoAI';
    const color = (localStorage.getItem('macaronColor')||'green').toLowerCase();
    const storedLang = localStorage.getItem('whoai_lang') || 'ja';

    // ============ UI 初期化 ============
    const $ = (id)=>document.getElementById(id);
    $('assistantName').textContent = assistantName;                           // ← ここで確実に反映
    $('userTag').textContent = `user: ${userId.slice(0,8)}`;
    $('convoTag').textContent = `convo: ${convoId.slice(0,8)}`;
    $('langSel').value = LANGS[storedLang] ? storedLang : 'ja';
    $('characterImg').src = COLOR_TO_TANE[color] || COLOR_TO_TANE.green;

    // ============ 描画 ============
    function render(){
      const area = $('chatArea');
      area.innerHTML = '';
      const log = readLog();
      let turn = 0;
      for(const m of log){
        const div = document.createElement('div');
        div.className = `msg ${m.role}`;
        const b = document.createElement('div');
        b.className = 'bubble';
        const r = document.createElement('span');
        r.className = 'role';
        r.textContent = (m.role==='user'? `${playerName}：` : `${assistantName}：`);
        b.appendChild(r);
        b.appendChild(document.createTextNode(m.content||''));
        div.appendChild(b);
        area.appendChild(div);
        if(m.role==='assistant') turn++; // 1往復カウント
      }
      $('turnTag').textContent = Math.min(turn, MAX_TURNS);
      area.scrollTop = area.scrollHeight;
    }
    render();

    // ============ 会話送信 ============
    async function send(text){
      if(!text) return;
      let log = readLog();
      log.push({role:'user', content:text, ts:Date.now()});
      writeLog(log); render();

      const lang = $('langSel').value;
      localStorage.setItem('whoai_lang', lang);
      const sys = LANGS[lang].system.replace('{name}', assistantName);
      const history = log.slice(-WINDOW_N).map(({role,content})=>({role,content}));

      $('sendBtn').disabled = true; $('userInput').disabled = true;
      let reply = '…';
      try{
        const res = await fetch(TALK_ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            userMessage: text,
            history,
            systemPrompt: sys,
            model: 'gpt-4o-mini',
            temperature: 0.7
          })
        });
        const data = await res.json().catch(()=>({}));
        reply = data.reply || data.message || data.content || '…';
      }catch(e){
        reply = '（通信エラー）';
        console.error(e);
      }
      $('sendBtn').disabled = false; $('userInput').disabled = false; $('userInput').focus();

      log = readLog();
      log.push({role:'assistant', content:reply, ts:Date.now()});
      writeLog(log); render();

      // ターン上限で進化へ（タネ期だけ）
      const assistantTurns = readLog().filter(m=>m.role==='assistant').length;
      if(assistantTurns >= MAX_TURNS){
        localStorage.setItem('whoai_stage','evolved');
        location.href = EVOLVE_URL;
      }
    }

    // ============ 入力イベント ============
    $('sendBtn').addEventListener('click', ()=>{
      const t = $('userInput').value.trim();
      if(!t) return;
      $('userInput').value = '';
      send(t);
    });
    $('userInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.isComposing){
        e.preventDefault();
        $('sendBtn').click();
      }
    });
    $('langSel').addEventListener('change', ()=>{
      localStorage.setItem('whoai_lang', $('langSel').value);
    });

    // ============ 音声入力（Web Speech API：認識→自動送信） ============
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let recActive = false;

    function setupRec(){
      if(!SR){ $('micBtn').disabled = true; $('micBtn').title = '音声入力に未対応のブラウザです'; return; }
      rec = new SR();
      rec.interimResults = false;
      rec.continuous = false;
      rec.lang = LANGS[$('langSel').value]?.sr || 'ja-JP';

      rec.onresult = (e)=>{
        const text = Array.from(e.results).map(r=>r[0].transcript).join('').trim();
        $('micBtn').classList.remove('rec');
        recActive = false;
        if(text){
          // 自動送信！
          $('userInput').value = '';
          send(text);
        }
      };
      rec.onend = ()=>{ recActive=false; $('micBtn').classList.remove('rec'); };
      rec.onerror = ()=>{ recActive=false; $('micBtn').classList.remove('rec'); };
    }
    setupRec();

    $('langSel').addEventListener('change', ()=>{
      if(rec){ try{rec.stop();}catch{} rec=null; }
      setupRec();
    });

    $('micBtn').addEventListener('click', ()=>{
      if(!rec) return;
      if(recActive){ try{rec.stop();}catch{} recActive=false; $('micBtn').classList.remove('rec'); return; }
      try{
        rec.lang = LANGS[$('langSel').value]?.sr || 'ja-JP';
        rec.start();
        recActive = true;
        $('micBtn').classList.add('rec');
      }catch(e){
        console.error(e);
        recActive=false;
        $('micBtn').classList.remove('rec');
      }
    });
  </script>
</body>
</html>
