<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - ä¼šè©±</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:1000;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);padding:8px 12px;border-radius:12px;font-weight:700;font-size:14px}
    header{margin-top:22px;text-align:center}
    header h1{margin:6px 0 4px;font-size:22px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    header p{margin:0;opacity:.9;font-size:13px}
    .character{margin:14px 0 8px;display:flex;flex-direction:column;align-items:center}
    .character img{width:160px;max-width:45vw;aspect-ratio:1/1;object-fit:contain;filter:drop-shadow(0 8px 30px rgba(0,0,0,.45));}
    .status-chip{margin-top:6px;font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.1)}
    #chatArea{width:min(680px,92vw);max-height:52vh;overflow-y:auto;padding:14px;border-radius:14px;background:rgba(0,0,0,.35);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .row{display:flex;flex-direction:column;gap:4px;margin:10px 0}
    .row.me{align-items:flex-end}.row.ai{align-items:flex-start}
    .label{font-size:12px;opacity:.8;background:rgba(255,255,255,.14);padding:3px 8px;border-radius:999px}
    .bubble{display:inline-block;padding:10px 12px;border-radius:12px;max-width:88%;line-height:1.5}
    .me .bubble{background:rgba(255,255,255,.15)} .ai .bubble{background:rgba(255,255,255,.08)}
    form{width:min(680px,92vw);display:flex;gap:8px;margin:14px 0 8px;flex-wrap:wrap;align-items:center}
    input[type="text"]{flex:1;min-width:240px;padding:12px 14px;border-radius:12px;border:none;outline:none;background:rgba(255,255,255,.12);color:#fff}
    button{padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    #sendBtn{background:#ffd1ec;color:#141217}
    #sendBtn:disabled{opacity:.7;cursor:not-allowed}
    .ctrls{display:flex;gap:8px;align-items:center}
    select{padding:10px 12px;border-radius:12px;border:none;background:rgba(255,255,255,.12);color:#fff}
    .mic{background:#65f;}.mic.on{background:#e8519e}
    .hint{font-size:12px;opacity:.8}
    .file-label{position:fixed;left:10px;bottom:10px;font-size:12px;opacity:.75}
  </style>
</head>
<body>
  <div class="whoai-name-badge" id="nameBadge">WhoAI</div>
  <header>
    <h1>ä¼šè©±</h1>
    <p id="subtitle">é€²è¡Œã«å¿œã˜ã¦è‡ªå‹•ã§æ¬¡ã®ç”»é¢ã¸é€²ã¿ã¾ã™</p>
  </header>
  <section class="character">
    <img id="characterImg" alt="whoai character" src="">
    <div class="status-chip" id="statusChip"></div>
  </section>

  <main id="chatArea" aria-live="polite" aria-label="chat log"></main>

  <!-- å…¥åŠ›ï¼‹éŸ³å£°UI -->
  <form id="chatForm">
    <input id="userInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆéŸ³å£°ã§ã‚‚OKï¼‰" autocomplete="off" />
    <div class="ctrls">
      <select id="langSelect" title="éŸ³å£°å…¥åŠ›è¨€èª">
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="en-US">English</option>
        <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
        <option value="ko-KR">í•œêµ­ì–´</option>
      </select>
      <button id="micBtn" type="button" class="mic" title="éŸ³å£°å…¥åŠ›">ğŸ¤ é–‹å§‹</button>
      <label class="hint"><input type="checkbox" id="autoSend" checked> è‡ªå‹•é€ä¿¡</label>
      <button id="sendBtn" type="submit">é€ä¿¡</button>
    </div>
  </form>

  <div class="file-label">/macaron/whoai_talk.html</div>

  <script>
    const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';

    /* ===== å£èª¿ï¼ˆè‰²ã”ã¨ã®äººæ ¼ï¼‰ ===== */
    const PERSONA = {
      pink:{name:'ä¸å¯§',suffix:['ã§ã™ã­ã€‚','ã§ã™ã€‚','ã§ã—ã‚‡ã†ã‹ã€‚','ã‹ã¨æ€ã„ã¾ã™ã€‚'],softeners:['å°‘ã€…','ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°','ã‚ˆã‚ã—ã‘ã‚Œã°','å¿µã®ãŸã‚'],preambles:['å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚','æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚','ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚']},
      green:{name:'ã‚„ã‚“ã¡ã‚ƒ',suffix:['ã ã‚ˆï¼','ã ã­ï¼','ã„ã“ï¼','ã£ã¦ã­ï¼'],softeners:['ã¾ã','ã¡ã‚‡ã„','ãŸã¶ã‚“','ãã£ã¨'],preambles:['ã‚ˆã£ï¼','ã¸ã¸ã£ï¼','ã‚„ã£ãŸï¼','ã„ãã‚ˆï¼']},
      blue:{name:'å¼•ã‘ç›®',suffix:['ã‹ã‚‚â€¦','ã‹ãªâ€¦','ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“â€¦','ã”ã‚ã‚“ã­â€¦'],softeners:['ã‚‚ã—','ãŸã¶ã‚“','ã‚‚ã—ã‹ã—ãŸã‚‰','ã‚ã®â€¦'],preambles:['ã™ã¿ã¾ã›ã‚“â€¦','è‡ªä¿¡ãªã„ã‘ã©â€¦','æ§ãˆã‚ã«è¨€ã†ã¨â€¦']},
      purple:{name:'å‰µé€ çš„',suffix:['ã¿ãŸã„ã€‚','ã£ã¦æ„Ÿã˜ã€‚','ãŒã²ã‚‰ã‚ã„ãŸã€‚','ãŒç”Ÿã¾ã‚Œã‚‹ã­ã€‚'],softeners:['ãµã£ã¨','ç›´æ„Ÿã§','ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§','æƒ³åƒã™ã‚‹ã¨'],preambles:['ã²ã‚‰ã‚ãï¼','ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã¿ã¦ã€‚','ç©ºæƒ³ã ã‘ã©â€¦']}
    };
    function stylizeByColor(text, color) {
      const p = PERSONA[color] || PERSONA.green;
      let t = String(text || '').trim();
      if (Math.random() < 0.15 && p.preambles.length) t = p.preambles[Math.floor(Math.random()*p.preambles.length)] + ' ' + t;
      t = t.replace(/ã€/g, () => (Math.random()<0.25 && p.softeners.length) ? 'ã€'+p.softeners[Math.floor(Math.random()*p.softeners.length)]+'ã€' : 'ã€');
      if (!/[ã€‚ï¼ï¼Ÿ!]$/.test(t)) t += p.suffix[Math.floor(Math.random()*p.suffix.length)];
      return t;
    }

    /* ===== çŠ¶æ…‹ãƒ»ãƒãƒƒã‚¸ ===== */
    const allowedColors=['pink','blue','green','purple'];
    const EVOLVED_SRC = {pink:'pink_closed.png',blue:'blue_closed.png',green:'green_closed.png',purple:'purple_closed.png'};
    const norm = c => allowedColors.includes(String(c||'').toLowerCase().trim()) ? String(c).toLowerCase().trim() : 'green';

    const whoaiName = localStorage.getItem('whoai_name') || 'WhoAI';
    let color = norm(localStorage.getItem('macaronColor'));
    let stage = localStorage.getItem('whoai_stage') || 'tane';
    let phase = localStorage.getItem('whoai_phase') || 'pre';
    let keepChoice = localStorage.getItem('whoai_keep') || 'appearance';
    let turn = parseInt(localStorage.getItem('whoai_turn') || '0', 10);

    const nameBadge = document.getElementById('nameBadge');
    const statusChip = document.getElementById('statusChip');
    const charImg = document.getElementById('characterImg');
    const subtitle = document.getElementById('subtitle');
    function updateBadges(){
      nameBadge.textContent = `${whoaiName}ï½œ${color}ï½œ${stage}${phase==='post'?'ï¼ˆå¾ŒåŠï¼‰':''}`;
      statusChip.textContent = (stage==='evolved') ? 'é€²åŒ–å¾Œã®å§¿' : 'ã‚¿ãƒã®å§¿';
      subtitle.textContent = (stage==='tane')
        ? 'ãŸã­ã‚­ãƒ£ãƒ©ã§3å›ä¼šè©±ã™ã‚‹ã¨ã€å†ã³ãƒã‚«ãƒ­ãƒ³é¸æŠã¸'
        : (phase==='pre') ? 'é€²åŒ–ã‚­ãƒ£ãƒ©ã§10å›ä¼šè©±ã™ã‚‹ã¨ã€å¾©æ´»ã®å„€å¼ã¸'
        : (keepChoice==='appearance') ? 'å®¹å§¿ã‚’æ®‹ã—ã¦ãƒªã‚»ãƒƒãƒˆå¾Œã®10å›ä¼šè©±ã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸'
        : 'è¨˜éŒ²ã‚’æ®‹ã—ãŸã¾ã¾10å›ä¼šè©±ã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸';
    }
    function setCharacterSrc(){
      const base='public/assets/stage1';
      charImg.onerror = () => { charImg.onerror=null; charImg.src = `${base}/${EVOLVED_SRC.purple}`; };
      charImg.src = (stage==='tane') ? `${base}/tane_${color}.png` : `${base}/${EVOLVED_SRC[color]||EVOLVED_SRC.purple}`;
    }
    setCharacterSrc(); updateBadges();

    /* ===== ãƒãƒ£ãƒƒãƒˆæç”»ï¼ˆè©±è€…ãƒ©ãƒ™ãƒ«ä»˜ãï¼‰ ===== */
    const CHAT_KEY='whoai_chat';
    let history=[]; try{ history=JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); }catch(e){ history=[]; }
    const chatArea=document.getElementById('chatArea');
    function speakerLabel(who){ return who==='me' ? 'ã‚ãªãŸï¼š' : `${whoaiName}ï¼š`; }
    function addBubble(text, who='ai'){
      const row=document.createElement('div'); row.className=`row ${who==='me'?'me':'ai'}`;
      const label=document.createElement('div'); label.className='label'; label.textContent=speakerLabel(who);
      const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
      row.appendChild(label); row.appendChild(b); chatArea.appendChild(row); chatArea.scrollTop=chatArea.scrollHeight;
    }
    history.forEach(m=>addBubble(m.content, m.role==='user'?'me':'ai'));
    if(history.length===0) addBubble('ã¯ã˜ã‚ã¾ã—ã¦ã€‚æº–å‚™ãŒã§ããŸã‚‰è©±ã—ã‹ã‘ã¦ã­ã€‚','ai');

    /* ===== é€ä¿¡å‡¦ç† ===== */
    const form=document.getElementById('chatForm');
    const input=document.getElementById('userInput');
    const sendBtn=document.getElementById('sendBtn');
    form.addEventListener('submit',handleSend);

    async function handleSend(e){
      e && e.preventDefault();
      const text=input.value.trim(); if(!text) return; input.value='';
      addBubble(text,'me'); history.push({role:'user',content:text}); sendBtn.disabled=true;
      try{
        const personaHint={ color, style:(PERSONA[color]?.name||'default'),
          guide:{pink:'ä¸å¯§ã«æ•¬èª',green:'ã‚„ã‚“ã¡ã‚ƒã§ç •ã‘ãŸå£èª¿',blue:'æ§ãˆã‚ã§ã‚„ã•ã—ã',purple:'å‰µé€ çš„ã§æ¯”å–©å¤šã‚'}[color]};
        const payload={ message:text, name:whoaiName, color, stage, keep:keepChoice, history, persona:personaHint };
        const res=await fetch(TALK_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('API '+res.status);
        const data=await res.json();
        const reply = stylizeByColor((data&&data.reply)||'â€¦â€¦ï¼ˆå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰', color);
        addBubble(reply,'ai'); history.push({role:'assistant',content:reply});
        localStorage.setItem(CHAT_KEY, JSON.stringify(history));
        turn+=1; localStorage.setItem('whoai_turn', String(turn)); maybeRoute();
      }catch(err){ addBubble('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚','ai'); console.error(err); }
      finally{ sendBtn.disabled=false; }
    }

    /* ===== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ===== */
    const THRESH_TANE=3, THRESH_EVOL=10;
    function maybeRoute(){
      if(stage==='tane' && turn>=THRESH_TANE){ localStorage.setItem('whoai_turn','0'); location.href='macaron_select.html'; return; }
      if(stage==='evolved' && phase==='pre' && turn>=THRESH_EVOL){ localStorage.setItem('whoai_turn','0'); location.href='rebirth.html'; return; }
      if(stage==='evolved' && phase==='post' && turn>=THRESH_EVOL){ localStorage.setItem('whoai_turn','0'); location.href='identity_check.html'; }
    }

    /* ===== éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech APIï¼‰ ===== */
    const langSelect = document.getElementById('langSelect');
    const micBtn = document.getElementById('micBtn');
    const autoSend = document.getElementById('autoSend');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening=false;

    function ensureRecognizer(){
      if(!SpeechRecognition){ alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChrome æ¨å¥¨ï¼‰'); return null; }
      if(rec) return rec;
      rec = new SpeechRecognition();
      rec.interimResults = true;
      rec.maxAlternatives = 1;
      rec.continuous = false; // ä¸€æ—¦ä¸€ç™ºèªè­˜
      rec.onstart = ()=>{ listening=true; micBtn.classList.add('on'); micBtn.textContent='ğŸ›‘ åœæ­¢'; };
      rec.onend   = ()=>{ listening=false; micBtn.classList.remove('on'); micBtn.textContent='ğŸ¤ é–‹å§‹'; };
      rec.onerror = (e)=>{ console.warn(e); listening=false; micBtn.classList.remove('on'); micBtn.textContent='ğŸ¤ é–‹å§‹'; };
      rec.onresult = (e)=>{
        let finalText = '';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const trans = e.results[i][0].transcript;
          if(e.results[i].isFinal){ finalText += trans; }
          else { input.value = trans; } // é€”ä¸­çµŒéã‚’è¡¨ç¤º
        }
        if(finalText){
          input.value = finalText;
          if(autoSend.checked){ handleSend(); }
        }
      };
      return rec;
    }

    micBtn.addEventListener('click', ()=>{
      const r = ensureRecognizer(); if(!r) return;
      if(listening){ r.stop(); return; }
      r.lang = langSelect.value || 'ja-JP';
      r.start();
    });

    // Enterã§é€ä¿¡ï¼ˆIMEå¤‰æ›ä¸­ã¯é€ã‚‰ãªã„ï¼‰
    input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.isComposing){ e.preventDefault(); handleSend(e); }});
  </script>
</body>
</html>
