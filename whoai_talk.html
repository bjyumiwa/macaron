<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk - 会話（10回で次へ）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,Arial,sans-serif;
      color:#fff;background:#000;
      /* GitHub Pages配下でも効くよう先頭に ./ を明示 */
      background-image:url("./public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    .scrim{position:fixed;inset:0;background:rgba(0,0,0,.68);backdrop-filter:blur(1.5px);z-index:0}
    .whoai-name-badge{position:fixed;top:10px;right:10px;z-index:3;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:12px;font-weight:700}
    .meta{font-size:.8rem;opacity:.85}
    .wrap{position:relative;z-index:1;margin-top:70px;width:min(860px,92vw);display:grid;grid-template-columns:140px 1fr;gap:16px}
    @media (max-width:700px){.wrap{grid-template-columns:1fr}}
    .char-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:14px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .char-img{width:120px;height:120px;object-fit:contain;display:block;margin:6px auto 2px}
    .chat{background:rgba(17,17,22,.55);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:16px;min-height:440px;max-height:60vh;overflow:auto}
    .bubble{max-width:86%;margin:8px 0;padding:10px 12px;border-radius:14px;line-height:1.6;text-shadow:0 1px 2px rgba(0,0,0,.55)}
    .me{background:rgba(255,255,255,.12);margin-left:auto;border-top-right-radius:6px}
    .ai{background:rgba(255,255,255,.08);margin-right:auto;border-top-left-radius:6px}
    .count{margin-top:8px;font-size:.9rem;opacity:.9;display:flex;gap:8px;align-items:center}
    .input-row{margin-top:12px;display:flex;gap:8px;align-items:center}
    .input-row input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.45);color:#fff;outline:none}
    .btn{padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:#ffd1ec;color:#171717}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .cta{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .notice{margin-top:8px;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);font-size:.95rem}
  </style>
</head>
<body>
  <div class="scrim"></div>

  <div class="whoai-name-badge">
    WhoAI: <span id="whoaiName">あなた</span>
    <div class="meta">会話 <span id="turnNow">0</span>/<span id="turnMax">10</span></div>
  </div>

  <div class="wrap">
    <aside class="side">
      <div class="char-card">
        <img id="charImg" class="char-img" src="" alt="character" />
        <div id="charLabel">tane</div>
        <div class="meta">color: <span id="colorTag">pink</span></div>
      </div>
    </aside>

    <main>
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="count">
        <div>会話回数：<strong id="turnText">0/10</strong></div>
        <div id="phaseText" class="meta"></div>
      </div>
      <div class="input-row">
        <input id="userInput" type="text" placeholder="メッセージを入力…" />
        <button id="sendBtn" class="btn btn-primary">送信</button>
        <button id="resetBtn" class="btn btn-ghost" title="このページの記録を消去">記録リセット</button>
      </div>

      <div id="afterLimit" style="display:none">
        <div class="notice" id="limitMsg"></div>
        <div class="cta">
          <a id="ctaBtn" class="btn btn-primary">次へ進む</a>
          <button id="stayBtn" class="btn btn-ghost">このまま見る</button>
        </div>
      </div>
    </main>
  </div>

  <script>
  // ===== 設定 =====
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const MAX_TURNS = 10;
  const URL_EVOLVE  = './macaron/macaron.html';
  const URL_REBIRTH = './macaron/rebirth.html';
  const V = 'v=20250815'; // キャッシュバスター

  // ===== 互換キーを吸収 =====
  const getAny = (...keys)=> {
    for(const k of keys){
      const v = localStorage.getItem(k);
      if(v && v !== 'undefined' && v !== 'null') return v;
    }
    return null;
  };

  const name  = getAny('whoai_name','player_name') || 'あなた';
  const color = (getAny('whoai_color','selectedColor','macaron_color') || 'pink').toLowerCase();
  const stage = (getAny('whoai_stage','stage','whoai_phase') || 'tane').toLowerCase();

  let turn = Number(getAny('whoai_turn')) || 0;
  let log = [];
  try { log = JSON.parse(getAny('whoai_log') || '[]'); } catch(e){ log=[]; }

  // ===== 画像パス生成（確実に ./ 始まり & キャッシュバスター）=====
  function charImagePath(color, stage){
    const safe = ['pink','blue','green','purple'].includes(color) ? color : 'pink';
    const p = (stage === 'evolved')
      ? `./public/assets/evolved/${safe}_open.png`
      : `./public/assets/stage1/${safe}_closed.png`;
    return `${p}?${V}`;
  }

  // ===== UI 要素 =====
  const whoaiName = document.getElementById('whoaiName');
  const turnNow = document.getElementById('turnNow');
  const turnMax = document.getElementById('turnMax');
  const charImg = document.getElementById('charImg');
  const charLabel = document.getElementById('charLabel');
  const colorTag = document.getElementById('colorTag');
  const chatEl = document.getElementById('chat');
  const turnText = document.getElementById('turnText');
  const phaseText = document.getElementById('phaseText');
  const inputEl = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const resetBtn = document.getElementById('resetBtn');
  const afterLimit = document.getElementById('afterLimit');
  const ctaBtn = document.getElementById('ctaBtn');
  const stayBtn = document.getElementById('stayBtn');
  const limitMsg = document.getElementById('limitMsg');

  // 初期描画
  whoaiName.textContent = name;
  turnMax.textContent = MAX_TURNS;
  colorTag.textContent = color;
  charLabel.textContent = stage;
  charImg.src = charImagePath(color, stage);
  charImg.alt = `${stage}-${color}`;
  charImg.onerror = ()=>{ charImg.src = `./public/assets/stage1/${color}_closed.png?${V}`; };

  const renderBubble = (role,text)=>{
    const div = document.createElement('div');
    div.className = `bubble ${role==='user'?'me':'ai'}`;
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  };

  log.forEach(m=>renderBubble(m.role,m.content));

  const updateTurnUI = ()=>{
    turnNow.textContent = turn;
    turnText.textContent = `${turn}/${MAX_TURNS}`;
    phaseText.textContent = stage==='tane'
      ? '（最初の10回：終わると “進化” へ）'
      : '（進化後の10回：終わると “復活の儀式” へ）';
  };
  updateTurnUI();

  const lockIfLimitReached = ()=>{
    if(turn >= MAX_TURNS){
      inputEl.disabled = true; sendBtn.disabled = true;
      afterLimit.style.display = '';
      const nextUrl = (stage==='tane') ? URL_EVOLVE : URL_REBIRTH;
      ctaBtn.setAttribute('href', nextUrl + (nextUrl.includes('?')?'&':'?') + V);
      limitMsg.textContent = (stage==='tane')
        ? '10回の会話が終わりました。マカロンを選んで進化しよう。'
        : '10回の会話が終わりました。復活の儀式へ進みましょう。';
      return true;
    }
    return false;
  };

  // ★ロード時点で10回超なら即ロック
  lockIfLimitReached();

  async function send(){
    const text = (inputEl.value||'').trim();
    if(!text || turn >= MAX_TURNS) return;

    renderBubble('user', text);
    log.push({role:'user',content:text});

    let reply = '';
    try{
      const res = await fetch(TALK_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:text,name,color,stage,turn})
      });
      const data = res.ok ? await res.json() : {};
      reply = data.reply || data.message || 'うん、続けよう！';
    }catch{ reply = '（接続が不安定みたい）でも大丈夫。続けよう！'; }

    renderBubble('assistant', reply);
    log.push({role:'assistant',content:reply});

    turn += 1;
    localStorage.setItem('whoai_turn', String(turn));
    localStorage.setItem('whoai_log', JSON.stringify(log));
    // 互換キーにも書いておく
    localStorage.setItem('selectedColor', color);
    localStorage.setItem('stage', stage);

    updateTurnUI();
    lockIfLimitReached();
    inputEl.value = ''; inputEl.focus();
  }

  document.getElementById('sendBtn').addEventListener('click', send);
  document.getElementById('userInput').addEventListener('keydown', e => { if(e.key==='Enter') send(); });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(!confirm('このページの会話ログと回数カウントを削除します。')) return;
    localStorage.removeItem('whoai_turn');
    localStorage.removeItem('whoai_log');
    turn = 0; log = [];
    chatEl.innerHTML = '';
    updateTurnUI();
    inputEl.disabled = false; sendBtn.disabled = false;
    afterLimit.style.display = 'none';
    inputEl.focus();
  });

  document.getElementById('stayBtn').addEventListener('click', ()=>{ afterLimit.style.display='none'; });

  // 最後に標準キーへ保存（無い場合の初期化）
  localStorage.setItem('whoai_name', name);
  localStorage.setItem('whoai_color', color);
  localStorage.setItem('whoai_stage', stage);
  </script>
</body>
</html>
