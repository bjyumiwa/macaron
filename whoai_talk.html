<!-- FILE: STEP10 - whoai_talk.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI - 復活後の会話（10回）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%; margin: 0; font-family: "Noto Sans JP", sans-serif;
      background: black;
      background-image: url("public/assets/stage1/space_background.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white; text-align: center;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px;
    }
    #characterImg {
      width: 140px;
      margin-bottom: 16px;
    }
    #chatArea {
      background: rgba(255,255,255,0.08);
      padding: 16px;
      border-radius: 12px;
      width: 90%; max-width: 600px;
      height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 80%;
      padding: 10px;
      border: none;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #ffd1ec;
      color: #111;
      margin-left: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <img id="characterImg" src="" alt="AIキャラ" />
  <div class="whoai-name-badge" style="position: fixed; top: 10px; right: 10px;">
    <strong id="charName">WhoAI</strong>
  </div>

  <div id="chatArea"></div>

  <form id="chatForm">
    <input type="text" id="userInput" placeholder="話しかけてみよう" autocomplete="off" required />
    <button type="submit">送信</button>
  </form>

  <script>
    const TALK_ENDPOINT = "https://macaron-one.vercel.app/api/talk";
    const userName = localStorage.getItem("username") || "あなた";
    const charName = document.getElementById("charName");
    const img = document.getElementById("characterImg");
    const chatArea = document.getElementById("chatArea");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("userInput");
    let turnCount = 0;
    const MAX_TURNS = 10;

    // キャラ画像の読み込み（記録 or 容姿 によって分岐）
    const color = localStorage.getItem("selectedColor");
    const isMemoryKept = localStorage.getItem("keepMemory") === "true";

    if (isMemoryKept) {
      img.src = `public/assets/stage1/evolved_${color}.gif`;
    } else {
      img.src = `public/assets/stage1/tane_${color}.png`;
      localStorage.removeItem("whoai_chat"); // 容姿選択時はログ初期化
    }

    const name = localStorage.getItem("username") || "WhoAI";
    charName.textContent = name;

    const log = JSON.parse(localStorage.getItem("whoai_chat") || "[]");

    const appendMessage = (speaker, text) => {
      const msg = document.createElement("div");
      msg.innerHTML = `<strong>${speaker}:</strong> ${text}`;
      chatArea.appendChild(msg);
      chatArea.scrollTop = chatArea.scrollHeight;
    };

    // 過去ログ表示
    log.forEach(({ role, content }) => {
      appendMessage(role === "user" ? userName : name, content);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userText = input.value.trim();
      if (!userText) return;
      input.value = "";
      appendMessage(userName, userText);
      log.push({ role: "user", content: userText });

      const res = await fetch(TALK_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: log })
      });
      const data = await res.json();
      const aiText = data.result;
      appendMessage(name, aiText);
      log.push({ role: "assistant", content: aiText });

      localStorage.setItem("whoai_chat", JSON.stringify(log));

      turnCount++;
      if (turnCount >= MAX_TURNS) {
        window.location.href = "identity_check.html"; // STEP11へ
      }
    });
  </script>
</body>
</html>
