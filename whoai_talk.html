<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhoAI トーク</title>
<style>
  :root{ --glass: rgba(255,255,255,.08); --ring: rgba(255,255,255,.22); --accent:#ffd1ec; }
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",sans-serif;color:#fff;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
  }
  header{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:4px}
  #characterImg{width:140px;height:140px;object-fit:contain;filter: drop-shadow(0 8px 16px rgba(0,0,0,.5));}
  h2{margin:0;text-shadow:0 0 8px rgba(0,0,0,.5)}
  .chat{
    width:min(820px,95vw);min-height:320px;max-height:52vh;overflow-y:auto;
    background:var(--glass);border-radius:16px;padding:14px;border:1px solid var(--ring)
  }
  .msg{display:flex;margin:8px 0}
  .msg.user{justify-content:flex-start}
  .msg.ai{justify-content:flex-end}
  .bubble{
    max-width:72%;padding:10px 14px;border-radius:14px;backdrop-filter: blur(3px);
    background:rgba(255,255,255,.12);border:1px solid var(--ring)
  }
  .msg.ai .bubble{background:rgba(0,0,0,.28)}
  .composer{display:flex;gap:8px;width:min(820px,95vw)}
  .composer input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--ring);background:rgba(0,0,0,.25);color:#fff
  }
  .composer button{padding:10px 16px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
  .send{background:var(--accent);color:#222}
  .toolbar{display:flex;gap:8px;width:min(820px,95vw)}
  .ghost{background:#444;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  .primary{background:var(--accent);color:#222;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  footer{opacity:.85}
</style>
</head>
<body>
  <header>
    <img id="characterImg" src="" alt="キャラクター">
    <h2 id="title">会話（選択色に応じてキャラが変わります）</h2>
  </header>

  <main class="chat" id="chatArea" aria-live="polite"></main>

  <div class="composer">
    <input id="input" type="text" placeholder="メッセージを入力してね（Enterで送信）" />
    <button class="send" id="sendBtn">送信</button>
  </div>

  <div class="toolbar">
    <button class="ghost" id="saveBtn">手動保存</button>
    <button class="ghost" id="clearBtn">会話を消去</button>
    <button class="ghost" id="backBtn">マカロン選びに戻る</button>
    <button class="primary" id="nextBtn">次へ（同一性の選択へ）</button>
  </div>

  <footer>会話は <code>localStorage("conversation")</code> に自動保存・復元されます。</footer>

<script>
  // === 画像は public/assets/stage1 配下に配置する前提 ===
  const ASSETS_BASE = "public/assets/stage1";

  // 色→キャラ画像マップ（ピンク対応）
  const CHAR_MAP = {
    red:    `${ASSETS_BASE}/character_red.png`,
    blue:   `${ASSETS_BASE}/character_blue.png`,
    green:  `${ASSETS_BASE}/character_green.png`,
    purple: `${ASSETS_BASE}/character_purple.png`,
    pink:   `${ASSETS_BASE}/character_pink.png`
  };
  const DEFAULT_CHAR = `${ASSETS_BASE}/character_default.png`;

  // ===== DOM =====
  const chatArea = document.getElementById("chatArea");
  const inputEl  = document.getElementById("input");
  const sendBtn  = document.getElementById("sendBtn");
  const saveBtn  = document.getElementById("saveBtn");
  const clearBtn = document.getElementById("clearBtn");
  const backBtn  = document.getElementById("backBtn");
  const nextBtn  = document.getElementById("nextBtn");
  const charImg  = document.getElementById("characterImg");
  const titleEl
