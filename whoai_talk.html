<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>whoai_talk - ä¼šè©±ï¼ˆtaneâ†’10å›ã§é€²åŒ–ï¼é€²åŒ–å¾Œ10å›ã§å¾©æ´»ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("./public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
    }
    /* å³ä¸Šãƒãƒƒã‚¸ */
    .whoai-name-badge{
      position:fixed;top:10px;right:10px;z-index:1000;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700;color:#fff;display:flex;align-items:center;
    }
    #whoaiBadgeFace{width:36px;height:36px;margin-right:8px;border-radius:8px}

    /* ä¸­å¤®ã‚­ãƒ£ãƒ© */
    .whoai-sprite{
      position:fixed;left:50%;top:38%;transform:translate(-50%,-50%);
      width:180px;height:180px;display:flex;align-items:center;justify-content:center;
      z-index:30;pointer-events:none;animation:float 3s ease-in-out infinite;
      filter:drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .whoai-sprite img{max-width:100%;max-height:100%}
    @keyframes float{0%{transform:translate(-50%,-50%)}50%{transform:translate(-50%,-54%)}100%{transform:translate(-50%,-50%)}}
    @media (max-width: 640px){ .whoai-sprite{ top:34%; width:160px; height:160px; } }

    /* Chat */
    .whoai-chatdock{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);width:min(920px,92vw);z-index:900}
    .whoai-log{max-height:38vh;overflow:auto;padding:12px 14px;margin-bottom:8px;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.28);font-size:14px;line-height:1.5}
    .whoai-msg{display:flex;gap:8px;margin:6px 0}
    .whoai-msg.me{justify-content:flex-end}
    .whoai-bubble{padding:8px 12px;border-radius:12px;max-width:72%;background:rgba(255,255,255,.12)}
    .whoai-msg.me .whoai-bubble{background:rgba(255,209,236,.16)}
    .whoai-inputrow{display:flex;gap:8px;align-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:10px;border-radius:14px}
    .whoai-inputrow input{flex:1;height:42px;border:none;border-radius:10px;padding:0 12px;font-size:16px;outline:none;background:rgba(255,255,255,.86)}
    .whoai-inputrow button{height:42px;padding:0 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700;background:#ffd1ec;color:#222}

    /* Macaron Modal */
    .macaron-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200}
    .macaron-card{width:min(960px,96vw);background:rgba(0,0,0,.55);color:#fff;border-radius:22px;padding:24px 20px;box-shadow:0 20px 48px rgba(0,0,0,.35)}
    .macaron-title{font-size:28px;font-weight:800;text-align:center;margin:6px 0 8px}
    .macaron-sub{opacity:.9;text-align:center;margin-bottom:18px}
    .macaron-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:10px auto 18px;max-width:840px}
    .m-item{background:rgba(255,255,255,.08);border-radius:18px;padding:14px;text-align:center;cursor:pointer;border:2px solid transparent}
    .m-item.selected{border-color:#ffd1ec;box-shadow:0 0 0 4px rgba(255,209,236,.25) inset}
    .m-item img{width:96px;height:96px;object-fit:contain;display:block;margin:6px auto 10px}
    .m-actions{display:flex;gap:10px;justify-content:center}
    .m-btn{padding:10px 16px;border:none;border-radius:12px;font-weight:700;cursor:pointer}
    .m-cancel{background:#555;color:#fff}.m-commit{background:#ffd1ec;color:#222}
  </style>
</head>
<body>

  <!-- ä¸­å¤®ã‚­ãƒ£ãƒ© -->
  <div id="whoaiSprite" class="whoai-sprite" aria-hidden="true">
    <img id="whoaiSpriteImg" alt="character">
  </div>

  <!-- å³ä¸Šãƒãƒƒã‚¸ -->
  <div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
    <img id="whoaiBadgeFace" alt="">
    <span id="whoaiBadgeText"></span>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆ -->
  <div class="whoai-chatdock" id="whoaiChatDock" aria-live="polite">
    <div class="whoai-log" id="whoaiLog"></div>
    <div class="whoai-inputrow">
      <input id="whoaiInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ Enter / é€ä¿¡" />
      <button id="whoaiSend">é€ä¿¡</button>
    </div>
  </div>

  <!-- é€²åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="macaronModal" class="macaron-modal" aria-modal="true" role="dialog">
    <div class="macaron-card">
      <div class="macaron-title">ãƒã‚«ãƒ­ãƒ³ã‚’é¸ã¶</div>
      <div class="macaron-sub">è‰²ã‚’å¤‰ãˆã¦ã‚‚é€²åŒ–çŠ¶æ…‹ã¯ç¶­æŒã—ã¾ã™ï¼ˆè¦‹ãŸç›®ã ã‘å¤‰ã‚ã‚Šã¾ã™ï¼‰ã€‚</div>
      <div class="macaron-grid" id="mGrid"></div>
      <div class="m-actions">
        <button class="m-btn m-cancel" id="mCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="m-btn m-commit" id="mCommit" disabled>é€²åŒ–ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
  /* ===== util ===== */
  function lsGet(k,d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return localStorage.getItem(k) ?? d } }
  function lsSet(k,v){ localStorage.setItem(k, typeof v==="string"? v : JSON.stringify(v)); }

  /* ===== ã—ãã„å€¤ï¼†ã‚­ãƒ¼ ===== */
  const TURN_FOR_EVOLVE = 10;   // ã‚¿ãƒ10å›ã§é€²åŒ–
  const TURN_FOR_REBIRTH = 10;  // é€²åŒ–å¾Œ10å›ã§å¾©æ´»
  const K_TOTAL = 'whoai_turns_total';      // ç ”ç©¶ç”¨ã®é€šç®—
  const K_TANE  = 'whoai_since_tane';       // ã‚¿ãƒå°‚ç”¨ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ0â†’10ï¼‰
  const K_SINCE = 'whoai_since_evolve';     // é€²åŒ–å¾Œã‚«ã‚¦ãƒ³ãƒˆï¼ˆ0â†’10ï¼‰
  const REBIRTH_URL = (location.pathname.includes('/macaron/')) ? 'rebirth.html' : '/macaron/rebirth.html';

  /* ===== è¦‹ãŸç›®ï¼ˆtane / evolvedï¼‰ ===== */
  (function(){
    const pickedRaw = lsGet('selectedMacaron') || lsGet('whoai_selectedMacaron') || 'green';
    const color = ['pink','blue','green','purple'].includes(pickedRaw) ? pickedRaw : 'green';
    let appearance = lsGet('whoai_appearance','tane');   // 'tane' or 'evolved'

    const badge   = document.getElementById('whoaiNameBadge');
    const face    = document.getElementById('whoaiBadgeFace');
    const nameEl  = document.getElementById('whoaiBadgeText');
    const sprite  = document.getElementById('whoaiSpriteImg');

    nameEl.textContent = `ğŸª„ ${lsGet('characterName','ãªã¾ãˆæœªè¨­å®š')}`;
    badge.style.display = 'flex';

    function setOnce(imgEl, paths){
      const list = paths.filter(Boolean); let i=0;
      const tryNext=()=>{ if(i>=list.length) return; const t=new Image();
        t.onload=()=>{ imgEl.src=t.src; }; t.onerror=()=>{ i++; tryNext(); }; t.src=list[i]; };
      tryNext();
    }

    let blinkTimer=null; function clearBlink(){ if(blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; } }

    function showTane(c){
      clearBlink();
      const candidates = [
        `./public/assets/stage1/tane_${c}.png`,
        `./tane_${c}.png`,
        (c==='purple') ? './tane_purplo.png' : null,
        './public/assets/stage1/tane_green.png',
        './tane_green.png'
      ];
      setOnce(face,   candidates);
      setOnce(sprite, candidates);
    }

    function showEvolved(c){
      clearBlink();
      const openList  = [`./public/assets/stage1/${c}_open.png`, `./${c}_open.png`];
      const closeList = [`./public/assets/stage1/${c}_closed.png`, `./${c}_closed.png`];
      setOnce(face, openList);  setOnce(sprite, openList);
      let isOpen=true;
      blinkTimer = setInterval(()=>{
        isOpen=!isOpen;
        const list = isOpen ? openList : closeList;
        setOnce(face, list); setOnce(sprite, list);
      }, 1200);
    }

    if(appearance==='evolved'){ showEvolved(color); } else { showTane(color); }

    // é€²åŒ–ç¢ºå®šï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œé€²åŒ–ã™ã‚‹ã€ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    window.whoaiApplyEvolution = function(newColor){
      const c = newColor || color;
      lsSet('selectedMacaron', c);
      lsSet('whoai_selectedMacaron', c);
      lsSet('whoai_appearance', 'evolved');  // é€²åŒ–ãƒ•ãƒ©ã‚°
      appearance='evolved';
      showEvolved(c);
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å†è¡¨ç¤ºã—ãªã„
      lsSet('whoai_modal_shown', true);
      // ã‚«ã‚¦ãƒ³ã‚¿åˆ‡æ›¿ï¼šã‚¿ãƒã®å½¹ç›®çµ‚äº†ï¼é€²åŒ–å¾Œã¯0ã‹ã‚‰
      lsSet(K_TANE, 0);
      lsSet(K_SINCE, 0);
    };
  })();

  /* ===== ãƒãƒ£ãƒƒãƒˆï¼ˆAPIå‘¼ã³å‡ºã—ï¼†ã‚«ã‚¦ãƒ³ãƒˆï¼‰ ===== */
  (function(){
    const ENDPOINT = window.TALK_ENDPOINT || 'https://macaron-one.vercel.app/api/talk';
    const sessionId = localStorage.getItem('whoai_session_id') || crypto.randomUUID();
    localStorage.setItem('whoai_session_id', sessionId);

    const logEl = document.getElementById('whoaiLog');
    const inputEl = document.getElementById('whoaiInput');
    const sendBtn = document.getElementById('whoaiSend');

    // ãƒ¬ã‚¬ã‚·ãƒ¼ã‚­ãƒ¼æƒé™¤ï¼ˆæ—§å®Ÿè£…ãŒæ®‹ã£ã¦ã„ãŸã‚‰èª¤ä½œå‹•ã™ã‚‹ãŸã‚ï¼‰
    localStorage.removeItem('whoai_turns');

    // ç¾åœ¨å€¤èª­ã¿è¾¼ã¿
    let total = Number(localStorage.getItem(K_TOTAL) || 0);
    let tane  = Number(localStorage.getItem(K_TANE)  || 0);
    let since = Number(localStorage.getItem(K_SINCE) || 0);

    const appearance = lsGet('whoai_appearance','tane');
    let modalShown = !!lsGet('whoai_modal_shown', false);

    // é€²åŒ–æ¸ˆãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†åº¦å‡ºã•ãªã„
    if (appearance === 'evolved' && !modalShown) {
      modalShown = true; lsSet('whoai_modal_shown', true);
    }

    function addLine(side, text){
      const wrap = document.createElement('div');
      wrap.className = `whoai-msg ${side}`;
      const bubble = document.createElement('div');
      bubble.className = 'whoai-bubble';
      bubble.textContent = text;
      wrap.appendChild(bubble);
      logEl.appendChild(wrap);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function send(){
      const text = inputEl.value.trim();
      if(!text) return;
      inputEl.value = '';
      addLine('me', text);

      try{
        sendBtn.disabled = true;
        const res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text, sessionId })
        });
        if(!res.ok){ addLine('bot', `ï¼ˆã‚¨ãƒ©ãƒ¼: ${res.status}ï¼‰ã‚µãƒ¼ãƒã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ`); return; }
        const data = await res.json();
        const reply = data.reply || data.message || data.text || '[è¿”ä¿¡ãªã—]';
        addLine('bot', reply);
      }catch(err){
        addLine('bot', 'ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„');
      }finally{
        sendBtn.disabled = false;
        inputEl.focus();
        incTurns();
      }
    }
    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

    if(!sessionStorage.getItem('whoai_welcome_shown')){
      const greet = (appearance==='evolved')
        ? 'ã“ã‚“ã«ã¡ã¯ï¼é€²åŒ–ã—ãŸ whoai ã ã‚ˆã€‚ç¶šã‘ã¦è©±ãã†ï¼'
        : 'ã“ã‚“ã«ã¡ã¯ï¼ãƒã‚«ãƒ­ãƒ³è‰²ã® tane ã ã‚ˆã€‚ãªã‚“ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ã€‚';
      addLine('bot', greet);
      sessionStorage.setItem('whoai_welcome_shown','1');
    }

    // ==== ä¼šè©±ã‚«ã‚¦ãƒ³ãƒˆ ====
    function incTurns(){
      const isEvolved = lsGet('whoai_appearance','tane') === 'evolved';

      // é€šç®—ã¯ç ”ç©¶ç”¨ã«å¸¸ã«åŠ ç®—
      total += 1; lsSet(K_TOTAL, total);

      if (!isEvolved) {
        // ã‚¿ãƒï¼š0â†’10ã§æ•°ãˆã€ã¡ã‚‡ã†ã©10ã§ãƒ¢ãƒ¼ãƒ€ãƒ«
        tane = (Number(localStorage.getItem(K_TANE)) || 0) + 1;
        if (tane > TURN_FOR_EVOLVE) tane = TURN_FOR_EVOLVE; // 10ã§å›ºå®š
        lsSet(K_TANE, tane);

        if (!modalShown && tane === TURN_FOR_EVOLVE){
          modalShown = true; lsSet('whoai_modal_shown', true); openModal();
        }
        return;
      }

      // é€²åŒ–å¾Œï¼š0â†’10ã§æ•°ãˆã€ã¡ã‚‡ã†ã©10ã§å¾©æ´»ã¸
      since = (Number(localStorage.getItem(K_SINCE)) || 0) + 1;
      if (since > TURN_FOR_REBIRTH) since = TURN_FOR_REBIRTH; // 10ã§å›ºå®š
      lsSet(K_SINCE, since);

      if (since === TURN_FOR_REBIRTH) {
        location.href = REBIRTH_URL;
      }
    }
    window.incTurns = incTurns;
  })();

  /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè‰²é¸æŠâ†’é€²åŒ–ï¼‰ ===== */
  (function(){
    const modal=document.getElementById('macaronModal');
    const grid =document.getElementById('mGrid');
    const cancel=document.getElementById('mCancel');
    const commit=document.getElementById('mCommit');

    const OPTIONS=[
      {key:'pink',   label:'ãƒ”ãƒ³ã‚¯',  img:'./public/assets/stage1/macaron_pink.png'},
      {key:'blue',   label:'ãƒ–ãƒ«ãƒ¼',  img:'./public/assets/stage1/macaron_blue.png'},
      {key:'green',  label:'ã‚°ãƒªãƒ¼ãƒ³',img:'./public/assets/stage1/macaron_green.png'},
      {key:'purple', label:'ãƒ‘ãƒ¼ãƒ—ãƒ«',img:'./public/assets/stage1/macaron_purple.png'},
    ];
    let selected=null;

    function build(){
      grid.innerHTML='';
      OPTIONS.forEach(opt=>{
        const el=document.createElement('div'); el.className='m-item'; el.dataset.key=opt.key;
        el.innerHTML=`<img src="${opt.img}" alt="${opt.label}"><div>${opt.label}</div>`;
        el.onclick=()=>{
          document.querySelectorAll('.m-item').forEach(i=>i.classList.remove('selected'));
          el.classList.add('selected'); selected=opt; commit.disabled=false;
        };
        grid.appendChild(el);
      });
    }

    // ãƒ€ãƒ–ãƒ«ã‚¬ãƒ¼ãƒ‰ï¼šé€²åŒ–æ¸ˆã¿ or æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰é–‹ã‹ãªã„
    window.openModal = function(){
      if (lsGet('whoai_appearance','tane') === 'evolved') return;
      if (lsGet('whoai_modal_shown', false)) return;
      build(); modal.style.display='flex';
      lsSet('whoai_modal_shown', true);
    }
    function closeModal(){ modal.style.display='none'; }

    commit.onclick=()=>{
      if(!selected) return;
      window.whoaiApplyEvolution(selected.key);
      closeModal();
    };
    cancel.onclick=closeModal;

    // Alt+M ã§æ‰‹å‹•é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    window.addEventListener('keydown',(e)=>{ if(e.altKey && (e.key==='m' || e.key==='M')) window.openModal(); });
  })();
  </script>
</body>
</html>
