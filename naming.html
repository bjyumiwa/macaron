<!-- FILE: /macaron/naming.html  → 画像が出ない対策（存在チェック＋フォールバック）完全版 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - 名前をつける</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;
      background:#faf7fb; /* ライト背景固定 */
      color:#222; display:flex; align-items:center; justify-content:center;
      text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
    }

    .wrap{ width:min(720px,96vw); padding:28px; }

    .card{
      background:#fff; border-radius:18px; padding:26px 22px; box-shadow:0 12px 40px rgba(0,0,0,.07);
      text-align:center;
    }
    h1{ margin:0 0 10px; font-size:22px; color:#222 }
    p{ margin:0 0 18px; opacity:.85; font-size:14px }

    .character{ margin:16px 0 }
    .character img{ width:160px; max-width:50vw; display:block; margin:auto }

    .row{ display:flex; gap:10px; align-items:center; justify-content:center; }
    .grow{ flex:1 }

    input[type="text"]{
      width:100%; padding:12px 14px; border:1px solid #e6e2ee; border-radius:12px; font-size:16px;
      background:#fcfbfe; outline:none;
    }
    input[type="text"]:focus{ border-color:#bfa7ff; box-shadow:0 0 0 3px rgba(111,76,255,.12) }

    .btn{ padding:12px 16px; border:0; border-radius:12px; font-weight:700; cursor:pointer }
    .primary{ background:#6f4cff; color:#fff }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .mini-note{ font-size:12px; opacity:.7; margin-top:10px }

    .file-label{ position:fixed; left:10px; bottom:10px; font-size:12px; opacity:.7 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">この子に名前をつけてね</h1>
      <p id="desc">あとで変更できます。入力したら「決定！」を押してね。</p>

      <div class="character">
        <img id="taneImg" src="" alt="たねキャラ">
      </div>

      <div class="row">
        <div class="grow"><input id="nameInput" type="text" placeholder="WhoAIの名前を入力" maxlength="24" autofocus></div>
        <button id="goBtn" class="btn primary" type="button">決定！</button>
      </div>
      <div class="mini-note" id="note">※ 入力が空のときは「WhoAI」になります</div>
    </div>
  </div>

  <div class="file-label">/macaron/naming.html</div>

  <script>
    // ========= 画像ロード：存在チェックして最初に読めたものを表示 =========
    (function resolveCharacter(){
      const color = (localStorage.getItem('macaronColor') || 'green').toLowerCase();
      const base  = 'public/assets/stage1';
      const candidates = [
        `${base}/${color}_closed.png`,   // green_closed.png 等（よく使う）
        `${base}/tane_${color}.png`,     // tane_green.png 等（もしあれば）
        `${base}/${color}.png`,          // green.png 等
        `${base}/pink_closed.png`,       // 最終フォールバック①（在庫率高）
        `${base}/blue_closed.png`        // 最終フォールバック②
      ];

      const imgEl = document.getElementById('taneImg');

      function tryNext(i){
        if(i >= candidates.length){
          console.warn('キャラ画像が見つかりませんでした');
          imgEl.removeAttribute('src');
          return;
        }
        const src = candidates[i];
        const probe = new Image();
        probe.onload = ()=>{ imgEl.src = src; };
        probe.onerror = ()=>{ tryNext(i+1); };
        probe.src = src + `?v=${Date.now()}`; // キャッシュ対策
      }
      tryNext(0);
    })();

    // ========= 名前を保存 → macaron.html へ =========
    const NAME_KEY = 'whoai_name';
    const DEFAULT_NAME = 'WhoAI';

    document.getElementById('goBtn').addEventListener('click', saveAndGo);
    document.getElementById('nameInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.isComposing){ e.preventDefault(); saveAndGo(); }
    });

    function saveAndGo(){
      const v = (document.getElementById('nameInput').value || '').trim();
      const name = v || DEFAULT_NAME;
      localStorage.setItem(NAME_KEY, name);
      localStorage.setItem('whoai_stage','tane');
      location.href = 'macaron.html';
    }

    const existing = localStorage.getItem(NAME_KEY);
    if(existing){ document.getElementById('nameInput').value = existing; }
  </script>
</body>
</html>
