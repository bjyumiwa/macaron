<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>evolution.html - ãƒã‚«ãƒ­ãƒ³é€²åŒ–ï¼†ä¼šè©±ï¼ˆå®Œå…¨ç‰ˆãƒ»ãƒ‡ãƒãƒƒã‚°ä»˜ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:#fff;
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
    }
    .page-tag{position:fixed;right:8px;bottom:8px;opacity:.7;font-size:12px}
    h1{margin:8px 0 4px;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .subtitle{opacity:.9;margin-bottom:8px}
    .wrap{width:min(820px,94vw)}
    .panel{background:rgba(255,255,255,.12);backdrop-filter:blur(2px);border-radius:16px;padding:14px;margin-top:8px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    #characterImg{width:150px;height:150px;object-fit:contain;filter:drop-shadow(0 4px 14px rgba(0,0,0,.6))}
    #macaronImg{width:130px;height:130px;object-fit:contain;cursor:pointer;transition:transform .15s ease}
    #macaronImg:hover{transform:scale(1.06)}
    .hint{font-size:12px;opacity:.85}
    #chatArea{height:360px;overflow-y:auto;padding:10px;border-radius:12px;background:rgba(0,0,0,.28)}
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.5}
    .user{background:rgba(135,206,250,.85);align-self:flex-end;color:#081018}
    .bot{background:rgba(255,255,255,.78);color:#101018}
    .sys{background:rgba(186,85,211,.65);color:#fff;font-size:12px}
    .col{display:flex;flex-direction:column}
    .input-row{display:flex;gap:8px;margin-top:10px}
    input[type="text"]{flex:1;border-radius:10px;border:none;padding:12px 12px;outline:none}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn{background:#ffd1ec;color:#111}
    .btn:hover{filter:brightness(1.05)}
    .choice-area{display:none;gap:10px;justify-content:center;margin-top:8px}
    .choice{background:#fff;color:#111}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.35);font-size:12px;margin-left:6px}
    .grid2{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:start}
    .small{font-size:12px;opacity:.85}

    /* ãƒ‡ãƒãƒƒã‚°ãƒœãƒƒã‚¯ã‚¹ */
    details.debug{width:min(820px,94vw)}
    details.debug summary{cursor:pointer;opacity:.9}
    .dbg{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
         font-size:12px;white-space:pre-wrap;background:rgba(0,0,0,.35);
         padding:10px;border-radius:10px;margin-top:6px}
    .ok{color:#b7ffb7}.ng{color:#ffd1d1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">ä¼šè©±ï¼ˆ<span id="colorTitle">æœªé¸æŠ</span>ï¼‰<span class="badge" id="stageBadge">tane</span></h1>
    <div class="subtitle small">â€» ãƒã‚«ãƒ­ãƒ³ã¯æ¯å›ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºã€‚é¸ã¶ã¨è‰²ã¨æ€§æ ¼ãŒå›ºå®šã•ã‚Œã¾ã™ã€‚</div>

    <!-- ä¸Šéƒ¨ï¼šã‚­ãƒ£ãƒ©ï¼†ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚«ãƒ­ãƒ³ -->
    <div class="panel grid2">
      <div class="col" style="align-items:center">
        <img id="characterImg" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
        <div class="small" id="charCaption">ã‚¿ãƒï¼ˆæœªé¸æŠï¼‰</div>
      </div>
      <div class="col">
        <div class="row">
          <img id="macaronImg" alt="ãƒã‚«ãƒ­ãƒ³">
        </div>
        <div class="hint">â†‘ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è‰²ã‚’ã€Œé¸æŠã€ã—ã¾ã™ã€‚<br>ï¼ˆpink=æƒ…ç†± / blue=é™å¯‚ / green=å…ƒæ°— / purple=å‰µé€ ï¼‰</div>
      </div>
    </div>

    <!-- ä¼šè©± -->
    <div class="panel">
      <div id="chatArea" class="col"></div>
      <div class="input-row">
        <input id="msgInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" />
        <button class="btn" id="sendBtn">é€ä¿¡</button>
        <button class="btn" id="evolveBtn" title="10ã‚¿ãƒ¼ãƒ³ã‚’è¶…ãˆã‚‹ã¨æœ‰åŠ¹">é€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆ</button>
      </div>
      <div class="choice-area" id="choiceArea">
        <button class="choice" id="memoryBtn">è¨˜æ†¶ã‚’é¸ã¶ï¼ˆè¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆï¼‰</button>
        <button class="choice" id="appearanceBtn">å®¹å§¿ã‚’é¸ã¶ï¼ˆè¦‹ãŸç›®å›ºå®šï¼‰</button>
      </div>
      <div class="small" style="margin-top:6px">
        ä¼šè©±ã¨çŠ¶æ…‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® <code>localStorage</code> ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã“ã®PCã®ã¿ï¼‰ã€‚  
        <button id="resetBtn" class="choice" style="margin-left:6px">çŠ¶æ…‹ã‚’åˆæœŸåŒ–</button>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒãƒƒã‚°ï¼ˆè§£æ±ºã—ãŸå®Ÿãƒ‘ã‚¹ã‚’è¡¨ç¤ºï¼‰ -->
  <details class="debug">
    <summary>ğŸ›  ç”»åƒãƒ‘ã‚¹ãƒ‡ãƒãƒƒã‚°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>
    <div class="dbg" id="dbgBox">åˆæœŸåŒ–ä¸­â€¦</div>
  </details>

  <div class="page-tag" id="pageTag"></div>

<script>
/* =========================
   ãƒšãƒ¼ã‚¸åãƒ©ãƒ™ãƒ«
   ========================= */
document.getElementById('pageTag').textContent =
  (location.pathname.split('/').pop() || 'index.html');

/* =========================
   è‡ªå‹•ãƒ‘ã‚¹è§£æ±ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================= */
// æ¢ç´¢ã™ã‚‹ãƒ«ãƒ¼ãƒˆå€™è£œï¼ˆä¸Šã‹ã‚‰é †ã«è©¦ã™ï¼‰
const ROOT_CANDIDATES = [
  '.',               // evolution.html ã¨åŒéšå±¤
  './assets',
  '../assets',
  'assets',
  './public/assets',
  'public/assets'
];
// è¨±å®¹æ‹¡å¼µå­
const EXT_CANDIDATES = ['png','webp','jpg','jpeg'];

// æˆåŠŸ/å¤±æ•—ãƒ­ã‚°ï¼ˆãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºç”¨ï¼‰
const dbg = [];
function logOK(msg){ dbg.push(`âœ… ${msg}`); }
function logNG(msg){ dbg.push(`âŒ ${msg}`); }
function flushDbg(){ document.getElementById('dbgBox').textContent = dbg.join('\n'); }

function tryLoadImage(url) {
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(url);
    img.onerror = ()=> reject(url);
    img.src = url + `?v=${Date.now()}`; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
  });
}

/** ä¾‹: resolveAsset('characters/peakuru_tane') â†’ æœ€åˆã«è¦‹ã¤ã‹ã£ãŸURL */
async function resolveAsset(relativeWithoutExt){
  for (const root of ROOT_CANDIDATES){
    for (const ext of EXT_CANDIDATES){
      const url = `${root}/${relativeWithoutExt}.${ext}`;
      try {
        await tryLoadImage(url);
        logOK(`found: ${url}`);
        return url;
      } catch {
        logNG(`miss : ${url}`);
      }
    }
  }
  throw new Error(`Asset not found: ${relativeWithoutExt}`);
}

/* =========================
   çŠ¶æ…‹ãƒ»å®šæ•°
   ========================= */
const KEY = 'whoaiState';
const COLORS = ['pink','blue','green','purple']; // èµ¤ã¯ç„¡ã—
const COLOR_META = {
  pink:   { label:'æƒ…ç†±' },
  blue:   { label:'é™å¯‚' },
  green:  { label:'å…ƒæ°—' },
  purple: { label:'å‰µé€ ' }
};

function loadState(){
  try { return JSON.parse(localStorage.getItem(KEY)) || {}; }
  catch { return {}; }
}
function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

/* =========================
   UI å‚ç…§
   ========================= */
const characterImg = document.getElementById('characterImg');
const charCaption  = document.getElementById('charCaption');
const macaronImg   = document.getElementById('macaronImg');
const chatArea     = document.getElementById('chatArea');
const msgInput     = document.getElementById('msgInput');
const sendBtn      = document.getElementById('sendBtn');
const evolveBtn    = document.getElementById('evolveBtn');
const choiceArea   = document.getElementById('choiceArea');
const memoryBtn    = document.getElementById('memoryBtn');
const appearanceBtn= document.getElementById('appearanceBtn');
const colorTitle   = document.getElementById('colorTitle');
const stageBadge   = document.getElementById('stageBadge');

/* =========================
   è¡¨ç¤ºæ›´æ–°
   ========================= */
async function setBackground(){
  try {
    const bg = await resolveAsset('stage1/space_background');
    document.body.style.backgroundImage = `url("${bg}")`;
  } catch(e){
    logNG(e.message + 'ï¼ˆèƒŒæ™¯ï¼‰');
  }
  flushDbg();
}

async function applyColor(color){
  if(!color || !COLOR_META[color]){
    try{
      characterImg.src = await resolveAsset('characters/peakuru_tane');
    }catch(e){
      logNG(e.message + 'ï¼ˆtaneï¼‰');
      characterImg.removeAttribute('src');
      characterImg.alt = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆtaneï¼‰';
    }
    charCaption.textContent = 'ã‚¿ãƒï¼ˆæœªé¸æŠï¼‰';
    colorTitle.textContent = 'æœªé¸æŠ';
    flushDbg();
    return;
  }
  try{
    characterImg.src = await resolveAsset(`characters/peakuru_${color}`);
  }catch(e){
    logNG(e.message + `ï¼ˆ${color}ï¼‰`);
    characterImg.removeAttribute('src');
    characterImg.alt = `ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${color}ï¼‰`;
  }
  const meta = COLOR_META[color];
  charCaption.textContent = `ãƒ”ãƒ¼ã‚¯ã‚‹ï¼ˆ${meta.label}ï¼‰`;
  colorTitle.textContent = `${meta.label}ãƒ»${color}`;
  flushDbg();
}

function setStage(stage){ stageBadge.textContent = stage || 'tane'; }

async function showRandomMacaron(){
  const color = COLORS[Math.floor(Math.random()*COLORS.length)];
  try {
    macaronImg.src = await resolveAsset(`macarons/${color}`);
  } catch(e){
    logNG(e.message + `ï¼ˆmacaron:${color}ï¼‰`);
    macaronImg.removeAttribute('src');
    macaronImg.alt = `ãƒã‚«ãƒ­ãƒ³ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;
  }
  macaronImg.alt = `ãƒã‚«ãƒ­ãƒ³ (${color})`;
  macaronImg.dataset.color = color;
  flushDbg();
}

function renderLogs(logs){
  chatArea.innerHTML = '';
  (logs||[]).forEach(addBubble);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function addBubble(item){
  const div = document.createElement('div');
  div.className = `bubble ${item.role==='user'?'user':item.role==='bot'?'bot':'sys'}`;
  div.textContent = item.text;
  chatArea.appendChild(div);
}

/* =========================
   ä¼šè©±ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“BOTï¼‰
   ========================= */
function botReply(userText, color){
  const tone = {
    pink:   ['æƒ…ç†±ãŒæ¹§ã„ã¦ãã‚‹ã­ï¼','ã‚ãã‚ãã™ã‚‹ï¼','ãã®å‹¢ã„ã€æœ€é«˜ï¼'],
    blue:   ['è½ã¡ç€ã„ã¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚','æ¾„ã‚“ã è¦–ç‚¹ã ã­ã€‚','é™ã‹ã«æ·±ã‚ã¦ã„ã“ã†ã€‚'],
    green:  ['å…ƒæ°—ã§ã„ã“ã†ï¼','ã‚ˆã—ã€ã‚„ã£ã¦ã¿ã‚ˆã†ï¼','ãƒ‘ãƒ¯ãƒ¼å‡ºã¦ããŸï¼'],
    purple: ['ã²ã‚‰ã‚ããŒæ¥ãŸã‹ã‚‚ã€‚','ç™ºæƒ³ã‚’åºƒã’ã‚ˆã†ã€‚','å‰µé€ ã®æ™‚é–“ã ã­ã€‚']
  };
  const list = tone[color] || ['ã†ã‚“ã€ãªã‚‹ã»ã©ã€‚','ã‚ã‹ã£ãŸã‚ˆï¼','ã„ã„ã­ï¼'];
  const pick = list[Math.floor(Math.random()*list.length)];
  if(/ã‚¢ã‚¤(ãƒ³|ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³|ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³)/.test(userText)) {
    return 'ã¯ã„ã€ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³ã¯æœ‰åãªç‰©ç†å­¦è€…ã§ã™ã­ã€‚ç›¸å¯¾æ€§ç†è«–ã§çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚';
    }
  if(/ã“ã‚“ã«ã¡ã¯|ã“ã‚“ã¡ã¯|ã¯ã‚|hello/i.test(userText)) {
    return 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚‹ï¼Ÿ';
  }
  return `${pick}ã€Œ${userText}ã€ã®ç¶šãã€ã‚‚ã†å°‘ã—æ•™ãˆã¦ï¼`;
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆ
   ========================= */
macaronImg.addEventListener('click', ()=>{
  const color = macaronImg.dataset.color;
  const st = loadState();
  st.color = color;           // é¸æŠå¾Œã¯å›ºå®š
  st.stage = 'evolved';
  st.logs = st.logs || [];
  st.logs.push({role:'sys', text:`ãƒã‚«ãƒ­ãƒ³ï¼ˆ${color}ï¼‰ã‚’é¸æŠã€‚æ€§æ ¼ãŒå›ºå®šã•ã‚Œã¾ã—ãŸã€‚`});
  saveState(st);
  applyColor(st.color);
  setStage(st.stage);
  renderLogs(st.logs);
});

sendBtn.addEventListener('click', ()=>{
  const text = msgInput.value.trim();
  if(!text) return;
  const st = loadState();
  st.logs = st.logs || [];
  st.logs.push({role:'user', text});
  const reply = botReply(text, st.color);
  st.logs.push({role:'bot', text: reply});
  saveState(st);
  addBubble({role:'user', text});
  addBubble({role:'bot', text: reply});
  msgInput.value = '';
  chatArea.scrollTop = chatArea.scrollHeight;

  const turnCount = st.logs.filter(l=>l.role==='user').length;
  evolveBtn.style.opacity = (turnCount>=10)?'1':'0.5';
});

msgInput.addEventListener('keydown', e=>{
  if(e.key==='Enter') sendBtn.click();
});

evolveBtn.addEventListener('click', ()=>{
  const st = loadState();
  const turns = (st.logs||[]).filter(l=>l.role==='user').length;
  if(turns<10){
    st.logs = st.logs || [];
    st.logs.push({role:'sys', text:`é€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã¨${10-turns}ã‚¿ãƒ¼ãƒ³å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚`});
    saveState(st); addBubble(st.logs[st.logs.length-1]); chatArea.scrollTop=chatArea.scrollHeight; 
    return;
  }
  choiceArea.style.display = 'flex';
});

memoryBtn.addEventListener('click', async ()=>{
  const st = loadState();
  st.logs = st.logs || [];
  st.logs.push({role:'sys', text:'ãƒªãƒãƒ¼ã‚¹ï¼šè¨˜æ†¶ã‚’é¸æŠã€‚è¦‹ãŸç›®ã¯ã‚¿ãƒã«æˆ»ã‚Šã¾ã™ã€‚'});
  delete st.color;     // â˜…è‰²ã‚’æ¶ˆã™â†’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»£å…¥ã—ãªã„
  st.stage = 'tane';
  saveState(st);
  await applyColor(st.color);
  setStage(st.stage);
  renderLogs(st.logs);
  showRandomMacaron();           // æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã¯å†ã³ãƒ©ãƒ³ãƒ€ãƒ 
  choiceArea.style.display = 'none';
});

appearanceBtn.addEventListener('click', async ()=>{
  const st = loadState();
  st.logs = st.logs || [];
  st.logs.push({role:'sys', text:'ãƒªãƒãƒ¼ã‚¹ï¼šå®¹å§¿ã‚’é¸æŠã€‚è¦‹ãŸç›®ã¯ãã®ã¾ã¾ç¶­æŒã—ã¾ã™ã€‚'});
  st.stage = 'final';
  saveState(st);
  await applyColor(st.color);
  setStage(st.stage);
  renderLogs(st.logs);
  if(st.color){
    try{ macaronImg.src = await resolveAsset(`macarons/${st.color}`); }catch{}
    macaronImg.dataset.color = st.color;
  }
  choiceArea.style.display = 'none';
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(!confirm('ä¿å­˜ã•ã‚ŒãŸä¼šè©±ã¨çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem(KEY);
  init(); // å†åˆæœŸåŒ–
});

/* =========================
   åˆæœŸåŒ–
   ========================= */
async function init(){
  dbg.length = 0; flushDbg();
  await setBackground();
  const st = loadState();
  await applyColor(st.color);                 // â˜…å‹æ‰‹ã«ç·‘ã«ã—ãªã„
  setStage(st.stage || 'tane');
  renderLogs(st.logs || []);
  if(st.color){
    try{ macaronImg.src = await resolveAsset(`macarons/${st.color}`); }catch(e){ logNG(e.message); }
    macaronImg.dataset.color = st.color;
  }else{
    showRandomMacaron();
  }
  const turnCount = (st.logs||[]).filter(l=>l.role==='user').length;
  evolveBtn.style.opacity = (turnCount>=10)?'1':'0.5';
  flushDbg();
}

init();
</script>
</body>
</html>
