<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>evolution.html - ãƒã‚«ãƒ­ãƒ³é€²åŒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Noto Sans JP", sans-serif;
      background-image: url("assets/stage1/space_background.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      text-align: center;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    h2 {
      margin-bottom: 24px;
      font-size: 1.8em;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    .macaron-holder {
      width: 140px;
      height: 140px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 16px;
    }
    .macaron-img {
      width: 120px;
      height: auto;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
      transition: transform 0.2s;
    }
    .macaron-img:hover {
      transform: scale(1.05);
    }
    .message {
      margin-top: 16px;
      font-size: 1.2em;
      min-height: 1.4em;
    }
    .growth-summary {
      margin-top: 24px;
      background: rgba(255,255,255,0.4);
      color: #222;
      padding: 16px;
      border-radius: 12px;
      max-width: 90%;
      text-align: left;
      display: none;
    }
    .growth-summary h3 {
      margin-top: 0;
    }
    .growth-summary ul {
      margin: 8px 0 0 16px;
      padding: 0;
    }
    .growth-summary li {
      margin-bottom: 4px;
      list-style: disc inside;
    }
    #nextStageBtn {
      margin-top: 32px;
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      background: #ffd1ec;
      color: #111;
      cursor: pointer;
      display: none;
      transition: background 0.3s, color 0.3s;
    }
    #nextStageBtn:hover {
      background: #ff70c1;
      color: white;
    }
    @media screen and (max-width: 480px) {
      .macaron-holder {
        width: 100px;
        height: 100px;
      }
      .macaron-img {
        width: 80px;
      }
      #nextStageBtn {
        font-size: 16px;
        padding: 10px 20px;
      }
    }
  </style>
</head>

<body>
  <h2>ãƒã‚«ãƒ­ãƒ³ã‚’é£Ÿã¹ã¦é€²åŒ–ã—ã‚ˆã†ï¼</h2>

  <!-- ãƒ©ãƒ³ãƒ€ãƒ ã« 1 æšã®ãƒã‚«ãƒ­ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹æ  -->
  <div class="macaron-holder" id="macaronHolder"></div>

  <!-- é£Ÿã¹ãŸã¨ãã ã‘ä¸€æ™‚çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div class="message" id="message"></div>

  <!-- ã“ã‚Œã¾ã§é£Ÿã¹ãŸãƒã‚«ãƒ­ãƒ³ã®è‰²ã«ã‚ˆã‚‹æˆé•·ã‚µãƒãƒªãƒ¼ -->
  <div class="growth-summary" id="growthSummary"></div>

  <!-- ã™ã¹ã¦ï¼ˆã¾ãŸã¯ï¼“å›ï¼‰é£Ÿã¹çµ‚ãˆãŸã‚‰ã“ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
  <button id="nextStageBtn" onclick="goToRebirth()">å¾©æ´»ã®å„€å¼ã¸ â–¶</button>

  <script>
   // lang ã‚’å–å¾—ã—ãŸç›´å¾Œã€å®šæ•°å®šç¾©ã‚¨ãƒªã‚¢ã®ä¸Šã®ã»ã†
const lang = localStorage.getItem("lang") || "ja";
    
 // ğŸŒ ã‚¿ã‚¤ãƒˆãƒ«ã®è¨€èªåˆ‡ã‚Šæ›¿ãˆ
document.title = lang === "en"
  ? "evolution.html - Macaron Evolution"
  : "evolution.html - ãƒã‚«ãƒ­ãƒ³é€²åŒ–";   

// ğŸ¯ colorNames ã¯ã“ã“ã«è¿½åŠ ï¼
const colorNames = {
  pink:   lang === "en" ? "pink"   : "ãƒ”ãƒ³ã‚¯",
  green:  lang === "en" ? "green"  : "ã‚°ãƒªãƒ¼ãƒ³",
  blue:   lang === "en" ? "blue"   : "ãƒ–ãƒ«ãƒ¼",
  purple: lang === "en" ? "purple" : "ãƒ‘ãƒ¼ãƒ—ãƒ«"
};

// ãã®ä¸‹ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ growthMessages ãªã©ãŒç¶šãã¾ã™
const growthMessages = {
  pink:   lang === "en" ? "ğŸ©· You nurtured empathy and compassion." : "ğŸ©· æ€ã„ã‚„ã‚Šãƒ»å…±æ„Ÿã®åŠ›ãŒè‚²ã¡ã¾ã—ãŸ",
  green:  lang === "en" ? "ğŸ’š You developed initiative and action." : "ğŸ’š è‡ªåˆ†ã‹ã‚‰å‹•ãåŠ›ãŒå‡ºã¦ãã¾ã—ãŸ",
  blue:   lang === "en" ? "ğŸ’™ Your thinking and awareness grew."    : "ğŸ’™ æ°—ã¥ã„ã¦è€ƒãˆã‚‹åŠ›ãŒå…‰ã£ã¦ã„ã¾ã™",
  purple: lang === "en" ? "ğŸ’œ You deepened your sensitivity and insight." : "ğŸ’œ æ„Ÿã˜å–ã£ã¦æ·±ã‚ã‚‹åŠ›ãŒè‚²ã£ã¦ã„ã¾ã™"
};


document.querySelector("h2").textContent = lang === "en"
  ? "Feed the macaron to evolve!"
  : "ãƒã‚«ãƒ­ãƒ³ã‚’é£Ÿã¹ã¦é€²åŒ–ã—ã‚ˆã†ï¼";

document.getElementById("nextStageBtn").textContent = lang === "en"
  ? "To the Ritual of Rebirth â–¶"
  : "å¾©æ´»ã®å„€å¼ã¸ â–¶";


    // ======    ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã€Œã™ã§ã«é£Ÿã¹ãŸãƒã‚«ãƒ­ãƒ³ã€ã‚’å–å¾—    ======
    // ï¼ˆåˆå›ã¯ç©ºã®é…åˆ—ã¨ãªã‚‹ï¼‰
    let eaten = JSON.parse(localStorage.getItem("eaten_macarons")) || [];

    // ======================================
    // æ®‹ã‚Šé£Ÿã¹ã¦ã„ãªã„è‰²ã®ãƒã‚«ãƒ­ãƒ³ä¸€è¦§ã‚’è¿”ã™é–¢æ•°
    // ======================================
    function getRemainingColors() {
      return colors.filter(color => !eaten.includes(color));
    }

    // ======================================
    // æ®‹ã‚Šæœªé£Ÿã®è‰²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã« 1 ã¤ã‚’é¸ã¶é–¢æ•°
    // ======================================
    function pickRandomColor() {
      const remaining = getRemainingColors();
      if (remaining.length === 0) {
        return null;
      }
      const idx = Math.floor(Math.random() * remaining.length);
      return remaining[idx];
    }

    // ======================================
    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€Œãƒã‚«ãƒ­ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã€é–¢æ•°
    // ======================================
    function renderMacaron() {
      const holder = document.getElementById("macaronHolder");
      holder.innerHTML = ""; // ã„ã£ãŸã‚“ç©ºã«ã™ã‚‹

      // ï¼ˆä¾‹ï¼‰ã‚‚ã—ã€Œ3 å›é£Ÿã¹ãŸã‚‰çµ‚äº†ã€ã«ã—ãŸã„ãªã‚‰ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ï¼š
      // if (eaten.length >= 3) {
      //   document.getElementById("growthSummary").style.display = "block";
      //   document.getElementById("nextStageBtn").style.display = "block";
      //   return;
      // }

      // ä»Šå›ã¯ â€œ4 è‰²ã™ã¹ã¦é£Ÿã¹çµ‚ãˆãŸã‚‰çµ‚äº†â€ ã¨ã—ã¦ã„ã‚‹ã®ã§ã€æ®‹ã‚ŠãŒ 0 ãªã‚‰ã‚µãƒãƒªãƒ¼è¡¨ç¤ºï¼†ãƒœã‚¿ãƒ³è¡¨ç¤º
      if (getRemainingColors().length === 0) {
        document.getElementById("growthSummary").style.display = "block";
        document.getElementById("nextStageBtn").style.display = "block";
        return;
      }

      // ãƒ©ãƒ³ãƒ€ãƒ ã«ã²ã¨ã¤ã®è‰²ã‚’ãƒ”ãƒƒã‚¯
      const pick = pickRandomColor();
      if (!pick) {
        // å¿µã®ãŸã‚ null ã®å ´åˆã‚‚ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        document.getElementById("growthSummary").style.display = "block";
        document.getElementById("nextStageBtn").style.display = "block";
        return;
      }

      // ãƒã‚«ãƒ­ãƒ³ç”»åƒã‚’ç”Ÿæˆã—ã€ã‚¯ãƒªãƒƒã‚¯ã§é£Ÿã¹ã‚‹å‡¦ç†ã‚’å‰²ã‚Šå½“ã¦ã‚‹
     // â–¼ã“ã®éƒ¨åˆ†ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼
ã€€ã€€const img = document.createElement("img");
ã€€ã€€img.src = `public/assets/stage1/macaron_${pick}.png`;

ã€€ã€€img.alt = lang === "en"
ã€€  ? `${colorNames[pick]} macaron`
ã€€  : `${colorNames[pick]}ãƒã‚«ãƒ­ãƒ³`; // âœ… â† ã“ã“ã«å…¥ã‚Œã‚‹ï¼

img.className = "macaron-img";
img.onclick = () => eatMacaron(pick);


      holder.appendChild(img);

      // æˆé•·ã‚µãƒãƒªãƒ¼ãƒ»æ¬¡ã‚¹ãƒ†ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã®ã¾ã¾
      document.getElementById("growthSummary").style.display = "none";
      document.getElementById("nextStageBtn").style.display = "none";
    }

    // ======================================
    // ãƒã‚«ãƒ­ãƒ³ã‚’â€œé£Ÿã¹ãŸâ€ã¨ãã®å‡¦ç†
    // ======================================
    function eatMacaron(color) {
      // é‡è¤‡ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²ã
      if (eaten.includes(color)) return;

      // é…åˆ—ã«è‰²ã‚’è¿½è¨˜ã—ã€localStorage ã«ã‚‚ä¿å­˜
      eaten.push(color);
      localStorage.setItem("eaten_macarons", JSON.stringify(eaten));

      // ã€Œâ—‹â—‹ãƒã‚«ãƒ­ãƒ³ã‚’é£Ÿã¹ãŸï¼ã€ã¨ä¸€ç¬ã ã‘è¡¨ç¤º
      const msgDiv = document.getElementById("message");
     msgDiv.textContent = lang === "en"
  ? `You ate the ${colorNames[color]} macaron!`
  : `${colorNames[color]}ãƒã‚«ãƒ­ãƒ³ã‚’é£Ÿã¹ãŸï¼`;

      setTimeout(() => {
        msgDiv.textContent = "";
      }, 2000);

      // æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã‚’è¡¨ç¤ºï¼ˆã¾ãŸã¯çµ‚äº†ã‚µãƒãƒªãƒ¼ã¸åˆ‡ã‚Šæ›¿ãˆï¼‰
      renderMacaron();
      renderGrowthSummary();
    }

    // ======================================
    // ã“ã‚Œã¾ã§ã«é£Ÿã¹ãŸè‰²ã”ã¨ã®ã‚µãƒãƒªãƒ¼ã‚’ä½œã£ã¦è¡¨ç¤º
    // ======================================
    function renderGrowthSummary() {
      const summaryDiv = document.getElementById("growthSummary");
      if (eaten.length === 0) {
        summaryDiv.innerHTML = "";
        return;
      }
     let html = `<h3>${lang === "en" ? "You have nurtured these qualities:" : "ã‚ãªãŸã¯ã“ã‚“ãªåŠ›ã‚’è‚²ã¦ã¾ã—ãŸâ™ª"}</h3><ul>`;

      eaten.forEach(color => {
        html += `<li>${growthMessages[color]}</li>`;
      });
      html += `</ul>`;
      summaryDiv.innerHTML = html;
    }

    // ======================================
    // ã€Œå¾©æ´»ã®å„€å¼ã¸ â–¶ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®ç”»é¢é·ç§»
    // ======================================
    function goToRebirth() {
      window.location.href = "rebirth.html";
    }

    // ======================================
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰æœ€åˆã«å‘¼ã³å‡ºã™
    // ======================================
    window.onload = renderMacaron;
  </script>
</body>
</html>
