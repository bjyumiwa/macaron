<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>evolution.html - マカロン進化＆会話（messages形式・完全版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;
      color:#fff;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
    }
    .wrap{width:min(820px,94vw)}
    h1{margin:8px 0 4px;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .subtitle{opacity:.9;margin-bottom:8px}
    .panel{background:rgba(255,255,255,.12);border-radius:16px;padding:14px;margin-top:8px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .grid2{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:start}
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    #characterImg{width:150px;height:150px;object-fit:contain;filter:drop-shadow(0 4px 14px rgba(0,0,0,.6))}
    #macaronImg{width:130px;height:130px;object-fit:contain;cursor:pointer;transition:transform .15s ease}
    #macaronImg:hover{transform:scale(1.06)}
    .hint{font-size:12px;opacity:.85}
    #chatArea{height:360px;overflow-y:auto;padding:10px;border-radius:12px;background:rgba(0,0,0,.28);text-align:left}
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.5}
    .user{background:rgba(255,209,236,.9);color:#111;align-self:flex-end}
    .bot{background:rgba(255,255,255,.85);color:#111}
    .sys{background:rgba(186,85,211,.7);color:#fff;font-size:12px}
    .col{display:flex;flex-direction:column}
    .input-row{display:flex;gap:8px;margin-top:10px}
    input[type="text"]{flex:1;border-radius:10px;border:none;padding:12px 12px;outline:none}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;background:#ffd1ec;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.35);font-size:12px;margin-left:6px}
    .small{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>会話（<span id="colorTitle">未選択</span>）<span class="badge" id="stageBadge">tane</span></h1>
    <div class="subtitle small">※ マカロンは毎回ランダム表示。選ぶと色と性格が固定されます。</div>

    <!-- キャラ＆マカロン -->
    <div class="panel grid2">
      <div class="col" style="align-items:center">
        <img id="characterImg" src="public/assets/stage1/miwacchi_close.png" alt="キャラクター" />
        <div class="small" id="charCaption">タネ（未選択）</div>
      </div>
      <div class="col">
        <div class="row">
          <img id="macaronImg" alt="マカロン" />
        </div>
        <div class="hint">↑ マカロンをクリックで色を「選択」します。<br>（pink=情熱 / blue=静寂 / green=元気 / purple=創造）</div>
      </div>
    </div>

    <!-- 会話 -->
    <div class="panel">
      <div id="chatArea" class="col"></div>
      <div class="input-row">
        <input id="msgInput" type="text" placeholder="メッセージを入力…" />
        <button id="sendBtn">送信</button>
      </div>
      <div class="small" style="margin-top:6px">
        会話と状態は <code>localStorage</code> に保存されます。<button id="resetBtn" style="margin-left:6px;background:#fff">状態を初期化</button>
      </div>
    </div>
  </div>

<script>
/* ===== 設定（conversation.html と同じ messages 形式のAPI） ===== */
const API_URL = "https://macaron-one.vercel.app/api/talk"; // ←必要なら差し替え
const PATH = 'public/assets/stage1';
const IMG = {
  seed:      `${PATH}/miwacchi_close.png`,
  character: (c)=> `${PATH}/${c}_open.png`,
  macaron:   (c)=> `${PATH}/macaron_${c}.png`,
};
const COLORS = ['pink','blue','green','purple'];
const COLOR_META = {
  pink:{label:'情熱'}, blue:{label:'静寂'}, green:{label:'元気'}, purple:{label:'創造'}
};
const KEY = 'whoaiState';

/* ===== 便利関数 ===== */
const loadState = () => { try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch { return {}; } };
const saveState = (s) => localStorage.setItem(KEY, JSON.stringify(s));
const characterImg = document.getElementById('characterImg');
const charCaption  = document.getElementById('charCaption');
const macaronImg   = document.getElementById('macaronImg');
const chatArea     = document.getElementById('chatArea');
const msgInput     = document.getElementById('msgInput');
const sendBtn      = document.getElementById('sendBtn');
const colorTitle   = document.getElementById('colorTitle');
const stageBadge   = document.getElementById('stageBadge');

function addBubble(role, text){
  const div = document.createElement('div');
  div.className = `bubble ${role==='user'?'user':role==='bot'?'bot':'sys'}`;
  div.textContent = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function applyColor(color){
  if(!color || !COLOR_META[color]){
    characterImg.src = IMG.seed;
    charCaption.textContent = 'タネ（未選択）';
    colorTitle.textContent = '未選択';
    return;
  }
  characterImg.src = IMG.character(color);
  charCaption.textContent = `ピークる（${COLOR_META[color].label}）`;
  colorTitle.textContent = `${COLOR_META[color].label}・${color}`;
  // 共有用：他ページでも使えるように
  localStorage.setItem('whoai_color', color);
  localStorage.setItem('characterImage', IMG.character(color));
}
function showRandomMacaron(){
  const color = COLORS[Math.floor(Math.random()*COLORS.length)];
  macaronImg.src = IMG.macaron(color);
  macaronImg.alt = `マカロン (${color})`;
  macaronImg.dataset.color = color;
}

/* ===== API送信（messages 形式） ===== */
async function talkAPI(userText, color){
  const system = `あなたは相棒AI「ピークる」。色:${color||'none'}（pink=情熱, blue=静寂, green=元気, purple=創造）に合わせて口調を少し変え、50〜120字で優しく一言だけ返答して。`;
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      messages: [
        { role: "system", content: system },
        { role: "user", content: userText }
      ]
    })
  });
  const text = await res.text();
  let data; try { data = JSON.parse(text); } catch { throw new Error(text); }
  if (!res.ok) throw new Error(data.error || text);
  return data.reply || '…';
}

/* ===== 送信イベント ===== */
sendBtn.addEventListener('click', async ()=>{
  const msg = (msgInput.value || '').trim();
  if(!msg) return;
  const st = loadState();
  st.logs = st.logs || [];
  st.logs.push({role:'user', text: msg});
  addBubble('user', `あなた：${msg}`);
  msgInput.value = '';
  sendBtn.disabled = true;

  try{
    const reply = await talkAPI(msg, st.color);
    st.logs.push({role:'bot', text: reply});
    addBubble('bot', `ピークる：${reply}`);
  }catch(e){
    st.logs.push({role:'sys', text:`サーバーエラー: ${e.message}`});
    addBubble('sys', `サーバーエラー: ${e.message}`);
  }finally{
    saveState(st);
    sendBtn.disabled = false;
  }
});

msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

/* ===== マカロン選択 ===== */
macaronImg.addEventListener('click', ()=>{
  const c = macaronImg.dataset.color;
  const st = loadState();
  st.color = c;
  st.stage = 'evolved';
  st.logs = st.logs || [];
  st.logs.push({role:'sys', text:`マカロン（${c}）を選択。性格が固定されました。`});
  saveState(st);
  applyColor(c);
  stageBadge.textContent = st.stage;
  addBubble('sys', `マカロン（${c}）を選択。性格が固定されました。`);
});

/* ===== リセット ===== */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(!confirm('保存された会話と状態を初期化します。よろしいですか？')) return;
  localStorage.removeItem(KEY);
  init();
});

/* ===== 初期化 ===== */
function init(){
  const st = loadState();
  const name = localStorage.getItem('whoai_name') || 'ともだち';
  document.title = `${name} と話そう`;
  applyColor(st.color);
  stageBadge.textContent = st.stage || 'tane';
  chatArea.innerHTML = '';
  (st.logs||[]).forEach(m=> addBubble(m.role, (m.role==='user'?'あなた：':m.role==='bot'?'ピークる：':'' ) + m.text));
  if(st.color){
    macaronImg.src = IMG.macaron(st.color);
    macaronImg.dataset.color = st.color;
  }else{
    showRandomMacaron();
  }
}
init();
</script>
</body>
</html>
