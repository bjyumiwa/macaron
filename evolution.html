<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>evolution.html - „Éû„Ç´„É≠„É≥ÈÄ≤Âåñ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { height:100%; margin:0; padding:0; }
    body {
      font-family: "Noto Sans JP", sans-serif;
      background-image: url("./public/assets/stage1/space_background.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #fff;
      text-align: center;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    h2 { margin-bottom: 24px; font-size: 1.8em; text-shadow: 0 0 8px rgba(0,0,0,.5); }
    .macaron-holder {
      width: 140px; height: 140px; display: flex; justify-content: center; align-items: center;
      margin-bottom: 24px; background: rgba(255,255,255,.1);
      border: 2px dashed rgba(255,255,255,.3); border-radius: 16px;
    }
    .macaron-img { width: 120px; height: auto; border-radius: 12px; cursor: pointer;
      box-shadow: 0 0 10px rgba(255,255,255,.5); transition: transform .2s; }
    .macaron-img:hover { transform: scale(1.05); }
    .message { margin-top: 16px; font-size: 1.2em; min-height: 1.4em; }
    .growth-summary {
      margin-top: 24px; background: rgba(255,255,255,.4); color: #222;
      padding: 16px; border-radius: 12px; max-width: 90%; text-align: left; display: none;
    }
    .growth-summary h3 { margin-top: 0; }
    .growth-summary ul { margin: 8px 0 0 16px; padding: 0; }
    .growth-summary li { margin-bottom: 4px; list-style: disc inside; }
    #nextStageBtn {
      margin-top: 32px; padding: 12px 24px; font-size: 18px; border-radius: 12px; border: none;
      background: #ffd1ec; color: #111; cursor: pointer; display: none; transition: background .3s, color .3s;
    }
    #nextStageBtn:hover { background: #ff70c1; color: #fff; }
    @media (max-width: 480px) {
      .macaron-holder { width: 100px; height: 100px; }
      .macaron-img { width: 80px; }
      #nextStageBtn { font-size: 16px; padding: 10px 20px; }
    }
  </style>
</head>
<body>
  <h2>„Éû„Ç´„É≠„É≥„ÇíÈ£ü„Åπ„Å¶ÈÄ≤Âåñ„Åó„Çà„ÅÜÔºÅ</h2>

  <div class="macaron-holder" id="macaronHolder"></div>
  <div class="message" id="message"></div>
  <div class="growth-summary" id="growthSummary"></div>
  <button id="nextStageBtn" onclick="goToRebirth()">Âæ©Ê¥ª„ÅÆÂÑÄÂºè„Å∏ ‚ñ∂</button>

  <script>
    // ===== Ë®ÄË™ûË®≠ÂÆö =====
    const lang = localStorage.getItem("lang") || "ja";
    document.title = lang === "en" ? "evolution.html - Macaron Evolution" : "evolution.html - „Éû„Ç´„É≠„É≥ÈÄ≤Âåñ";
    document.querySelector("h2").textContent = lang === "en" ? "Feed the macaron to evolve!" : "„Éû„Ç´„É≠„É≥„ÇíÈ£ü„Åπ„Å¶ÈÄ≤Âåñ„Åó„Çà„ÅÜÔºÅ";
    document.getElementById("nextStageBtn").textContent = lang === "en" ? "To the Ritual of Rebirth ‚ñ∂" : "Âæ©Ê¥ª„ÅÆÂÑÄÂºè„Å∏ ‚ñ∂";

    // ===== ÂøÖÈ†àÔºöËâ≤„ÅÆ„É™„Çπ„Éà =====
    const colors = ["pink", "green", "blue", "purple"];

    // Ë°®Á§∫Âêç
    const colorNames = {
      pink:   lang === "en" ? "pink"   : "„Éî„É≥„ÇØ",
      green:  lang === "en" ? "green"  : "„Ç∞„É™„Éº„É≥",
      blue:   lang === "en" ? "blue"   : "„Éñ„É´„Éº",
      purple: lang === "en" ? "purple" : "„Éë„Éº„Éó„É´"
    };

    // È£ü„Åπ„Åü„Å®„Åç„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
    const growthMessages = {
      pink:   lang === "en" ? "ü©∑ You nurtured empathy and compassion." : "ü©∑ ÊÄù„ÅÑ„ÇÑ„Çä„ÉªÂÖ±ÊÑü„ÅÆÂäõ„ÅåËÇ≤„Å°„Åæ„Åó„Åü",
      green:  lang === "en" ? "üíö You developed initiative and action." : "üíö Ëá™ÂàÜ„Åã„ÇâÂãï„ÅèÂäõ„ÅåÂá∫„Å¶„Åç„Åæ„Åó„Åü",
      blue:   lang === "en" ? "üíô Your thinking and awareness grew."    : "üíô Ê∞ó„Å•„ÅÑ„Å¶ËÄÉ„Åà„ÇãÂäõ„ÅåÂÖâ„Å£„Å¶„ÅÑ„Åæ„Åô",
      purple: lang === "en" ? "üíú You deepened your sensitivity and insight." : "üíú ÊÑü„ÅòÂèñ„Å£„Å¶Ê∑±„ÇÅ„ÇãÂäõ„ÅåËÇ≤„Å£„Å¶„ÅÑ„Åæ„Åô"
    };

    // „Åì„Çå„Åæ„ÅßÈ£ü„Åπ„ÅüËâ≤
    let eaten = JSON.parse(localStorage.getItem("eaten_macarons")) || [];

    function getRemainingColors() {
      return colors.filter(c => !eaten.includes(c));
    }

    function pickRandomColor() {
      const remaining = getRemainingColors();
      if (!remaining.length) return null;
      const idx = Math.floor(Math.random() * remaining.length);
      return remaining[idx];
    }

    function renderMacaron() {
      const holder = document.getElementById("macaronHolder");
      holder.innerHTML = "";

      // 4Ëâ≤„Åô„Åπ„Å¶È£ü„Åπ„Åü„ÇâÁµÇ‰∫ÜUI„Å´
      if (getRemainingColors().length === 0) {
        document.getElementById("growthSummary").style.display = "block";
        document.getElementById("nextStageBtn").style.display = "block";
        return;
      }

      const pick = pickRandomColor();
      if (!pick) {
        document.getElementById("growthSummary").style.display = "block";
        document.getElementById("nextStageBtn").style.display = "block";
        return;
      }

      const img = document.createElement("img");
      img.src = `./public/assets/stage1/macaron_${pick}.png`; // „Éï„Ç©„É´„ÉÄÊßãÊàê„Å´Âêà„Çè„Åõ„Çã
      img.alt = lang === "en" ? `${colorNames[pick]} macaron` : `${colorNames[pick]}„Éû„Ç´„É≠„É≥`;
      img.className = "macaron-img";
      img.onclick = () => eatMacaron(pick);
      holder.appendChild(img);

      document.getElementById("growthSummary").style.display = "none";
      document.getElementById("nextStageBtn").style.display = "none";
    }

    function eatMacaron(color) {
      if (eaten.includes(color)) return;
      eaten.push(color);
      localStorage.setItem("eaten_macarons", JSON.stringify(eaten));

      const msgDiv = document.getElementById("message");
      msgDiv.textContent = lang === "en"
        ? `You ate the ${colorNames[color]} macaron!`
        : `${colorNames[color]}„Éû„Ç´„É≠„É≥„ÇíÈ£ü„Åπ„ÅüÔºÅ`;
      setTimeout(() => { msgDiv.textContent = ""; }, 1500);

      renderMacaron();
      renderGrowthSummary();
    }

    function renderGrowthSummary() {
      const summaryDiv = document.getElementById("growthSummary");
      if (!eaten.length) { summaryDiv.innerHTML = ""; return; }
      let html = `<h3>${lang === "en" ? "You have nurtured these qualities:" : "„ÅÇ„Å™„Åü„ÅØ„Åì„Çì„Å™Âäõ„ÇíËÇ≤„Å¶„Åæ„Åó„Åü‚ô™"}</h3><ul>`;
      eaten.forEach(c => { html += `<li>${growthMessages[c]}</li>`; });
      html += `</ul>`;
      summaryDiv.innerHTML = html;
    }

    function goToRebirth() { window.location.href = "./rebirth.html"; }

    // ÂÆâÂÖ®„Å™Ëµ∑Âãï„Å®Á∞°Êòì„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
    window.onload = () => {
      try {
        renderMacaron();
        renderGrowthSummary();
      } catch (e) {
        console.error(e);
        document.getElementById("message").textContent = `Error: ${e.message}`;
      }
    };
  </script>
</body>
</html>
