<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WHOAI - Evolution</title>
<style>
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    color:#fff; display:flex; align-items:center; justify-content:center; text-align:center; padding:24px
  }
  .card{background:rgba(0,0,0,.38); border:1px solid rgba(255,255,255,.18); border-radius:20px; padding:22px; width:min(760px,92vw); position:relative}
  h1{margin:0 0 8px}
  .img{height:180px; display:flex; align-items:center; justify-content:center; margin:8px auto 6px}
  .img img{max-height:170px; max-width:82%; filter:drop-shadow(0 10px 24px rgba(0,0,0,.5))}
  .fallback{width:140px;height:140px;border-radius:50%;border:4px solid rgba(255,255,255,.8)}
  .namebox{margin-top:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); border-radius:14px; padding:12px}
  .namebox h2{margin:0 0 8px; font-size:18px}
  .row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .row input{width:min(360px,80vw); padding:12px 14px; border-radius:12px; border:none; outline:none}
  .row button{padding:12px 16px; border:none; border-radius:12px; font-weight:700; cursor:pointer}
  .primary{background:#ffd1ec; color:#222}
  .go{margin-top:14px}
  .muted{opacity:.85}
  .err{color:#ffb3b3; margin-top:6px; min-height:1.2em}
  .rename{position:absolute; right:14px; bottom:12px; font-size:12px; opacity:.8; cursor:pointer; text-decoration:underline}
</style>
</head>
<body>
  <div class="card">
    <h1 id="title">進化（種）</h1>
    <div class="img"><img id="char" alt=""></div>
    <p id="desc" class="muted"></p>

    <div id="namebox" class="namebox" style="display:none;">
      <h2 id="nameTitle">キャラクターに名前をつけてください</h2>
      <div class="row">
        <input id="nameInput" type="text" maxlength="16" placeholder="例：みわっち / Miwa">
        <button id="saveName" class="primary">名前を決める</button>
      </div>
      <div id="nameErr" class="err"></div>
      <p class="muted" id="nameNote">※ 1〜16文字。あとから変更できます。</p>
    </div>

    <button class="primary go" id="go">会話へ進む</button>
    <span id="rename" class="rename">名前を変更する</span>
  </div>

<script>
  const ASSETS = "public/assets/stage1";
  const lang = localStorage.getItem('lang') || 'ja';
  const state = JSON.parse(localStorage.getItem('whoai_state')||"{}");
  if(!state || !state.color){ location.href = "macaron_select.html"; }

  const T = {
    ja:{
      titleSeed:"進化（種）", titleNext:"進化（次形態）",
      ate:(n,c)=>`${n}は ${c} のマカロンを食べて「種（tane）」の姿になった！`,
      evo:(n,c,v)=>`${n}は ${c} の力が芽吹き、${v==="open"?"オープン":"クローズ"}形態へ進化した！`,
      nameTitle:"キャラクターに名前をつけてください",
      placeholder:"例：みわっち / Miwa",
      nameBtn:"名前を決める",
      nameNote:"※ 1〜16文字。あとから変更できます。",
      errEmpty:"1文字以上で入力してください。",
      go:"会話へ進む",
      rename:"名前を変更する",
      colors:{pink:"ピンク", blue:"ブルー", green:"グリーン", purple:"パープル"}
    },
    en:{
      titleSeed:"Evolution (Seed)", titleNext:"Evolution (Next Form)",
      ate:(n,c)=>`${n} ate the ${c} macaron and took on the seed (tane) form!`,
      evo:(n,c,v)=>`${n}'s ${c} trait blossomed and evolved to the ${v} form!`,
      nameTitle:"Give your character a name",
      placeholder:"e.g., Miwacchi / Miwa",
      nameBtn:"Save name",
      nameNote:"* 1–16 characters. You can change it later.",
      errEmpty:"Please enter at least 1 character.",
      go:"Start chatting",
      rename:"Change name",
      colors:{pink:"Pink", blue:"Blue", green:"Green", purple:"Purple"}
    }
  }[lang];

  function charSrc(s){
    if(s.variant === "tane") return `${ASSETS}/tane_${s.color}.png`;
    return `${ASSETS}/${s.color}_${s.variant}.png`;
  }

  const img = document.getElementById('char');
  img.src = charSrc(state);
  img.onerror = ()=>{ img.remove(); const d=document.createElement('div'); d.className='fallback'; d.style.background=state.color; document.querySelector('.img').appendChild(d); };

  document.getElementById('title').textContent = (state.variant==="tane") ? T.titleSeed : T.titleNext;

  const storedName = localStorage.getItem('whoai_name');
  if(!state.name && storedName) state.name = storedName;

  const colorName = T.colors[state.color] || state.color;
  const N = state.name || (lang==='ja'?'キャラクター':'Character');
  document.getElementById('desc').textContent =
    (state.variant==="tane") ? T.ate(N, colorName) : T.evo(N, colorName, state.variant);

  const needNameFirst = localStorage.getItem('whoai_named') !== '1';
  const namebox = document.getElementById('namebox');
  const goBtn = document.getElementById('go');
  const renameLink = document.getElementById('rename');

  document.getElementById('nameTitle').textContent = T.nameTitle;
  document.getElementById('nameInput').placeholder = T.placeholder;
  document.getElementById('saveName').textContent = T.nameBtn;
  document.getElementById('nameNote').textContent = T.nameNote;
  goBtn.textContent = T.go;
  renameLink.textContent = T.rename;

  function openNameBox(lockGo=true){
    namebox.style.display = 'block';
    if(lockGo){ goBtn.disabled = true; goBtn.style.opacity = .7; }
    document.getElementById('nameInput').focus();
  }
  if(needNameFirst){ openNameBox(true); }
  renameLink.addEventListener('click', ()=> openNameBox(false));

  const nameInput = document.getElementById('nameInput');
  const nameErr = document.getElementById('nameErr');

  function cleanName(s){ return s.replace(/\s+/g,' ').trim().slice(0,16); }
  function saveName(){
    const v = cleanName(nameInput.value);
    if(!v){ nameErr.textContent = T.errEmpty; return; }
    nameErr.textContent = '';
    localStorage.setItem('whoai_name', v);
    localStorage.setItem('whoai_named', '1');
    const st = JSON.parse(localStorage.getItem('whoai_state')||"{}");
    st.name = v;
    localStorage.setItem('whoai_state', JSON.stringify(st));
    document.getElementById('desc').textContent =
      (st.variant==="tane") ? T.ate(v, colorName) : T.evo(v, colorName, st.variant);
    goBtn.disabled = false; goBtn.style.opacity = 1;
    namebox.style.display = 'none';
  }
  document.getElementById('saveName').addEventListener('click', saveName);
  nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveName(); } });

  if(!needNameFirst && (state.name || storedName)){ goBtn.disabled = false; }
  goBtn.addEventListener('click', ()=>{ location.href = "whoai_talk.html"; });
</script>
</body>
</html>
