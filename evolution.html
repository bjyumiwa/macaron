<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>進化イベント</title>
<style>
  :root{ --glass: rgba(255,255,255,.08); --ring: rgba(255,255,255,.22); --accent:#ffd1ec; }
  html,body{height:100%;margin:0}
  body{
    font-family:"Noto Sans JP",sans-serif;color:#fff;
    background:url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:18px
  }
  h2{margin:0 0 8px;text-shadow:0 0 10px rgba(0,0,0,.6)}
  .stage{display:flex;flex-direction:column;align-items:center;gap:16px}
  .card{
    background:var(--glass);border:1px solid var(--ring);
    border-radius:18px;padding:16px 20px;text-align:center
  }
  #baseChar,#macaron,#evolvedChar{width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.6))}
  .row{display:flex;align-items:center;gap:24px}
  .fade{opacity:0;transition:opacity .6s ease}
  .show{opacity:1}
  .btn{background:var(--accent);color:#222;border:none;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
  .ghost{background:#444;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer}
</style>
</head>
<body>

  <div class="stage">
    <h2 id="title">進化のとき…</h2>

    <div class="row">
      <img id="baseChar"    alt="キャラ（前）">
      <img id="macaron"     alt="マカロン">
      <img id="evolvedChar" alt="キャラ（進化後）" class="fade">
    </div>

    <div class="card" id="log">マカロンを食べています…</div>

    <div>
      <button class="ghost" id="replayBtn">もう一度みる</button>
      <button class="btn"   id="nextBtn">次へ</button>
    </div>
  </div>

<script>
  const ASSETS_BASE = "public/assets/stage1";

  const BEFORE_MAP = {
    green : `${ASSETS_BASE}/green_open.png`,
    blue  : `${ASSETS_BASE}/blue_open.png`,
    purple: `${ASSETS_BASE}/green_open.png`,
    red   : `${ASSETS_BASE}/green_open.png`,
    pink  : `${ASSETS_BASE}/green_open.png`,
  };

  const EVOLVED_MAP = {
    green : `${ASSETS_BASE}/miwacchi_open.png`,
    blue  : `${ASSETS_BASE}/miwacchi_open.png`,
    purple: `${ASSETS_BASE}/miwacchi_open.png`,
    red   : `${ASSETS_BASE}/miwacchi_open.png`,
    pink  : `${ASSETS_BASE}/miwacchi_open.png`,
  };

  const MACARON_MAP = {
    green : `${ASSETS_BASE}/macaron_green.png`,
    blue  : `${ASSETS_BASE}/macaron_blue.png`,
    purple: `${ASSETS_BASE}/macaron_purple.png`,
    pink  : `${ASSETS_BASE}/macaron_pink.png`,
    red   : `${ASSETS_BASE}/macaron_green.png`,
  };

  const DEFAULT_CHAR = `${ASSETS_BASE}/green_open.png`;
  const DEFAULT_MACARON = `${ASSETS_BASE}/macaron_green.png`;

  const baseChar    = document.getElementById("baseChar");
  const macaronImg  = document.getElementById("macaron");
  const evolvedChar = document.getElementById("evolvedChar");
  const titleEl     = document.getElementById("title");
  const logEl       = document.getElementById("log");
  const replayBtn   = document.getElementById("replayBtn");
  const nextBtn     = document.getElementById("nextBtn");

  function getColorKey(){
    try{
      const choice = JSON.parse(localStorage.getItem("macaron_choice") || "{}");
      return choice.macaron || null;
    }catch{ return null; }
  }

  function pick(map, key, fallback){
    return (key && map[key]) ? map[key] : fallback;
  }

  async function playEvolution(){
    evolvedChar.classList.remove("show");
    logEl.textContent = "マカロンを食べています…";
    await sleep(700);
    logEl.textContent = "力が満ちてきた…！";
    await sleep(700);
    evolvedChar.classList.add("show");
    logEl.textContent = "進化したよ！";
    localStorage.setItem("evolved", "true");
    localStorage.setItem("evolvedCharacterImage", evolvedChar.src);
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function init(){
    const color = getColorKey();
    const beforeSrc  = pick(BEFORE_MAP,  color, DEFAULT_CHAR);
    const macaronSrc = pick(MACARON_MAP, color, DEFAULT_MACARON);
    const evolvedSrc = pick(EVOLVED_MAP, color, DEFAULT_CHAR);

    titleEl.textContent = color ? `進化イベント（選択色：${color}）` : "進化イベント";

    baseChar.src    = beforeSrc;
    macaronImg.src  = macaronSrc;
    evolvedChar.src = evolvedSrc;

    baseChar.onerror    = () => { baseChar.onerror = null; baseChar.src = DEFAULT_CHAR; };
    macaronImg.onerror  = () => { macaronImg.onerror = null; macaronImg.src = DEFAULT_MACARON; };
    evolvedChar.onerror = () => { evolvedChar.onerror = null; evolvedChar.src = DEFAULT_CHAR; };

    playEvolution();
  }

  replayBtn.addEventListener("click", playEvolution);
  nextBtn.addEventListener("click", ()=>{
    location.href = "identity_check.html";
  });

  init();
</script>
</body>
</html>
