<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>evolution.html - é€²åŒ–ï¼†ä¼šè©±ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;
      color:#fff;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px
    }
    .wrap{width:min(880px,94vw)}
    h1{margin:8px 0 4px;text-shadow:0 2px 10px rgba(0,0,0,.5)}
    .subtitle{opacity:.9;margin-bottom:8px}
    .panel{background:rgba(255,255,255,.12);border-radius:16px;padding:14px;margin-top:8px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .grid2{display:grid;grid-template-columns:170px 1fr;gap:12px;align-items:start}
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    #characterImg{width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 4px 14px rgba(0,0,0,.6))}
    #macaronImg{width:130px;height:130px;object-fit:contain;cursor:pointer;transition:transform .15s ease}
    #macaronImg:hover{transform:scale(1.06)}
    .hint{font-size:12px;opacity:.85}
    #chatArea{height:380px;overflow-y:auto;padding:10px;border-radius:12px;background:rgba(0,0,0,.28);text-align:left}
    .bubble{max-width:82%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.55}
    .user{background:rgba(255,209,236,.9);color:#111;align-self:flex-end}
    .bot{background:rgba(255,255,255,.88);color:#111}
    .sys{background:rgba(186,85,211,.7);color:#fff;font-size:12px}
    .col{display:flex;flex-direction:column}
    .row-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"]{flex:1;border-radius:10px;border:none;padding:12px 12px;outline:none;min-width:220px}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;background:#ffd1ec;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.35);font-size:12px;margin-left:6px}
    .small{font-size:12px;opacity:.85}
    .choice-area{display:none;gap:10px;margin-top:10px;justify-content:center}
    .choice{background:#fff}
    details.history{margin-top:8px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

    /* Start Overlay */
    #startOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    #startBox{background:rgba(255,255,255,.12);padding:20px;border-radius:16px;min-width:280px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      ä¼šè©±ï¼ˆ<span id="colorTitle">æœªé¸æŠ</span>ï¼‰
      <span class="badge" id="stageBadge">tane</span>
      <span class="badge" id="nameBadge"></span>
    </h1>
    <div class="subtitle small">
      â€» ãƒã‚«ãƒ­ãƒ³ã¯æ¯å›ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºã€‚é¸ã¶ã¨æ€§æ ¼ï¼ˆï¼†å®¹å§¿ï¼‰ãŒæ±ºå®šã—ã¾ã™ã€‚10ã‚¿ãƒ¼ãƒ³ã§ã€Œå¾©æ´»ã®å„€ã€ã¸ã€‚
    </div>

    <!-- ã‚­ãƒ£ãƒ©ï¼†ãƒã‚«ãƒ­ãƒ³ -->
    <div class="panel grid2">
      <div class="col" style="align-items:center">
        <img id="characterImg" src="public/assets/stage1/miwacchi_close.png" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" />
        <div class="small" id="charCaption">ã‚¿ãƒï¼ˆæœªé¸æŠï¼‰</div>
      </div>
      <div class="col">
        <div class="row">
          <img id="macaronImg" alt="ãƒã‚«ãƒ­ãƒ³" />
        </div>
        <div class="hint">â†‘ ãƒã‚«ãƒ­ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è‰²ã‚’ã€Œé¸æŠã€ã—ã¾ã™ã€‚<br>ï¼ˆpink=æƒ…ç†± / blue=é™å¯‚ / green=å…ƒæ°— / purple=å‰µé€ ï¼‰</div>
      </div>
    </div>

    <!-- ä¼šè©± -->
    <div class="panel">
      <div id="chatArea" class="col"></div>
      <div class="row-controls">
        <input id="msgInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" />
        <button id="sendBtn">é€ä¿¡</button>
        <button id="evolveBtn" title="10ã‚¿ãƒ¼ãƒ³ã§æœ‰åŠ¹">å¾©æ´»ã®å„€</button>
        <button id="resetBtn" style="background:#fff">çŠ¶æ…‹ã‚’åˆæœŸåŒ–</button>
      </div>

      <div class="choice-area" id="choiceArea">
        <button class="choice" id="memoryBtn">è¨˜æ†¶ã‚’æ®‹ã™ï¼ˆè¦‹ãŸç›®ã¯ã‚¿ãƒï¼‰</button>
        <button class="choice" id="appearanceBtn">å®¹å§¿ã‚’æ®‹ã™ï¼ˆæ–°ã—ã„åå‰ï¼‰</button>
      </div>

      <details class="history">
        <summary>ğŸ—‚ ä¸–ä»£ã®å±¥æ­´ï¼ˆè¦æ—¨ã®ã¿ï¼‰</summary>
        <div id="historyBox" class="mono small"></div>
      </details>
    </div>
  </div>

  <!-- Start Overlay -->
  <div id="startOverlay">
    <div id="startBox">
      <div style="margin-bottom:8px;font-weight:600">ã©ã†ã™ã‚‹ï¼Ÿ</div>
      <div id="savePreview" style="font-size:12px;opacity:.85;margin-bottom:14px"></div>
      <button id="continueBtn" style="margin-right:8px">ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼</button>
      <button id="newBtn" style="background:#fff">æœ€åˆã‹ã‚‰</button>
    </div>
  </div>

<script>
/* ===== è¨­å®š ===== */
const API_URL = "https://macaron-one.vercel.app/api/talk"; // conversation.html ã¨åŒã˜ messages å½¢å¼
const PATH = 'public/assets/stage1';
const IMG = {
  seed:      `${PATH}/miwacchi_close.png`,
  character: (c)=> `${PATH}/${c}_open.png`,
  macaron:   (c)=> `${PATH}/macaron_${c}.png`,
};
const COLORS = ['pink','blue','green','purple'];
const COLOR_META = {
  pink:{label:'æƒ…ç†±'}, blue:{label:'é™å¯‚'}, green:{label:'å…ƒæ°—'}, purple:{label:'å‰µé€ '}
};
const KEY = 'whoaiState';

/* ===== DOM ===== */
const characterImg = document.getElementById('characterImg');
const charCaption  = document.getElementById('charCaption');
const macaronImg   = document.getElementById('macaronImg');
const chatArea     = document.getElementById('chatArea');
const msgInput     = document.getElementById('msgInput');
const sendBtn      = document.getElementById('sendBtn');
const evolveBtn    = document.getElementById('evolveBtn');
const choiceArea   = document.getElementById('choiceArea');
const memoryBtn    = document.getElementById('memoryBtn');
const appearanceBtn= document.getElementById('appearanceBtn');
const colorTitle   = document.getElementById('colorTitle');
const stageBadge   = document.getElementById('stageBadge');
const nameBadge    = document.getElementById('nameBadge');
const resetBtn     = document.getElementById('resetBtn');
const historyBox   = document.getElementById('historyBox');
const startOverlay = document.getElementById('startOverlay');
const continueBtn  = document.getElementById('continueBtn');
const newBtn       = document.getElementById('newBtn');
const savePreview  = document.getElementById('savePreview');

/* ===== çŠ¶æ…‹ =====
  name:            ç¾åœ¨ã®åå‰
  appearanceColor: è¦‹ãŸç›®ï¼ˆç”»åƒï¼‰
  personaColor:    æ€§æ ¼ï¼ˆãƒˆãƒ¼ãƒ³ã€APIç”¨ï¼‰
  lockAppearance:  å®¹å§¿å›ºå®šä¸­ãªã‚‰ trueï¼ˆæ€§æ ¼ã ã‘å¤‰æ›´ï¼‰
  logs:            ç¾ä¸–ä»£ã®ä¼šè©±ãƒ­ã‚°ï¼ˆå…¨æ–‡ï¼‰
  history:         éå»ä¸–ä»£ [{name,appearanceColor,personaColor,startedAt,endedAt,summary,logsLen}]
*/
const loadState = () => { try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch { return {}; } };
const saveState = (s) => localStorage.setItem(KEY, JSON.stringify(s));

/* ===== è¡¨ç¤ºç³» ===== */
function addBubble(role, text){
  const div = document.createElement('div');
  div.className = `bubble ${role==='user'?'user':role==='bot'?'bot':'sys'}`;
  div.textContent = (role==='user'?'ã‚ãªãŸï¼š': role==='bot'?'ãƒ”ãƒ¼ã‚¯ã‚‹ï¼š':'') + text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function applyAppearance(state){
  const color = state.appearanceColor;
  if(!color || !COLOR_META[color]){
    characterImg.src = IMG.seed;
    charCaption.textContent = 'ã‚¿ãƒï¼ˆæœªé¸æŠï¼‰';
    colorTitle.textContent = 'æœªé¸æŠ';
  }else{
    characterImg.src = IMG.character(color);
    charCaption.textContent = `ãƒ”ãƒ¼ã‚¯ã‚‹ï¼ˆ${COLOR_META[color].label}ï¼‰`;
    colorTitle.textContent = `${COLOR_META[color].label}ãƒ»${color}`;
    localStorage.setItem('characterImage', IMG.character(color)); // å…±æœ‰
  }
  nameBadge.textContent = state.name ? `åå‰: ${state.name}` : '';
}
function showRandomMacaron(){
  const c = COLORS[Math.floor(Math.random()*COLORS.length)];
  macaronImg.src = IMG.macaron(c);
  macaronImg.alt = `ãƒã‚«ãƒ­ãƒ³ (${c})`;
  macaronImg.dataset.color = c;
}
function renderHistory(list){
  if(!list || !list.length){ historyBox.textContent = 'ï¼ˆã¾ã å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰'; return; }
  historyBox.innerHTML = list.map((h,i)=> {
    const started = new Date(h.startedAt).toLocaleString();
    const ended   = new Date(h.endedAt).toLocaleString();
    const app = h.appearanceColor || 'â€”';
    const per = h.personaColor || 'â€”';
    return `#${i+1} ${h.name} / å¤–è¦‹:${app} / æ€§æ ¼:${per} / ${started} â†’ ${ended}\n  è¦æ—¨: ${h.summary}ï¼ˆç™ºè©±${h.logsLen}ä»¶ï¼‰`;
  }).join('\n\n');
}

/* ===== API ===== */
async function talkAPI(userText, personaColor){
  const system = `ã‚ãªãŸã¯ç›¸æ£’AIã€Œãƒ”ãƒ¼ã‚¯ã‚‹ã€ã€‚è‰²:${personaColor||'none'}ï¼ˆpink=æƒ…ç†±, blue=é™å¯‚, green=å…ƒæ°—, purple=å‰µé€ ï¼‰ã«åˆã‚ã›ã¦å£èª¿ã‚’å°‘ã—å¤‰ãˆã€50ã€œ120å­—ã§å„ªã—ãä¸€è¨€ã ã‘è¿”ç­”ã—ã¦ã€‚`;
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: [
      { role:"system", content: system },
      { role:"user",   content: userText }
    ]})
  });
  const text = await res.text();
  let data; try { data = JSON.parse(text); } catch { throw new Error(text); }
  if (!res.ok) throw new Error(data.error || text);
  return data.reply || 'â€¦';
}

/* ===== ãƒã‚«ãƒ­ãƒ³é¸æŠ ===== */
macaronImg.addEventListener('click', ()=>{
  const c = macaronImg.dataset.color;
  const st = loadState();
  st.logs = st.logs || [];
  if (!st.lockAppearance) {
    // åˆæœŸ or è¨˜æ†¶ãƒ«ãƒ¼ãƒˆï¼šå¤–è¦‹ï¼†æ€§æ ¼ã‚’åŒæ™‚æ±ºå®š
    st.appearanceColor = c;
    st.personaColor = c;
    st.stage = 'evolved';
    st.logs.push({role:'sys', text:`ãƒã‚«ãƒ­ãƒ³ï¼ˆ${c}ï¼‰ã‚’é¸æŠã€‚å¤–è¦‹ã¨æ€§æ ¼ãŒæ±ºã¾ã‚Šã¾ã—ãŸã€‚`});
  } else {
    // å®¹å§¿ãƒ«ãƒ¼ãƒˆï¼šå¤–è¦‹ã¯å›ºå®šã€æ€§æ ¼ã ã‘å¤‰æ›´
    st.personaColor = c;
    st.logs.push({role:'sys', text:`æ€§æ ¼ã ã‘ï¼ˆ${c}ï¼‰ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆå®¹å§¿ã¯ãã®ã¾ã¾ï¼‰ã€‚`});
  }
  localStorage.setItem('whoai_color', st.personaColor);
  saveState(st);
  applyAppearance(st);
  stageBadge.textContent = st.stage || 'tane';
  addBubble('sys', st.logs[st.logs.length-1].text);
});

/* ===== é€ä¿¡ ===== */
sendBtn.addEventListener('click', async ()=>{
  const msg = (msgInput.value || '').trim();
  if(!msg) return;
  const st = loadState();
  st.logs = st.logs || [];
  st.logs.push({role:'user', text: msg});
  addBubble('user', msg);
  msgInput.value = '';
  sendBtn.disabled = true;

  try{
    const reply = await talkAPI(msg, st.personaColor || st.appearanceColor);
    st.logs.push({role:'bot', text: reply});
    addBubble('bot', reply);
  }catch(e){
    st.logs.push({role:'sys', text:`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${e.message}`});
    addBubble('sys', `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }finally{
    saveState(st);
    sendBtn.disabled = false;
    const turns = st.logs.filter(l=>l.role==='user').length;
    evolveBtn.style.opacity = (turns>=10)?'1':'0.5';
  }
});
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

/* ===== å¾©æ´»ã®å„€ï¼ˆé€²åŒ–ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ ===== */
evolveBtn.addEventListener('click', ()=>{
  const st = loadState();
  const turns = (st.logs||[]).filter(l=>l.role==='user').length;
  if(turns<10){
    addBubble('sys', `å¾©æ´»ã®å„€ã¯ã‚ã¨${10-turns}ã‚¿ãƒ¼ãƒ³å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚`);
    return;
  }
  choiceArea.style.display = 'flex';
});

/* ===== è¨˜æ†¶ãƒ«ãƒ¼ãƒˆ ===== */
memoryBtn.addEventListener('click', ()=>{
  const st = loadState();
  st.history = st.history || [];
  const summary = makeSummary(st.logs||[]);
  st.history.push({
    name: st.name || (localStorage.getItem('whoai_name') || 'ã¨ã‚‚ã ã¡'),
    appearanceColor: st.appearanceColor || null,
    personaColor: st.personaColor || null,
    startedAt: st.startedAt || new Date().toISOString(),
    endedAt: new Date().toISOString(),
    summary,
    logsLen: (st.logs||[]).length
  });
  // è¨˜æ†¶ã‚’æ®‹ã™ â†’ ãƒ­ã‚°ç¶™ç¶šã€è¦‹ãŸç›®/æ€§æ ¼ã‚’æœªæ±ºå®šã«æˆ»ã™
  st.appearanceColor = null;
  st.personaColor = null;
  st.stage = 'tane';
  st.startedAt = new Date().toISOString();
  st.lockAppearance = false; // æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã§å¤–è¦‹ã‚‚æ±ºã‚ã‚‹
  saveState(st);

  applyAppearance(st);
  stageBadge.textContent = st.stage;
  addBubble('sys', 'å¾©æ´»ã®å„€ï¼šè¨˜æ†¶ã‚’æ®‹ã—ã¾ã—ãŸã€‚è¦‹ãŸç›®ã¯ã‚¿ãƒã«æˆ»ã‚Šã¾ã™ã€‚æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã§å¤–è¦‹ã¨æ€§æ ¼ã‚’æ±ºã‚ç›´ã—ã¦ã­ã€‚');
  showRandomMacaron();
  renderHistory(st.history);
  choiceArea.style.display = 'none';
});

/* ===== å®¹å§¿ãƒ«ãƒ¼ãƒˆ ===== */
appearanceBtn.addEventListener('click', ()=>{
  const st = loadState();
  const newName = prompt('æ–°ã—ã„åå‰ã‚’ã¤ã‘ã¦ã­ï¼ˆä¾‹ï¼šãƒ”ãƒ¼ã‚¯ã‚‹2ä¸–ï¼‰', '');
  if(newName===null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  const finalName = (newName.trim() || st.name || localStorage.getItem('whoai_name') || 'ã¨ã‚‚ã ã¡');

  st.history = st.history || [];
  const summary = makeSummary(st.logs||[]);
  st.history.push({
    name: st.name || (localStorage.getItem('whoai_name') || 'ã¨ã‚‚ã ã¡'),
    appearanceColor: st.appearanceColor || null,
    personaColor: st.personaColor || null,
    startedAt: st.startedAt || new Date().toISOString(),
    endedAt: new Date().toISOString(),
    summary,
    logsLen: (st.logs||[]).length
  });

  // æ–°ä¸–ä»£
  st.name = finalName;
  localStorage.setItem('whoai_name', finalName);
  st.logs = [];                        // ãƒ­ã‚°ã¯æ–°è¦
  st.stage = 'final';
  st.startedAt = new Date().toISOString();
  st.lockAppearance = true;            // å®¹å§¿ã¯å›ºå®šã€æ€§æ ¼ã ã‘å¤‰æ›´
  st.personaColor = null;              // æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã§æ±ºã‚ã‚‹
  saveState(st);

  applyAppearance(st);
  stageBadge.textContent = st.stage;
  addBubble('sys', `å¾©æ´»ã®å„€ï¼šå®¹å§¿ã‚’æ®‹ã—ã¾ã—ãŸã€‚æ–°ã—ã„åå‰ã¯ã€Œ${finalName}ã€ã€‚æ¬¡ã®ãƒã‚«ãƒ­ãƒ³ã§â€œæ€§æ ¼â€ã ã‘é¸ã‚“ã§ã­ã€‚`);
  showRandomMacaron();
  renderHistory(st.history);
  choiceArea.style.display = 'none';
});

/* ===== è¦æ—¨ç”Ÿæˆï¼ˆãƒ©ã‚¤ãƒˆè¦ç´„ï¼‰ ===== */
function makeSummary(logs){
  const users = logs.filter(l=>l.role==='user').map(l=>l.text);
  const first = users[0] || '';
  const last  = users[users.length-1] || '';
  return `ç™ºè©±${users.length}ä»¶ã€‚æœ€åˆã€Œ${first.slice(0,18)}ã€/ æœ€å¾Œã€Œ${last.slice(0,18)}ã€`;
}

/* ===== Start Overlay ãƒ­ã‚¸ãƒƒã‚¯ ===== */
function hasSave(){
  try {
    const s = JSON.parse(localStorage.getItem(KEY));
    return s && (s.logs?.length || s.appearanceColor || s.personaColor || s.history?.length);
  } catch { return false; }
}
function startNewGame(){
  localStorage.removeItem(KEY);
  init();             // ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚«ãƒ­ãƒ³ï¼†æœªé¸æŠ
  startOverlay.style.display = 'none';
}
function continueGame(){
  init();             // ä¿å­˜ã‚’ãã®ã¾ã¾å¾©å…ƒï¼ˆæœ€å¾Œã«æ®‹ã£ã¦ãŸã‚­ãƒ£ãƒ©ã§å†é–‹ï¼‰
  startOverlay.style.display = 'none';
}

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('ä¿å­˜ã•ã‚ŒãŸä¼šè©±ãƒ»çŠ¶æ…‹ãƒ»å±¥æ­´ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem(KEY);
  init();
});

/* ===== åˆæœŸåŒ– ===== */
function init(){
  // åˆå›ã®ã¿ï¼šä¿å­˜ãŒã‚ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆé¸æŠã‚’è¡¨ç¤º
  if (init.firstRun !== false && hasSave()) {
    const st = loadState();
    const nm = st.name || localStorage.getItem('whoai_name') || 'ã¨ã‚‚ã ã¡';
    const app = st.appearanceColor || 'æœªé¸æŠ';
    const per = st.personaColor || app || 'æœªé¸æŠ';
    const turns = (st.logs||[]).filter(l=>l.role==='user').length;
    savePreview.textContent = `åå‰: ${nm} / å®¹å§¿: ${app} / æ€§æ ¼: ${per} / ç™ºè©±: ${turns}ä»¶`;
    startOverlay.style.display = 'flex';
    continueBtn.onclick = continueGame;
    newBtn.onclick = startNewGame;
    init.firstRun = false;
    return;
  }
  init.firstRun = false;

  const st = loadState();
  if(!st.name){
    st.name = localStorage.getItem('whoai_name') || 'ã¨ã‚‚ã ã¡';
    st.startedAt = new Date().toISOString();
    saveState(st);
  }
  applyAppearance(st);
  stageBadge.textContent = st.stage || 'tane';
  nameBadge.textContent = st.name ? `åå‰: ${st.name}` : '';
  chatArea.innerHTML = '';
  (st.logs||[]).forEach(m=> addBubble(m.role, m.text));
  renderHistory(st.history || []);

  if(st.lockAppearance){
    showRandomMacaron();               // æ€§æ ¼ã ã‘é¸ã¶ãŸã‚ã®ãƒ©ãƒ³ãƒ€ãƒ 
  }else{
    if(st.appearanceColor){
      macaronImg.src = IMG.macaron(st.appearanceColor);
      macaronImg.dataset.color = st.appearanceColor;
    }else{
      showRandomMacaron();
    }
  }
  const turns = (st.logs||[]).filter(l=>l.role==='user').length;
  evolveBtn.style.opacity = (turns>=10)?'1':'0.5';
}
init();
</script>
</body>
</html>
