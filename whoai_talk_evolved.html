<!-- FILE: /macaron/whoai_talk_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - 進化後</title>
  <style>
    html, body { height:100%; margin:0; }
    body {
      font-family:"Noto Sans JP",system-ui,sans-serif;
      color:#fff; background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover; background-position:center; background-attachment:fixed;
      display:flex; flex-direction:column; align-items:center; padding:16px; gap:12px;
    }

    .topbar {
      width:100%; max-width:880px;
      display:flex; gap:8px; padding:8px 10px;
      border-radius:14px; background:rgba(0,0,0,.35); backdrop-filter:blur(3px);
      font-size:12px;
    }
    .badge { padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); }

    /* ===== ステージを横並びに修正 ===== */
    .stage {
      width:100%; max-width:880px;
      border-radius:16px; padding:14px;
      background:rgba(0,0,0,.35); backdrop-filter:blur(4px);
      display:grid; grid-template-columns:160px 1fr; gap:14px;
    }
    .avatar-zone { display:flex; justify-content:center; align-items:flex-start; }
    .avatar-zone img { width:140px; filter:drop-shadow(0 6px 16px rgba(0,0,0,.45)); }

    .chat-zone { display:flex; flex-direction:column; gap:10px; }
    .name-row { font-weight:700; opacity:.95; }

    #chatArea {
      background:rgba(255,255,255,.1);
      border-radius:12px; padding:12px;
      height:400px; overflow-y:auto; scroll-behavior:smooth;
    }
    .msg { margin:8px 0; display:flex; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .bubble {
      max-width:75%; padding:10px 12px;
      border-radius:12px; line-height:1.6;
      white-space:pre-wrap; word-wrap:break-word;
      background:rgba(255,255,255,.12);
    }
    .msg.user .bubble { background:rgba(61,180,255,.2); }
    .msg.assistant .bubble { background:rgba(255,97,200,.2); }
    .role { display:block; font-size:12px; opacity:.8; margin-bottom:4px; }

    .controls { display:flex; gap:6px; align-items:center; }
    input[type="text"] {
      flex:1; padding:10px 12px; border-radius:10px; border:none;
      background:rgba(255,255,255,.9); color:#111; outline:none;
    }
    button {
      padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700;
      background:#ffd1ec; color:#111;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    select { padding:8px; border-radius:8px; }

    .hint { font-size:12px; opacity:.85; margin-top:6px; }

    /* スマホでは縦並びに */
    @media (max-width:680px){
      .stage{ grid-template-columns:1fr; }
      .avatar-zone{ order:2; margin-top:8px; }
      .chat-zone{ order:1; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="badge">FILE: /macaron/whoai_talk_evolved.html</span>
    <span class="badge" id="userBadge">user:-</span>
    <span class="badge" id="convoBadge">convo:-</span>
    <span class="badge" id="turnBadge">turn:0/10</span>
  </div>

  <div class="stage">
    <div class="avatar-zone">
      <img id="charImg" alt="character"/>
    </div>
    <div class="chat-zone">
      <div class="name-row">会話相手：<span id="assistantName">WhoAI</span>（進化後）</div>
      <div id="chatArea"></div>

      <div class="controls">
        <input id="userInput" type="text" placeholder="メッセージを入力…" />
        <button id="btnSend">送信</button>
        <button id="btnMic">🎙️</button>
        <button id="btnTTS">🔊</button>
        <select id="langSelect">
          <option value="ja-JP">日本語</option>
          <option value="en-US">English</option>
          <option value="zh-CN">中文(简体)</option>
          <option value="zh-TW">中文(繁體)</option>
          <option value="ko-KR">한국어</option>
        </select>
      </div>

      <div class="hint">※ 会話はlocalStorageに保存され、直近12発言をAPIに送信。10ターンで終了。</div>
    </div>
  </div>

<script>
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const WINDOW_N = 12;
  const TURN_LIMIT = 10;

  // キャラ画像（進化後 closed/open）
  const COLOR_TO_IMG = {
    pink:   { closed:'public/assets/stage1/pink_closed.png', open:'public/assets/stage1/pink_open.png' },
    blue:   { closed:'public/assets/stage1/blue_closed.png', open:'public/assets/stage1/blue_open.png' },
    green:  { closed:'public/assets/stage1/green_closed.png', open:'public/assets/stage1/green_open.png' },
    purple: { closed:'public/assets/stage1/purple_closed.png', open:'public/assets/stage1/purple_open.png' }
  };

  // localStorage
  const getOrCreate = (k) => { let v=localStorage.getItem(k); if(v) return v; v=crypto.randomUUID(); localStorage.setItem(k,v); return v; };
  const userId = getOrCreate('whoai_userId');
  const convoId = getOrCreate('whoai_convoId');
  const key = (s)=>`whoai:${userId}:${convoId}:${s}`;
  const readLog = ()=>JSON.parse(localStorage.getItem(key('chatLog'))||'[]');
  const writeLog = (log)=>localStorage.setItem(key('chatLog'),JSON.stringify(log));

  const color = (localStorage.getItem('whoai_color')||'pink').toLowerCase();
  let turn = parseInt(localStorage.getItem(key('turn'))||'0');

  // UI
  document.getElementById('userBadge').textContent=`user:${userId.slice(0,6)}`;
  document.getElementById('convoBadge').textContent=`convo:${convoId.slice(0,6)}`;
  document.getElementById('turnBadge').textContent=`turn:${turn}/${TURN_LIMIT}`;
  const charImg=document.getElementById('charImg');
  charImg.src=COLOR_TO_IMG[color]?.closed || '';

  const chatArea=document.getElementById('chatArea');
  const renderChat=()=>{
    const log=readLog(); chatArea.innerHTML='';
    for(const m of log){
      const div=document.createElement('div'); div.className=`msg ${m.role}`;
      const bubble=document.createElement('div'); bubble.className='bubble';
      const role=document.createElement('span'); role.className='role';
      role.textContent=(m.role==='user'?'あなた':'WhoAI')+'：';
      bubble.appendChild(role);
      bubble.appendChild(document.createTextNode(m.content));
      div.appendChild(bubble); chatArea.appendChild(div);
    }
    chatArea.scrollTop=chatArea.scrollHeight;
  };
  renderChat();

  // 会話処理
  async function talk(userText){
    if(turn>=TURN_LIMIT){ alert("進化後の会話は終了しました。"); return; }
    let log=readLog(); log.push({role:'user',content:userText,ts:Date.now()});
    writeLog(log); renderChat();

    charImg.src=COLOR_TO_IMG[color].open;

    const history=log.slice(-WINDOW_N);
    let replyText='';
    try{
      const res=await fetch(TALK_ENDPOINT,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userMessage:userText,history})
      });
      const data=await res.json();
      replyText=data.reply||'…';
    }catch{ replyText='（通信エラー）'; }

    log=readLog(); log.push({role:'assistant',content:replyText,ts:Date.now()});
    writeLog(log); renderChat();

    setTimeout(()=>{ charImg.src=COLOR_TO_IMG[color].closed; },400);

    const lang=document.getElementById('langSelect').value;
    speakCute(replyText,lang);

    turn++; localStorage.setItem(key('turn'),turn);
    document.getElementById('turnBadge').textContent=`turn:${turn}/${TURN_LIMIT}`;
  }

  // 入力・ボタン
  const userInput=document.getElementById('userInput');
  document.getElementById('btnSend').onclick=()=>{
    const t=userInput.value.trim(); if(!t) return;
    userInput.value=''; talk(t);
  };
  userInput.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.isComposing){ e.preventDefault(); document.getElementById('btnSend').click(); }
  });

  // 音声入力
  document.getElementById('btnMic').onclick=()=>{
    const lang=document.getElementById('langSelect').value;
    const rec=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
    rec.lang=lang; rec.onresult=(e)=>{
      userInput.value=e.results[0][0].transcript;
      document.getElementById('btnSend').click();
    };
    rec.start();
  };

  // 音声出力（直近AIの発話）
  document.getElementById('btnTTS').onclick=()=>{
    const log=readLog(); const last=log.slice().reverse().find(m=>m.role==='assistant');
    if(last){ speakCute(last.content,document.getElementById('langSelect').value); }
  };

  // かわいらしい声
  function speakCute(text,lang){
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang=lang; utter.rate=1.05; utter.pitch=1.6; utter.volume=1;
    const voices=speechSynthesis.getVoices();
    const cute=voices.find(v=>v.lang.startsWith(lang)&&/(female|girl|child|Kyoko|Google 日本語)/i.test(v.name));
    if(cute) utter.voice=cute;
    speechSynthesis.speak(utter);
  }
</script>
</body>
</html>
