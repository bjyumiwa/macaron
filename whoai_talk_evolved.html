<!-- FILE: /macaron/whoai_talk_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - ä¼šè©±ï¼ˆé€²åŒ–å¾Œï¼‹éŸ³å£°/å¤šè¨€èªï¼‰</title>
  <style>
    html, body { height:100%; margin:0; }
    body {
      font-family:"Noto Sans JP", system-ui, sans-serif;
      color:#fff; background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover; background-position:center; background-attachment:fixed;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      padding:16px; gap:12px;
    }
    .topbar {
      width:100%; max-width:880px; display:flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:14px;
      background:rgba(0,0,0,.35); backdrop-filter:blur(3px);
    }
    .filetag,.badge { font-size:12px; opacity:.9; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); }
    .stage {
      width:100%; max-width:880px; border-radius:16px; padding:14px;
      background:rgba(0,0,0,.35); backdrop-filter:blur(4px);
      display:grid; grid-template-columns:160px 1fr; gap:14px;
    }
    .avatar-zone { display:flex; align-items:flex-start; justify-content:center; }
    .avatar-zone img { width:160px; height:auto; filter:drop-shadow(0 6px 16px rgba(0,0,0,.45)); }
    .chat-zone { display:flex; flex-direction:column; gap:10px; }
    .name-row { font-weight:700; opacity:.95; }
    #chatArea {
      background:rgba(255,255,255,.1); border-radius:12px; padding:12px;
      height:420px; overflow-y:auto; scroll-behavior:smooth;
    }
    .msg { margin:8px 0; display:flex; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .bubble {
      max-width:75%; padding:10px 12px; border-radius:12px; line-height:1.6;
      white-space:pre-wrap; word-wrap:break-word;
      background:rgba(255,255,255,.12);
    }
    .msg.user .bubble { background:rgba(61,180,255,.2); }
    .msg.assistant .bubble { background:rgba(255,97,200,.2); }
    .role { display:block; font-size:12px; opacity:.8; margin-bottom:4px; }
    .controls { display:flex; gap:8px; align-items:center; }
    input[type="text"] {
      flex:1; padding:10px 12px; border-radius:10px; border:none;
      background:rgba(255,255,255,.9); color:#111; outline:none;
    }
    button {
      padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700;
      background:#ffd1ec; color:#111;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    select { padding:4px; border-radius:6px; }
    .hint { font-size:12px; opacity:.85; margin-top:8px; }
    @media (max-width:680px){
      .stage { grid-template-columns:1fr; }
      .avatar-zone { order:2; }
      .chat-zone { order:1; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="filetag">FILE: /macaron/whoai_talk_evolved.html</span>
    <span class="badge" id="userBadge">user: -</span>
    <span class="badge" id="convoBadge">convo: -</span>
    <span class="badge" id="turnBadge">turn: -/10</span>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <select id="langSelect" title="è¨€èª">
        <option value="auto">Auto</option>
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="en-US">English</option>
        <option value="zh-CN">ä¸­æ–‡(ç®€ä½“)</option>
        <option value="zh-TW">ä¸­æ–‡(ç¹é«”)</option>
        <option value="ko-KR">í•œêµ­ì–´</option>
      </select>
      <button id="btnMic" title="éŸ³å£°å…¥åŠ›">ğŸ™ï¸</button>
      <button id="btnTTS" title="èª­ã¿ä¸Šã’ ON/OFF">ğŸ”Š</button>
    </div>
  </div>

  <div class="stage">
    <div class="avatar-zone">
      <img id="charImg" alt="character" src="" />
    </div>
    <div class="chat-zone">
      <div class="name-row">ä¼šè©±ç›¸æ‰‹ï¼š<span id="assistantName">WhoAI</span>ï¼ˆé€²åŒ–å¾Œï¼‰</div>
      <div id="chatArea"></div>
      <div class="controls">
        <input id="userInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦ï¼ˆEnterã§é€ä¿¡ï¼‰" />
        <button id="btnSend">é€ä¿¡</button>
      </div>
      <div class="hint">â€» localStorage ã«ä¼šè©±ã‚’ä¿å­˜ã€‚ç›´è¿‘12ç™ºè¨€ã‚’APIã¸é€ä¿¡ã€‚10ã‚¿ãƒ¼ãƒ³åˆ°é”ã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã€‚</div>
    </div>
  </div>

<script>
  // ===== åŸºæœ¬è¨­å®š =====
  const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
  const WINDOW_N = 12;
  const MAX_TURNS = 10;

  // ===== ID æ°¸ç¶šåŒ– =====
  const getOrCreate = (k) => {
    const v = localStorage.getItem(k);
    if (v) return v;
    const nv = crypto.randomUUID();
    localStorage.setItem(k, nv);
    return nv;
  };
  const userId = getOrCreate('whoai_userId');
  const convoId = getOrCreate('whoai_conversationId');

  if (localStorage.getItem('whoai_turn') == null) localStorage.setItem('whoai_turn','0');
  const readTurn = () => parseInt(localStorage.getItem('whoai_turn')||'0',10);
  const writeTurn = (n) => localStorage.setItem('whoai_turn', String(n));

  // ===== ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚° =====
  const EVOLVED_SRC = {
    pink:{closed:'pink_closed.png',open:'pink_open.png'},
    blue:{closed:'blue_closed.png',open:'blue_open.png'},
    green:{closed:'green_closed.png',open:'green_open.png'},
    purple:{closed:'purple_closed.png',open:'purple_open.png'}
  };
  const base='public/assets/stage1';
  const color=(localStorage.getItem('macaronColor')||'green').toLowerCase();
  const charImg=document.getElementById('charImg');
  const setClosed=()=>charImg.src=`${base}/${(EVOLVED_SRC[color]?.closed)||EVOLVED_SRC.green.closed}`;
  const setOpen=()=>charImg.src=`${base}/${(EVOLVED_SRC[color]?.open)||EVOLVED_SRC.green.open}`;
  setClosed();
  function speakAnimation(){ setOpen(); setTimeout(setClosed,1200); }

  // ===== ä¼šè©±ãƒ­ã‚° =====
  const key=(s)=>`whoai:evolved:${userId}:${convoId}:${s}`;
  const readLog=()=>JSON.parse(localStorage.getItem(key('chatLog'))||'[]');
  const writeLog=(log)=>localStorage.setItem(key('chatLog'),JSON.stringify(log));

  // ===== UI =====
  const playerName=localStorage.getItem('whoai_player_name')||'ã‚ãªãŸ';
  const assistantName=localStorage.getItem('whoai_character_name')||'WhoAI';
  document.getElementById('assistantName').textContent=assistantName;
  document.getElementById('userBadge').textContent=`user: ${userId.slice(0,8)}`;
  document.getElementById('convoBadge').textContent=`convo: ${convoId.slice(0,8)}`;
  const turnBadge=document.getElementById('turnBadge');
  const updateTurnBadge=()=>turnBadge.textContent=`turn: ${readTurn()}/${MAX_TURNS}`;
  updateTurnBadge();

  const chatArea=document.getElementById('chatArea');
  function renderChat(){
    const log=readLog();
    chatArea.innerHTML='';
    for(const m of log){
      const div=document.createElement('div'); div.className=`msg ${m.role}`;
      const bubble=document.createElement('div'); bubble.className='bubble';
      const role=document.createElement('span'); role.className='role';
      role.textContent=(m.role==='user')?`${playerName}ï¼š`:`${assistantName}ï¼š`;
      bubble.appendChild(role);
      bubble.appendChild(document.createTextNode(m.content||'')); div.appendChild(bubble);
      chatArea.appendChild(div);
    }
    chatArea.scrollTop=chatArea.scrollHeight; updateTurnBadge();
  }
  renderChat();

  // ===== è¨€èª & éŸ³å£°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const LANG_KEY='whoai_lang'; const TTS_KEY='whoai_tts_on';
  const langSelect=document.getElementById('langSelect');
  const btnMic=document.getElementById('btnMic');
  const btnTTS=document.getElementById('btnTTS');
  langSelect.value=localStorage.getItem(LANG_KEY)||'auto';
  btnTTS.textContent=((localStorage.getItem(TTS_KEY)??'1')==='1')?'ğŸ”Š':'ğŸ”ˆ';

  function currentLang(){return langSelect.value;}
  function shortLang(v){if(v.startsWith('ja'))return'Japanese';
    if(v.startsWith('en'))return'English';
    if(v==='zh-TW')return'Traditional Chinese';
    if(v.startsWith('zh'))return'Chinese';
    if(v.startsWith('ko'))return'Korean';
    return'Auto';}

  // STT
  let recognition=null,recognizing=false;
  function ensureRecognizer(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR)return null;
    if(recognition)return recognition;
    recognition=new SR(); recognition.interimResults=false;
    recognition.continuous=false; recognition.maxAlternatives=1;
    recognition.onresult=(e)=>{
      const text=e.results[0][0].transcript||'';
      userInput.value=text; btnSend.click();
    };
    recognition.onend=()=>{recognizing=false;updateMicUI();};
    recognition.onerror=()=>{recognizing=false;updateMicUI();};
    return recognition;
  }
  function startSTT(){
    const rec=ensureRecognizer(); if(!rec){alert('éŸ³å£°å…¥åŠ›æœªå¯¾å¿œ');return;}
    const lang=currentLang(); rec.lang=(lang==='auto')?navigator.language:lang;
    recognizing=true; updateMicUI(); try{rec.start();}catch{}
  }
  function stopSTT(){ if(recognition)recognition.stop(); recognizing=false; updateMicUI(); }
  function updateMicUI(){ btnMic.textContent=recognizing?'ğŸ›‘':'ğŸ™ï¸'; }

  // TTS
  function speakTTS(text,lang){
    const on=(localStorage.getItem(TTS_KEY)??'1')==='1'; if(!on)return;
    if(!('speechSynthesis'in window))return;
    const u=new SpeechSynthesisUtterance(text);
    const target=(lang&&lang!=='auto')?lang:(navigator.language||'ja-JP');
    const voices=window.speechSynthesis.getVoices();
    const v=voices.find(v=>v.lang===target)||voices.find(v=>v.lang.startsWith(target.split('-')[0]))||null;
    if(v)u.voice=v; u.lang=v?.lang||target;
    window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }
  window.speechSynthesis.onvoiceschanged=()=>{};

  langSelect.addEventListener('change',()=>localStorage.setItem(LANG_KEY,langSelect.value));
  btnMic.addEventListener('click',()=>{if(recognizing)stopSTT();else startSTT();});
  btnTTS.addEventListener('click',()=>{
    const now=(localStorage.getItem(TTS_KEY)??'1')==='1';
    localStorage.setItem(TTS_KEY,now?'0':'1');
    btnTTS.textContent=now?'ğŸ”ˆ':'ğŸ”Š'; window.speechSynthesis.cancel();
  });

  // ===== talk =====
  async function talk(userText){
    if(!userText.trim())return;
    let log=readLog(); log.push({role:'user',content:userText,ts:Date.now()});
    writeLog(log); renderChat();

    const history=log.slice(-WINDOW_N).map(({role,content})=>({role,content}));
    const cl=currentLang();
    const sys=(cl==='auto')
      ?'You are a kind partner AI. Reply briefly in the same language as the user.'
      :`You are a kind partner AI. Reply briefly in ${shortLang(cl)}.`;
    const messages=[{role:'system',content:sys},...history,{role:'user',content:userText}];

    let replyText='';
    try{
      const res=await fetch(TALK_ENDPOINT,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'gpt-4o-mini',temperature:0.7,max_tokens:220,messages})
      });
      const data=await res.json().catch(()=>({}));
      replyText=data.reply||'â€¦';
    }catch(e){replyText='ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰';}

    log=readLog(); log.push({role:'assistant',content:replyText,ts:Date.now()});
    writeLog(log); renderChat();

    speakAnimation();
    speakTTS(replyText,currentLang());

    let turn=readTurn(); turn+=1; writeTurn(turn); updateTurnBadge();
    if(turn>=MAX_TURNS){ setTimeout(()=>{location.href='identity_check.html';},800); }
  }

  const userInput=document.getElementById('userInput');
  const btnSend=document.getElementById('btnSend');
  btnSend.addEventListener('click',()=>{
    const t=userInput.value.trim(); if(!t)return;
    userInput.value=''; talk(t);
  });
  userInput.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'&&!e.isComposing){e.preventDefault();btnSend.click();}
  });
</script>
</body>
</html>
