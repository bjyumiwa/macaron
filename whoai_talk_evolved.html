<!-- FILE: /macaron/whoai_talk_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - 会話（進化後）</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body {
      font-family: "Noto Sans JP", system-ui, sans-serif;
      color: #fff;
      background: #000;
      background-image: url("public/assets/stage1/space_background.png");
      background-size: cover; background-position: center; background-attachment: fixed;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding: 16px; gap: 12px;
    }
    .topbar {
      width: 100%; max-width: 880px; display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 14px;
      background: rgba(0,0,0,.35); backdrop-filter: blur(3px);
    }
    .filetag, .badge {
      font-size: 12px; opacity:.9; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,.12);
    }
    .stage {
      width: 100%; max-width: 880px; border-radius: 16px; padding: 14px;
      background: rgba(0,0,0,.35); backdrop-filter: blur(4px);
      display: grid; grid-template-columns: 160px 1fr; gap: 14px;
    }
    .avatar-zone { display:flex; align-items:flex-start; justify-content:center; }
    .avatar-zone img { width: 160px; height: auto; filter: drop-shadow(0 6px 16px rgba(0,0,0,.45)); }
    .chat-zone { display:flex; flex-direction:column; gap:10px; }
    .name-row { font-weight:700; opacity:.95; }
    #chatArea {
      background: rgba(255,255,255,.1); border-radius: 12px; padding: 12px;
      height: 420px; overflow-y: auto; scroll-behavior: smooth;
    }
    .msg { margin: 8px 0; display:flex; }
    .msg.user { justify-content: flex-end; }
    .msg.assistant { justify-content: flex-start; }
    .bubble {
      max-width: 75%; padding: 10px 12px; border-radius: 12px; line-height: 1.6;
      white-space: pre-wrap; word-wrap: break-word; background: rgba(255,255,255,.12);
    }
    .msg.user .bubble { background: rgba(61,180,255,.2); }
    .msg.assistant .bubble { background: rgba(255,97,200,.2); }
    .role { display:block; font-size: 12px; opacity:.8; margin-bottom:4px; }
    .controls { display:flex; gap:8px; align-items:center; }
    input[type="text"] {
      flex: 1; padding: 10px 12px; border-radius: 10px; border: none;
      background: rgba(255,255,255,.9); color: #111; outline: none;
    }
    button {
      padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700;
      background: #ffd1ec; color: #111;
    }
    button:disabled { opacity:.6; cursor: not-allowed; }
    .hint { font-size: 12px; opacity:.85; margin-top:8px; }
    @media (max-width: 680px) {
      .stage { grid-template-columns: 1fr; }
      .avatar-zone { order: 2; }
      .chat-zone { order: 1; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="filetag">FILE: /macaron/whoai_talk_evolved.html</span>
    <span class="badge" id="userBadge">user: -</span>
    <span class="badge" id="convoBadge">convo: -</span>
    <span class="badge" id="windowBadge">window: 12</span>
  </div>

  <div class="stage">
    <div class="avatar-zone">
      <img id="charImg" alt="character" src="" />
    </div>
    <div class="chat-zone">
      <div class="name-row">会話相手：<span id="assistantName">WhoAI</span>（進化後）</div>
      <div id="chatArea"></div>
      <div class="controls">
        <input id="userInput" type="text" placeholder="メッセージを入力…（Enterで送信）" />
        <button id="btnSend">送信</button>
      </div>
      <div class="hint">※ 直近12発言をAPIに同封し、会話はlocalStorageに保存されます。</div>
    </div>
  </div>

  <script>
    const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';
    const WINDOW_N = 12;

    // 色ごとの画像マッピング
    const EVOLVED_SRC = {
      pink:   { closed: 'pink_closed.png',  open: 'pink_open.png' },
      blue:   { closed: 'blue_closed.png',  open: 'blue_open.png' },
      green:  { closed: 'green_closed.png', open: 'green_open.png' },
      purple: { closed: 'purple_closed.png',open: 'purple_open.png' }
    };
    const color = (localStorage.getItem('macaronColor') || 'green').toLowerCase();
    const base = 'public/assets/stage1';
    const charImg = document.getElementById('charImg');

    // 初期は閉じ目
    charImg.src = `${base}/${EVOLVED_SRC[color]?.closed || EVOLVED_SRC.green.closed}`;

    // 喋ったときに開くアニメーション
    function speakAnimation() {
      charImg.src = `${base}/${EVOLVED_SRC[color]?.open || EVOLVED_SRC.green.open}`;
      setTimeout(()=>{
        charImg.src = `${base}/${EVOLVED_SRC[color]?.closed || EVOLVED_SRC.green.closed}`;
      }, 1200);
    }

    // 会話ログ管理
    const key = (s) => `whoai:evolved:${s}`;
    const readLog = () => JSON.parse(localStorage.getItem(key('chatLog')) || '[]');
    const writeLog = (log) => localStorage.setItem(key('chatLog'), JSON.stringify(log));

    const playerName = 'あなた';
    const assistantName = 'WhoAI';

    const chatArea = document.getElementById('chatArea');
    function renderChat() {
      const log = readLog();
      chatArea.innerHTML = '';
      for (const m of log) {
        const div = document.createElement('div');
        div.className = `msg ${m.role}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const role = document.createElement('span');
        role.className = 'role';
        role.textContent = (m.role==='user')?`${playerName}：`:`${assistantName}：`;
        bubble.appendChild(role);
        bubble.appendChild(document.createTextNode(m.content||''));
        div.appendChild(bubble);
        chatArea.appendChild(div);
      }
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    renderChat();

    // 送信処理
    async function talk(userText) {
      if (!userText) return;
      let log = readLog();
      log.push({ role:'user', content:userText, ts:Date.now() });
      writeLog(log); renderChat();

      const history = log.slice(-WINDOW_N).map(({role,content})=>({role,content}));
      let replyText = '';
      try {
        const res = await fetch(TALK_ENDPOINT,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userText, history })
        });
        const data = await res.json().catch(()=>({}));
        replyText = data.reply || data.message || data.content || '…';
      } catch(e) {
        replyText = '（通信エラー）';
      }

      // ログにassistant追加
      log = readLog();
      log.push({ role:'assistant', content:replyText, ts:Date.now() });
      writeLog(log); renderChat();

      // 喋ったら目を開ける演出
      speakAnimation();
    }

    // イベント
    const userInput=document.getElementById('userInput');
    const btnSend=document.getElementById('btnSend');
    btnSend.addEventListener('click',()=>{
      const t=userInput.value.trim();
      if(!t) return;
      userInput.value='';
      talk(t);
    });
    userInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.isComposing){e.preventDefault();btnSend.click();}
    });
  </script>
</body>
</html>
