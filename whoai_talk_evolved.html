<!-- FILE: public/macaron/whoai_talk_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WhoAI 進化キャラと会話</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;
      background:url("/public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start
    }
    .chips{margin-top:12px}
    .chip{
      background:#222;padding:6px 12px;border-radius:16px;
      font-size:14px;margin:4px;display:inline-block;opacity:0.8
    }
    .title{margin-top:6px;font-size:22px;font-weight:bold}
    .subtitle{font-size:14px;opacity:0.8;margin-bottom:12px}

    .hero img{width:130px;margin:6px auto;display:block;animation:bounce 3s infinite ease-in-out}
    .hero small{display:block;text-align:center;margin-top:-10px;color:#ccc}

    @keyframes bounce {
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-8px)}
    }

    .card{
      background:rgba(0,0,0,.4);backdrop-filter:blur(3px);
      border-radius:12px;width:90%;max-width:720px;
      margin:12px;padding:12px;min-height:360px;
      overflow-y:auto;flex:1
    }

    .bubble{
      background:#fff;color:#333;padding:10px 14px;
      border-radius:16px;margin:8px 0;display:inline-block;
      max-width:75%;line-height:1.6;white-space:pre-wrap
    }
    .right{text-align:right}
    .right .bubble{background:#4fc3f7;color:#fff}
    .chat-row{margin-bottom:6px}

    .input-box{margin:12px;width:100%;max-width:720px;display:flex}
    .input-box input{
      flex:1;padding:10px;border:none;border-radius:20px;
      outline:none;font-size:16px
    }
    .input-box button{
      margin-left:6px;padding:10px 16px;border:none;
      background:#4fc3f7;color:#fff;font-weight:bold;
      border-radius:20px;cursor:pointer
    }

    .lang-switch{position:fixed;top:8px;right:10px;font-size:12px}
    .lang-switch button{
      background:transparent;border:none;color:#fff;
      margin:0 2px;cursor:pointer;font-weight:bold
    }
  </style>
</head>
<body>
  <div class="lang-switch">
    <button onclick="setLang('ja')">日本語</button>
    <button onclick="setLang('en')">EN</button>
    <button onclick="setLang('zh')">中文</button>
    <button onclick="setLang('ko')">KO</button>
  </div>

  <div class="chips">
    <span class="chip"><span id="charName">-</span> | <span id="chipColor">-</span> | evolved</span>
    <span class="chip">turn: <span id="turnChip">0</span>/10</span>
  </div>
  <div class="title">会話</div>
  <div class="subtitle">進化キャラと10回話すと復活の儀式へ進みます</div>

  <div class="hero">
    <img id="charImg" src="" alt="キャラ画像">
    <small>進化後の姿</small>
  </div>

  <div class="card" id="chatArea"></div>

  <div class="input-box">
    <input type="text" id="userInput" placeholder="メッセージを入力..." />
    <button onclick="sendMessage()">送信</button>
  </div>

  <script>
    const TALK_ENDPOINT = 'https://macaron-one.vercel.app/api/talk';

    const macaronColor = localStorage.getItem("macaronColor") || "pink";
    const charName = localStorage.getItem("characterName") || "pp";
    const yourName = localStorage.getItem("yourName") || "あなた";
    let lang = localStorage.getItem("whoai_lang") || "ja";
    let turn = parseInt(localStorage.getItem("whoai_turn") || "0");

    document.getElementById("chipColor").textContent = macaronColor;
    document.getElementById("charName").textContent = charName;
    document.getElementById("turnChip").textContent = turn;

    const chatArea = document.getElementById("chatArea");

    function addBubble(text, isUser) {
      const div = document.createElement("div");
      div.className = "chat-row " + (isUser ? "right" : "left");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = (isUser ? `${yourName}：` : `${charName}：`) + text;
      div.appendChild(bubble);
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("userInput");
      const msg = input.value.trim();
      if (!msg) return;
      addBubble(msg, true);
      input.value = "";
      fetch(TALK_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg, lang })
      })
      .then(res => res.json())
      .then(data => {
        addBubble(data.response || "…", false);
        turn++;
        localStorage.setItem("whoai_turn", turn);
        document.getElementById("turnChip").textContent = turn;
        if (turn >= 10) {
          setTimeout(() => location.href = "rebirth.html", 1000);
        }
      })
      .catch(() => addBubble("エラーが発生しました", false));
    }

    document.getElementById("userInput").addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    function setLang(l) {
      lang = l;
      localStorage.setItem("whoai_lang", l);
    }

    // キャラ画像設定
    const charImg = document.getElementById("charImg");
    const base = "/public/assets/stage1";
    const openEyes = {
      pink:   "pink_open.png",
      blue:   "blue_open.png",
      green:  "green_open.png",
      purple: "purple_open.png"
    };
    charImg.src = `${base}/${openEyes[macaronColor] || openEyes.purple}`;
  </script>
</body>
</html>
