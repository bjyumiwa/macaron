<!-- 修正版: /macaron/whoai_talk_evolved.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI - 会話（進化後＋音声/多言語）</title>
  <style>
    html, body { height:100%; margin:0; }
    body {
      font-family:"Noto Sans JP", system-ui, sans-serif;
      color:#fff; background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover; background-position:center; background-attachment:fixed;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      padding:16px; gap:12px;
    }
    .topbar {
      width:100%; max-width:880px; display:flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:14px;
      background:rgba(0,0,0,.35); backdrop-filter:blur(3px);
    }
    .filetag,.badge { font-size:12px; opacity:.9; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.12); }
    .stage {
      width:100%; max-width:880px; border-radius:16px; padding:14px;
      background:rgba(0,0,0,.35); backdrop-filter:blur(4px);
      display:grid; grid-template-columns:160px 1fr; gap:14px;
    }
    .avatar-zone { display:flex; align-items:flex-start; justify-content:center; }
    .avatar-zone img { width:160px; height:auto; filter:drop-shadow(0 6px 16px rgba(0,0,0,.45)); }
    .chat-zone { display:flex; flex-direction:column; gap:10px; }
    .name-row { font-weight:700; opacity:.95; }
    #chatArea {
      background:rgba(255,255,255,.1); border-radius:12px; padding:12px;
      height:420px; overflow-y:auto; scroll-behavior:smooth;
    }
    .msg { margin:8px 0; display:flex; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .bubble {
      max-width:75%; padding:10px 12px; border-radius:12px; line-height:1.6;
      white-space:pre-wrap; word-wrap:break-word;
      background:rgba(255,255,255,.12);
    }
    .msg.user .bubble { background:rgba(61,180,255,.2); }
    .msg.assistant .bubble { background:rgba(255,97,200,.2); }
    .role { display:block; font-size:12px; opacity:.8; margin-bottom:4px; }
    .controls { display:flex; gap:6px; align-items:center; margin-top:6px; }
    input[type="text"] {
      flex:1; padding:10px 12px; border-radius:10px; border:none;
      background:rgba(255,255,255,.9); color:#111; outline:none;
    }
    button, select {
      padding:8px 12px; border-radius:8px; border:none; cursor:pointer;
      background:#ffd1ec; color:#111; font-weight:600;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:12px; opacity:.85; margin-top:4px; }
    @media (max-width:680px){
      .stage { grid-template-columns:1fr; }
      .avatar-zone { order:2; }
      .chat-zone { order:1; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="filetag">FILE: /macaron/whoai_talk_evolved.html</span>
    <span class="badge" id="userBadge">user: -</span>
    <span class="badge" id="convoBadge">convo: -</span>
    <span class="badge" id="turnBadge">turn: -/10</span>
  </div>

  <div class="stage">
    <div class="avatar-zone">
      <img id="charImg" alt="character" src="" />
    </div>
    <div class="chat-zone">
      <div class="name-row">会話相手：<span id="assistantName">WhoAI</span>（進化後）</div>
      <div id="chatArea"></div>

      <!-- 入力とボタンをまとめて下に -->
      <div class="controls">
        <input id="userInput" type="text" placeholder="メッセージを入力…（Enterで送信）" />
        <button id="btnSend">送信</button>
        <select id="langSelect">
          <option value="auto">Auto</option>
          <option value="ja-JP">日本語</option>
          <option value="en-US">English</option>
          <option value="zh-CN">中文(简体)</option>
          <option value="zh-TW">中文(繁體)</option>
          <option value="ko-KR">한국어</option>
        </select>
        <button id="btnMic">🎙️</button>
        <button id="btnTTS">🔊</button>
      </div>
      <div class="hint">※ 会話はlocalStorageに保存。直近12発言を送信。10ターン到達でアンケートへ。</div>
    </div>
  </div>

<script>
  // キャラ画像（進化後）
  const EVOLVED_SRC = {
    pink:{closed:'pink_closed.png',open:'pink_open.png'},
    blue:{closed:'blue_closed.png',open:'blue_open.png'},
    green:{closed:'green_closed.png',open:'green_open.png'},
    purple:{closed:'purple_closed.png',open:'purple_open.png'}
  };
  const base='public/assets/stage1';
  const color=(localStorage.getItem('macaronColor')||'green').toLowerCase();
  const charImg=document.getElementById('charImg');
  function setClosed(){ charImg.src=`${base}/${EVOLVED_SRC[color]?.closed||EVOLVED_SRC.green.closed}`; }
  function setOpen(){ charImg.src=`${base}/${EVOLVED_SRC[color]?.open||EVOLVED_SRC.green.open}`; }
  setClosed();

  // デバッグ: 色が未設定ならアラート
  if(!localStorage.getItem('macaronColor')){
    console.warn('macaronColor が未設定です。デフォルト green を使用中。');
  }

  // マイクボタン（安全な環境でのみ動作）
  let recognition=null,recognizing=false;
  function ensureRecognizer(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return null;
    if(recognition) return recognition;
    recognition=new SR();
    recognition.interimResults=false;
    recognition.continuous=false;
    recognition.onresult=(e)=>{
      const text=e.results[0][0].transcript||'';
      userInput.value=text; btnSend.click();
    };
    recognition.onend=()=>{recognizing=false;btnMic.textContent='🎙️';};
    recognition.onerror=()=>{recognizing=false;btnMic.textContent='🎙️';};
    return recognition;
  }
  document.getElementById('btnMic').addEventListener('click',()=>{
    if(recognizing){recognition.stop();return;}
    const rec=ensureRecognizer(); if(!rec){alert('音声入力未対応ブラウザです');return;}
    rec.lang=document.getElementById('langSelect').value||'ja-JP';
    recognizing=true; btnMic.textContent='🛑'; rec.start();
  });

  // 以下は前のコードと同じ（会話処理、TTS、ターン管理など）
</script>
</body>
</html>
