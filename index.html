<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAI スタート</title>
  <style>
    html,body{ height:100%; margin:0; font-family:"Noto Sans JP",sans-serif; }
    body{
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      color:#fff;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover; background-position:center; background-attachment:fixed;
      text-align:center; padding:20px;
    }
    .card{
      background:rgba(0,0,0,.55); backdrop-filter:blur(6px);
      border-radius:20px; padding:30px 24px;
      max-width:480px; width:92%;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    h1{ margin:0 0 12px; font-size:28px }
    p{ margin:0 0 20px; font-size:16px; line-height:1.6 }
    .miwacchi{ width:120px; margin:14px auto; display:block }

    .btn{
      display:inline-block; margin-top:10px; padding:12px 18px; border-radius:12px;
      background:#ffd1ec; color:#141217; font-weight:700; cursor:pointer; text-decoration:none;
    }
    .btn:hover{ opacity:.9 }

    .lang-row{
      margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
    }
    .lang-chip{
      border:0; border-radius:999px; padding:8px 12px;
      background:rgba(255,255,255,.14); color:#fff; font-weight:800; cursor:pointer;
    }
    .lang-chip[aria-pressed="true"]{
      outline:2px solid #ffd1ec; background:rgba(255,209,236,.18); color:#fff;
    }

    footer{ margin-top:14px; font-size:14px }
    footer a{ color:#ffd1ec; text-decoration:underline }
    footer a:hover{ opacity:1 }
  </style>
</head>
<body>
  <div class="card" aria-live="polite">
    <h1>WhoAIへようこそ</h1>
    <img src="public/assets/stage1/miwacchi_open.png" alt="みわっち" class="miwacchi">
    <p>あなたの選択で姿を変え、進化していきます。<br>たくさんの会話をお楽しみください。</p>

    <!-- スタート＝毎回フルリセット＋遷移 -->
    <a href="macaron.html" id="startBtn" class="btn">はじめる</a>

    <!-- 4か国語ボタン（見た目の行） -->
    <div class="lang-row" id="langRow" aria-label="言語を選択">
      <button type="button" class="lang-chip" data-lang="ja" aria-pressed="true">日本語</button>
      <button type="button" class="lang-chip" data-lang="en" aria-pressed="false">English</button>
      <button type="button" class="lang-chip" data-lang="zh" aria-pressed="false">中文</button>
      <button type="button" class="lang-chip" data-lang="ko" aria-pressed="false">한국어</button>
    </div>

    <footer>
      <a href="about.html">この研究について</a>
    </footer>
  </div>

  <script>
    // ===== 言語（UI用＋会話用）キー =====
    const UI_LANG_KEY = 'whoai_ui_lang';
    const APP_LANG_KEY = 'whoai_lang';
    const DEFAULT_LANG = 'ja';

    // 保存済みの言語を反映
    const saved = localStorage.getItem(UI_LANG_KEY) || localStorage.getItem(APP_LANG_KEY) || DEFAULT_LANG;
    const row = document.getElementById('langRow');
    function setActive(lang){
      row.querySelectorAll('.lang-chip').forEach(btn=>{
        btn.setAttribute('aria-pressed', btn.dataset.lang === lang ? 'true' : 'false');
      });
      localStorage.setItem(UI_LANG_KEY, lang);
      localStorage.setItem(APP_LANG_KEY, lang);
    }
    setActive(saved);

    // クリックで切替
    row.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lang-chip');
      if(!btn) return;
      setActive(btn.dataset.lang || DEFAULT_LANG);
    });

    // ===== スタート＝毎回フルリセット → macaron.html =====
    document.getElementById('startBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      const lang = (row.querySelector('.lang-chip[aria-pressed="true"]')?.dataset.lang) || DEFAULT_LANG;

      // 完全初期化
      try{
        Object.keys(localStorage).forEach(k=>{
          if (/^(whoai_|macaron)/.test(k)) localStorage.removeItem(k);
        });
        [
          'whoai_chat','whoai_name','whoai_character_name','whoai_player_name',
          'whoai_stage','whoai_keep','macaronColor','whoai_turn','whoai_phase',
          'whoai_userId','whoai_conversationId'
        ].forEach(k=>localStorage.removeItem(k));
      }catch(err){ console.warn('[reset error]', err); }

      // 言語だけ持ち越し
      localStorage.setItem(UI_LANG_KEY, lang);
      localStorage.setItem(APP_LANG_KEY, lang);

      location.href = 'macaron.html';
    });
  </script>
</body>
</html>
