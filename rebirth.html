<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>復活の儀式</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;
      background:#000; color:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      background:rgba(0,0,0,.65);
      border-radius:18px; padding:26px 22px; text-align:center;
      width:min(720px,94vw); box-shadow:0 8px 40px rgba(0,0,0,.5);
    }
    .card img{
      width:200px; max-width:70%; margin:18px auto; display:block;
      filter:drop-shadow(0 0 12px rgba(255,255,255,.3));
      animation: float 4s ease-in-out infinite, glow 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-10px) rotate(1deg);} }
    @keyframes glow  { 0%,100%{filter:drop-shadow(0 0 12px rgba(255,255,255,.3));}
                       50%{filter:drop-shadow(0 0 28px rgba(255,255,200,.8));} }
    .btn{
      display:inline-block; margin:10px 8px 0; padding:12px 16px;
      border-radius:12px; text-decoration:none; font-weight:800; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease; border:0;
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.3); }
    .btn-appearance{background:#f5a9d6; color:#000;}
    .btn-keep{background:#444; color:#fff;}
    .note{opacity:.8; font-size:13px; margin-top:8px}
  </style>
</head>
<body>
  <div class="card" aria-live="polite">
    <h2>復活の儀式</h2>
    <p>次のどちらかを選んでください（<strong>選択後は戻れません</strong>）。</p>

    <!-- アイテム画像 -->
    <img src="public/assets/stage1/drink_item.png" alt="復活アイテム">

    <p>
      <strong>容姿を選ぶ:</strong> 外見はそのまま、会話はリセット（0から）<br>
      <strong>記録を選ぶ:</strong> 会話記録を保持したまま、<u>容姿は別の色に変化</u>して、さらに10回会話
    </p>

    <div>
      <button class="btn btn-appearance" id="chooseAppearance">容姿を選ぶ</button>
      <button class="btn btn-keep" id="chooseKeep">記録を選ぶ</button>
    </div>
    <div class="note" id="guardMsg" style="display:none">選択は確定しました。戻る操作はできません。</div>
  </div>

  <script>
    // ===== 戻る無効 =====
    history.pushState(null, "", location.href);
    window.onpopstate = () => { history.go(1); };

    // ===== ガード =====
    const CHAT_KEY = 'whoai_chat';
    const LOCK_KEY = 'whoai_rebirth_lock';
    const allowed = ['pink','blue','green','purple'];

    function normColor(c){
      const t = String(c||'').toLowerCase().trim();
      return allowed.includes(t) ? t : 'green';
    }
    const currentColor = normColor(localStorage.getItem('macaronColor') || 'green');

    (function entryGuard(){
      if (localStorage.getItem(LOCK_KEY) === '1') {
        // すでに選択済み → 誤って戻ってきても進化後トークへ
        location.replace('whoai_talk_evolved.html');
        return;
      }
      const stage = localStorage.getItem('whoai_stage');
      const phase = localStorage.getItem('whoai_phase');
      if (!(stage==='evolved' && phase==='pre')) {
        location.replace('whoai_talk_evolved.html');
      }
    })();

    function pickDifferentColor(now){
      const pool = allowed.filter(c=>c!==now);
      return pool[Math.floor(Math.random()*pool.length)];
    }

    let decided = false;
    function lockAndGo(){
      decided = true;
      document.getElementById('guardMsg').style.display='block';
      localStorage.setItem(LOCK_KEY, '1');
      localStorage.setItem('whoai_phase','post');
      localStorage.setItem('whoai_turn','0');
      localStorage.setItem('whoai_stage','evolved');
      // 進化後会話へ
      location.replace('whoai_talk_evolved.html');
    }

    // 容姿を選ぶ → 会話リセット
    document.getElementById('chooseAppearance').addEventListener('click', ()=>{
      if (decided) return;
      localStorage.setItem('whoai_keep','appearance');
      localStorage.removeItem(CHAT_KEY);
      lockAndGo();
    }, { once:true });

    // 記録を選ぶ → 会話保持・色変更
    document.getElementById('chooseKeep').addEventListener('click', ()=>{
      if (decided) return;
      localStorage.setItem('whoai_keep','memory');
      const newColor = pickDifferentColor(currentColor);
      localStorage.setItem('macaronColor', newColor);
      lockAndGo();
    }, { once:true });
  </script>
</body>
</html>
