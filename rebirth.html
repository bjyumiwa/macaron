<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>復活の儀式</title>
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;
      background:#000; color:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      background:rgba(0,0,0,.65);
      border-radius:18px; padding:26px 22px; text-align:center;
      width:min(720px,94vw); box-shadow:0 8px 40px rgba(0,0,0,.5);
    }
    .card img{
      width:200px; max-width:70%; margin:18px auto; display:block;
      filter:drop-shadow(0 0 12px rgba(255,255,255,.3));
      animation: float 4s ease-in-out infinite, glow 3s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-10px) rotate(1deg);} }
    @keyframes glow  { 0%,100%{filter:drop-shadow(0 0 12px rgba(255,255,255,.3));}
                       50%{filter:drop-shadow(0 0 28px rgba(255,255,200,.8));} }
    .btn{
      display:inline-block; margin:10px 8px 0; padding:12px 16px;
      border-radius:12px; text-decoration:none; font-weight:800; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease; border:0;
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.3); }
    .btn-appearance{background:#f5a9d6; color:#000;}
    .btn-keep{background:#444; color:#fff;}
    .file-label{position:fixed; left:10px; bottom:10px; font-size:12px; opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h2>復活の儀式</h2>
    <p>次のどちらかを選んでください。</p>

    <!-- アイテム画像 -->
    <img src="public/assets/stage1/drink_item.png" alt="復活アイテム">

    <p>
      <strong>容姿を選ぶ:</strong> 外見はそのまま、会話はリセット（0から）<br>
      <strong>記録を選ぶ:</strong> 会話記録を保持したまま、<u>容姿は別の色に変化</u>して、さらに10回会話
    </p>
    <div>
      <button class="btn btn-appearance" id="chooseAppearance">容姿を選ぶ</button>
      <button class="btn btn-keep" id="chooseKeep">記録を選ぶ</button>
    </div>
  </div>
  <div class="file-label">/macaron/rebirth.html</div>

  <script>
    // 共通
    const CHAT_KEY='whoai_chat';
    const allowed = ['pink','blue','green','purple'];

    // 現在色を取得＆正規化
    function normColor(c){
      const t = String(c||'').toLowerCase().trim();
      return allowed.includes(t) ? t : 'green';
    }
    const current = normColor(localStorage.getItem('macaronColor'));

    // 現在と違う色をランダムに1つ選ぶ
    function pickDifferentColor(now){
      const pool = allowed.filter(c=>c!==now);
      return pool[Math.floor(Math.random()*pool.length)];
    }

    // 容姿を選ぶ：外見=そのまま / 会話リセット
    document.getElementById('chooseAppearance').onclick=()=>{
      localStorage.setItem('whoai_keep','appearance'); // 表示案内用
      localStorage.setItem('whoai_phase','post');
      localStorage.setItem('whoai_turn','0');
      localStorage.setItem('whoai_stage','evolved');   // 進化状態を維持
      localStorage.removeItem(CHAT_KEY);               // ここで履歴リセット
      // 色は変えない（currentのまま）
      location.href='whoai_talk.html';
    };

    // 記録を選ぶ：会話記録=保持 / 容姿=別色に変更
    document.getElementById('chooseKeep').onclick=()=>{
      localStorage.setItem('whoai_keep','memory'); // 表示案内用
      localStorage.setItem('whoai_phase','post');
      localStorage.setItem('whoai_turn','0');
      localStorage.setItem('whoai_stage','evolved'); // 進化状態を維持
      // 履歴は消さない（保持）
      // 色だけ“今とは違う色”に更新
      const newColor = pickDifferentColor(current);
      localStorage.setItem('macaronColor', newColor);
      // デバッグ用に前色を記録しておくと確認しやすい（任意）
      localStorage.setItem('whoai_prevColor', current);
      location.href='whoai_talk.html';
    };
  </script>
</body>
</html>
