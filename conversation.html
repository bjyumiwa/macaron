<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>conversation.html - ä¼šè©±ï¼ˆé€²åŒ–ç‰ˆUIï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      background-image:url("public/assets/stage1/space_background.png");
      background-size:cover;background-position:center;background-attachment:fixed;
    }
    .name-badge{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700
    }
    #badgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}
  </style>
</head>
<body>

  <!-- â˜… æ—¢å­˜ã®ä¼šè©±UIï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ã“ã®ä¸‹ã«ãã®ã¾ã¾æ®‹ã—ã¦ãã ã•ã„ â˜… -->
  <!-- ãƒ»ãƒ»ãƒ»ãƒ»ï¼ˆå…ƒã®HTML/JS/Fetchãªã©å…¨ã¦ï¼‰ãƒ»ãƒ»ãƒ»ãƒ» -->

  <!-- è¿½åŠ ï¼šåå‰ãƒãƒƒã‚¸ -->
  <div id="nameBadge" class="name-badge" style="display:none;">
    <img id="badgeFace" alt="">
    <span id="badgeText"></span>
  </div>

 <!-- ===== WHOAI é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆä¸¸ã”ã¨ã‚³ãƒ”ãƒšï¼æœ«å°¾ã«è²¼ã‚‹ï¼‰===== -->
<style>
  .whoai-name-badge{
    position:fixed;top:10px;right:10px;z-index:9999;
    background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
    padding:8px 12px;border-radius:12px;font-weight:700;color:#fff
  }
  #whoaiBadgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}
  #whoaiNameEdit{margin-left:8px;opacity:.85;cursor:pointer}
</style>

<div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
  <img id="whoaiBadgeFace" alt="">
  <span id="whoaiBadgeText"></span>
  <span id="whoaiNameEdit" title="åå‰ã‚’å¤‰æ›´">ğŸ–Š</span>
</div>

<script>
(function(){
  // ---- å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
  function lsGet(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
  function lsSet(k,v){localStorage.setItem(k, typeof v==="string"?v:JSON.stringify(v))}
  function setImageWithFallback(imgEl, paths){
    let i=0; const trySet=()=>{
      if(i>=paths.length) return; // æœ€å¾Œã¾ã§å¤±æ•—ã—ãŸã‚‰ä½•ã‚‚ã—ãªã„
      imgEl.onerror=()=>{i++; trySet();};
      imgEl.src=paths[i];
    }; trySet();
  }

  // ---- åå‰ï¼†é¡”ãƒãƒƒã‚¸è¡¨ç¤ºï¼ˆAPIéå¹²æ¸‰ï¼‰----
  const picked = lsGet('whoai_selectedMacaron','green');           // pink/blue/green/purple
  const appear = lsGet('whoai_appearance','tane');                 // 'tane' or 'evolved'
  let name = lsGet('characterName','ãªã¾ãˆæœªè¨­å®š');

  const badge = document.getElementById('whoaiNameBadge');
  const face  = document.getElementById('whoaiBadgeFace');
  const text  = document.getElementById('whoaiBadgeText');
  const edit  = document.getElementById('whoaiNameEdit');

  function faceCandidates(open){
    // taneã¯1æšç”»åƒï¼ˆã‚†ã‚‰ã‚†ã‚‰è¡¨ç¤ºï¼‰ã€‚é€²åŒ–å¾Œã¯ open/closed åˆ‡æ›¿
    if(appear==='tane'){
      return ['public/assets/stage1/tane_green.png']; // ç½®ãå ´æ‰€åˆã‚ã›æ¸ˆã¿
    }
    const s = open ? 'open':'closed';
    return [
      `./${picked}_${s}.png`,                                    // ä¾‹: green_open.png / green_closed.png
      `public/assets/evolved/${picked}_${open?'open':'close'}.png`// ä¾‹: public/assets/evolved/green_open.png
    ];
  }

  function drawBadge(){
    text.textContent = `ğŸª„ ${name}`;
    badge.style.display = 'inline-block';
  }
  drawBadge();

  let isOpen=true;
  setImageWithFallback(face, faceCandidates(isOpen));
  setInterval(()=>{
    isOpen=!isOpen;
    setImageWithFallback(face, faceCandidates(isOpen));
  }, (appear==='tane'? 1600 : 1200));

  edit.addEventListener('click', ()=>{
    const v = prompt('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰', name);
    if(v!=null && v.trim()){
      name = v.trim(); lsSet('characterName',name); drawBadge();
    }
  });

  // ---- é€²è¡Œç®¡ç†ï¼ˆã—ãã„å€¤ï¼‰â€» APIã®fetchç­‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ã¾ã›ã‚“ ----
  const S1_TARGET = 5;   // taneï¼ˆstage1ï¼‰ã§5ä¼šè©± â†’ macaron_select.htmlï¼ˆ2å›ç›®ï¼‰
  const S2_TARGET = 10;  // é€²åŒ–ï¼ˆstage2ï¼‰ã§10ä¼šè©± â†’ rebirth.html
  const POST_TARGET = 10;// é¸æŠå¾Œï¼ˆpostï¼‰ã§10ä¼šè©± â†’ identity_check.htmlï¼ˆã‚¢ãƒ³ã‚±ï¼‰

  function countAndRoute(){
    const stage = lsGet('whoai_stage','stage1');
    if(stage==='stage1'){
      const n = (lsGet('whoai_turn_s1',0)|0)+1; lsSet('whoai_turn_s1',n);
      if(n>=S1_TARGET){ setTimeout(()=>location.href='macaron_select.html',700); }
    }else if(stage==='stage2'){
      const n = (lsGet('whoai_turn_s2',0)|0)+1; lsSet('whoai_turn_s2',n);
      if(n>=S2_TARGET){ setTimeout(()=>location.href='rebirth.html',700); }
    }else if(stage==='post'){
      const n = (lsGet('whoai_post_turn',0)|0)+1; lsSet('whoai_post_turn',n);
      if(n>=POST_TARGET){
        const url = lsGet('whoai_survey_url') || 'identity_check.html';
        setTimeout(()=>location.href=url,600);
      }
    }
  }

  // â€œé€ä¿¡â€æ“ä½œã‚’åºƒã‚ã«ãƒ•ãƒƒã‚¯ï¼ˆæ—¢å­˜APIã‚³ãƒ¼ãƒ‰ã¯éå¹²æ¸‰ï¼‰
  function hookSend(){
    const btn = document.querySelector('#sendBtn, #sendButton, button[data-send], button#send, .send');
    if(btn && !btn.dataset._whoaiHooked){
      btn.dataset._whoaiHooked="1";
      btn.addEventListener('click', ()=> setTimeout(countAndRoute, 120)); // å¿œç­”æç”»ã®å°‘ã—å¾Œ
    }
    const input = document.querySelector('#userInput, textarea, input[type="text"]');
    if(input && !input.dataset._whoaiHooked){
      input.dataset._whoaiHooked="1";
      input.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){ setTimeout(countAndRoute,150); }
      });
    }
  }
  hookSend();
  setInterval(hookSend, 1000); // SPAçš„UIã‚„å‹•çš„ç”Ÿæˆã«ã‚‚å¯¾å¿œ
})();
</script>
<!-- ===== /WHOAI é€²è¡Œã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆã“ã“ã¾ã§ï¼‰ ===== -->


</body>
</html>


