<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>conversation.html - 会話（進行管理付き）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",sans-serif;color:#fff;background:#000;
      /* ← 直し：背景は直下 */
     background-image:url("./public/assets/stage1/space_background.png");

      background-size:cover;background-position:center;background-attachment:fixed;
    }
    /* 右上の名前＆顔バッジ */
    .whoai-name-badge{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
      padding:8px 12px;border-radius:12px;font-weight:700;color:#fff
    }
    #whoaiBadgeFace{width:36px;height:36px;vertical-align:middle;margin-right:8px;border-radius:8px}
    #whoaiNameEdit{margin-left:8px;opacity:.85;cursor:pointer}
    .placeholder-chat{max-width:680px;margin:92px auto 24px;padding:16px;border-radius:14px;background:rgba(0,0,0,.35)}
    .placeholder-chat .row{display:flex;gap:8px}
    .placeholder-chat input{flex:1;padding:10px;border-radius:10px;border:none}
    .placeholder-chat button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>

  <!-- ▼ 既存の会話UI（fetch/TALK_ENDPOINT含む）をここに置いたままでOK -->

  <div class="placeholder-chat" id="whoaiPlaceholder">
    <div style="margin-bottom:10px;opacity:.9">（プレースホルダ）ここに既存の会話UIが表示されます。無ければ自由に使ってOK。</div>
    <div class="row">
      <input id="userInput" type="text" placeholder="メッセージを入力" />
      <button id="sendBtn">送信</button>
    </div>
  </div>

  <!-- 右上のバッジ -->
  <div id="whoaiNameBadge" class="whoai-name-badge" style="display:none;">
    <img id="whoaiBadgeFace" alt="">
    <span id="whoaiBadgeText"></span>
    <span id="whoaiNameEdit" title="名前を変更">🖊</span>
  </div>

  <!-- ===== WHOAI 進行ウィジェット（API非干渉）===== -->
  <script>
  (function(){
    // --- 小ユーティリティ ---
    function lsGet(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return localStorage.getItem(k)??d}}
    function lsSet(k,v){localStorage.setItem(k, typeof v==="string"?v:JSON.stringify(v))}
    function setImageWithFallback(imgEl, paths){
      let i=0; const trySet=()=>{ if(i>=paths.length) return; imgEl.onerror=()=>{i++; trySet();}; imgEl.src=paths[i]; };
      trySet();
    }

    // --- 名前＆顔バッジ（taneは固定 / 進化はopen/closed）---
    // ← 直し：両方のキー名を見て色を取得
    const pickedRaw = lsGet('whoai_selectedMacaron') || lsGet('selectedMacaron') || 'green';
    const picked = ['pink','blue','green','purple'].includes(pickedRaw) ? pickedRaw : 'green';
    const appear = lsGet('whoai_appearance','tane');
    let name = lsGet('characterName','なまえ未設定');

    const badge = document.getElementById('whoaiNameBadge');
    const face  = document.getElementById('whoaiBadgeFace');
    const text  = document.getElementById('whoaiBadgeText');
    const edit  = document.getElementById('whoaiNameEdit');

    function faceCandidates(open){
      if(appear==='tane'){
        // ← 直し：tane は直下のファイルを使う（色別があればそれを、なければ緑）
        return [`./tane_${picked}.png`, `./tane_green.png`];
      }
      const s = open ? 'open':'closed';
      return [
        `./${picked}_${s}.png`,                                      // 例: green_open.png
        `public/assets/evolved/${picked}_${open?'open':'close'}.png` // フォールバック
      ];
    }

    function drawBadge(){ text.textContent = `🪄 ${name}`; badge.style.display = 'inline-block'; }
    drawBadge();

    let isOpen=true;
    setImageWithFallback(face, faceCandidates(isOpen));
    setInterval(()=>{ isOpen=!isOpen; setImageWithFallback(face, faceCandidates(isOpen)); },
      (appear==='tane'? 1600 : 1200));

    edit.addEventListener('click', ()=>{
      const v = prompt('キャラクターの名前', name);
      if(v!=null && v.trim()){ name = v.trim(); lsSet('characterName',name); drawBadge(); }
    });

    // --- 進行管理（APIのfetch等には一切干渉しない）---
    const S1_TARGET = 5;    // taneで5会話 → macaron_select.html
    const S2_TARGET = 10;   // 進化で10会話 → rebirth.html
    const POST_TARGET = 10; // 選択後10会話 → identity_check.html

    function countAndRoute(){
      const stage = lsGet('whoai_stage','stage1');
      if(stage==='stage1'){
        const n = (lsGet('whoai_turn_s1',0)|0) + 1; lsSet('whoai_turn_s1',n);
        if(n>=S1_TARGET){ setTimeout(()=>location.href='macaron_select.html',700); }
      }else if(stage==='stage2'){
        const n = (lsGet('whoai_turn_s2',0)|0) + 1; lsSet('whoai_turn_s2',n);
        if(n>=S2_TARGET){ setTimeout(()=>location.href='rebirth.html',700); }
      }else if(stage==='post'){
        const n = (lsGet('whoai_post_turn',0)|0) + 1; lsSet('whoai_post_turn',n);
        if(n>=POST_TARGET){
          const url = lsGet('whoai_survey_url') || 'identity_check.html';
          setTimeout(()=>location.href=url,600);
        }
      }
    }

    // 送信操作をフック（既存UIにも広めに対応）
    function hookSend(){
      const btn = document.querySelector('#sendBtn, #sendButton, button[data-send], button#send, .send');
      if(btn && !btn.dataset._whoaiHooked){ btn.dataset._whoaiHooked="1";
        btn.addEventListener('click', ()=> setTimeout(countAndRoute,120)); }
      const input = document.querySelector('#userInput, textarea, input[type="text"]');
      if(input && !input.dataset._whoaiHooked){ input.dataset._whoaiHooked="1";
        input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ setTimeout(countAndRoute,150); } });}
    }
    hookSend();
    setInterval(hookSend, 1000);
  })();
  </script>
  <!-- ===== /WHOAI 進行ウィジェット ===== -->

</body>
</html>




