<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マカロンを選ぶ</title>
<style>
  body{font-family:"Noto Sans JP",sans-serif;margin:0;min-height:100vh;color:#fff;
       display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
  .mac{cursor:pointer;padding:10px 14px;background:rgba(0,0,0,.35);border-radius:12px;margin:6px}
  #dbg{position:fixed;bottom:8px;left:8px;font-size:12px;opacity:.7}
</style>
</head>
<body>
<h1>マカロンを選ぶ</h1>
<p>1回目: <b>tane</b>で3回会話 → 再びここへ。2回目: <b>openclause</b>に進化 → 10回で儀式。</p>
<div>
  <button class="mac" data-color="pink">ピンク（情熱）</button>
  <button class="mac" data-color="blue">ブルー（静寂）</button>
  <button class="mac" data-color="green">グリーン（元気）</button>
  <button class="mac" data-color="purple">パープル（創造）</button>
</div>
<button id="evo" style="display:none;margin-top:16px;padding:10px 16px;border:none;border-radius:12px;font-weight:700">
  進化して openclause へ
</button>
<pre id="dbg"></pre>
<script>
const KEY='whoai_progress';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch(_){return{}} }
function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
function init(){
  const s=load();
  if(!s.stage) s.stage='tane';
  if(typeof s.talkCount!=='number') s.talkCount=0;
  if(!s.phase) s.phase='preRebirth';
  return s;
}
let s=init();

const evo=document.getElementById('evo');
if(s._cameBackAfter3){ // 2周目
  evo.style.display='inline-block';
  evo.onclick=()=>{
    s.stage='openclause'; s.talkCount=0; delete s._cameBackAfter3; save(s);
    location.href='whoai_talk.html';
  };
}

document.querySelectorAll('.mac').forEach(b=>{
  b.onclick=()=>{
    const c=b.dataset.color;
    // 色・ステージ・カウントを確実に保存
    s.color=c;
    if(!s._cameBackAfter3){ s.stage='tane'; s.talkCount=0; }
    save(s);
    location.href='whoai_talk.html';
  };
});

// デバッグ表示（今の保存状態が見える）
document.getElementById('dbg').textContent='localStorage: '+JSON.stringify(load());
</script>
</body>
</html>
