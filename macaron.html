<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>マカロンを選ぶ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family:"Noto Sans JP",sans-serif; margin:0; min-height:100vh; color:#fff;
         display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; }
  h1 { margin:0 0 8px }
  .macaron { cursor:pointer; padding:10px 14px; background:rgba(0,0,0,.35); border-radius:12px; margin:5px }
  #evolveBtn { margin-top:18px; padding:10px 16px; border:none; border-radius:12px; font-weight:700; cursor:pointer }
</style>
</head>
<body>

<h1>マカロンを選ぶ</h1>
<p>1回目は <b>tane</b> で3回 → もう一度ここへ。2回目は <b>openclause</b> に進化 → 10回で儀式。</p>

<div>
  <button class="macaron" data-color="pink">ピンク（情熱）</button>
  <button class="macaron" data-color="blue">ブルー（静寂）</button>
  <button class="macaron" data-color="green">グリーン（元気）</button>
  <button class="macaron" data-color="purple">パープル（創造）</button>
</div>

<button id="evolveBtn" style="display:none;background:#fff;color:#111;">進化して openclause へ</button>

<script>
/* 背景の自動検出（whoai_talk と同じ） */
let BASE=null;
(async()=>{
  const C=['./public/assets/stage1/','./assets/stage1/','/public/assets/stage1/','/assets/stage1/'];
  async function head(u){try{const r=await fetch(u,{method:'HEAD',cache:'no-store'});return r.ok;}catch(_){return false;}}
  for(const b of C){ if(await head(b+'space_background.png')){ BASE=b; break; } }
  BASE ||= C[0];
  Object.assign(document.body.style,{ backgroundImage:`url("${BASE}space_background.png")`,
    backgroundPosition:'center', backgroundSize:'cover', backgroundAttachment:'fixed' });
})();

/* 進行 */
const KEY='whoai_progress';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch(e){return{}} }
function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
function ensureInit(){ const s=load(); if(!s.stage) s.stage='tane'; if(typeof s.talkCount!=='number') s.talkCount=0; if(!s.phase) s.phase='preRebirth'; return s; }
let s = ensureInit();

/* 2回目なら進化ボタン表示 */
const evo = document.getElementById('evolveBtn');
if(s._cameBackAfter3){
  evo.style.display='inline-block';
  evo.onclick = ()=>{
    s.stage='openclause'; s.talkCount=0; delete s._cameBackAfter3; save(s);
    location.href='whoai_talk.html';
  };
}

/* 色選択 */
document.querySelectorAll('.macaron').forEach(b=>{
  b.onclick=()=>{
    s.color=b.getAttribute('data-color');
    if(!s._cameBackAfter3){ s.stage='tane'; s.talkCount=0; }
    save(s); location.href='whoai_talk.html';
  };
});
</script>
</body>
</html>
