<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>マカロンを選ぶ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: "Noto Sans JP", sans-serif;
    background: url("./assets/stage1/space_background.png") center/cover fixed;
    margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; color: white;
  }
  h1 { margin-bottom: 8px; }
  .macaron { cursor: pointer; padding: 10px; background: rgba(0,0,0,0.3); margin: 5px; border-radius: 12px; }
  #evolveBtn { margin-top: 20px; padding: 8px 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>

<h1>マカロンを選ぶ</h1>
<div>
  <div class="macaron" data-color="pink">ピンク（情熱）</div>
  <div class="macaron" data-color="blue">ブルー（静寂）</div>
  <div class="macaron" data-color="green">グリーン（元気）</div>
  <div class="macaron" data-color="purple">パープル（創造）</div>
</div>

<button id="evolveBtn" style="display:none;">進化して openclause へ</button>

<script>
window.WhoAI = window.WhoAI || (function(){
  const KEY='whoai_progress';
  function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch(e){return{}} }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
  function ensureInit(){
    const s = load();
    if(!s.stage) s.stage='tane';
    if(!('talkCount' in s)) s.talkCount=0;
    if(!s.phase) s.phase='preRebirth';
    return s;
  }
  return {KEY,load,save,ensureInit};
})();

const s = WhoAI.ensureInit();

// 2回目のマカロン表示なら進化ボタンを出す
if (s._cameBackAfter3) {
  document.getElementById('evolveBtn').style.display='inline-block';
  document.getElementById('evolveBtn').onclick = ()=>{
    s.stage='openclause';
    s.talkCount=0;
    delete s._cameBackAfter3;
    WhoAI.save(s);
    location.href='whoai_talk.html';
  };
}

document.querySelectorAll('.macaron').forEach(btn=>{
  btn.onclick = ()=>{
    s.color = btn.getAttribute('data-color');
    if(!s._cameBackAfter3) { // 1周目
      s.stage='tane';
      s.talkCount=0;
    }
    WhoAI.save(s);
    location.href='whoai_talk.html';
  };
});
</script>
</body>
</html>
